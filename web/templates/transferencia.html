<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer√™ncia Internacional | Cambio Bank</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/formularios.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS ESPEC√çFICO PARA ESTA P√ÅGINA -->
    <style>
        /* CABE√áALHO COM BREADCRUMB (do history) */
        .page-nav {
            background: var(--cor-card);
            border-bottom: 1px solid var(--cor-borda);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            margin-bottom: 0;
        }

        .page-nav a {
            color: var(--cor-texto-secundario);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .page-nav a:hover {
            color: var(--cor-primaria);
        }

        .page-nav i {
            font-size: 12px;
        }

        .page-nav .fa-chevron-right {
            color: var(--cor-texto-secundario);
            opacity: 0.5;
        }

        .current-page {
            color: var(--cor-texto);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* T√çTULO CENTRALIZADO (do history) */
        .page-header {
            text-align: center;
            padding: 30px 20px 20px;
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--cor-texto);
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .page-header h2 i {
            color: var(--cor-primaria);
        }

        .page-subtitle {
            color: var(--cor-texto-secundario);
            font-size: 16px;
            margin: 0;
        }

        /* MANTER O DESIGN DE CARDS DA VERS√ÉO ATUAL */
        .form-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-card {
            background: var(--cor-card);
            border-radius: var(--borda-radius-grande);
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid var(--cor-borda);
            /* Borda elegante da vers√£o atual */
            position: relative;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--cor-primaria), #2d8fff);
            border-radius: var(--borda-radius-grande) var(--borda-radius-grande) 0 0;
        }

        .form-title {
            font-size: 22px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--cor-borda);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-title i {
            color: var(--cor-primaria);
        }

        .form-subtitle {
            font-size: 18px;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--cor-borda);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-subtitle i {
            color: var(--cor-secundaria);
        }

        /* INPUTS E SELECTS COM BORDAS ELEGANTES */
        .form-group input,
        .form-group select,
        .form-group textarea {
            border: 1px solid var(--cor-borda);
            border-radius: var(--borda-radius-pequeno);
            padding: 12px 15px;
            background: var(--cor-card);
            color: var(--cor-texto);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--cor-primaria);
            box-shadow: 0 0 0 3px rgba(26, 95, 180, 0.1);
        }

        /* √ÅREA DE UPLOAD MELHORADA */
        .file-upload-area {
            background: var(--cor-card);
            border: 2px dashed var(--cor-borda);
            border-radius: var(--borda-radius-medio);
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: var(--cor-primaria);
            background: rgba(26, 95, 180, 0.03);
        }

        .file-upload-area i {
            font-size: 48px;
            color: var(--cor-primaria);
            margin-bottom: 15px;
            opacity: 0.8;
        }

        /* PREVIEW DE ARQUIVO */
        .file-preview {
            background: rgba(26, 95, 180, 0.05);
            border: 1px solid rgba(26, 95, 180, 0.2);
            border-radius: var(--borda-radius-pequeno);
            padding: 12px 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-preview i {
            color: var(--cor-primaria);
            margin-right: 10px;
        }

        /* BOT√ïES ELEGANTES */
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--cor-borda);
        }

        .btn-primary, .btn-secondary {
            padding: 12px 24px;
            border-radius: var(--borda-radius-pequeno);
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 15px;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cor-primaria), #2d8fff);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 95, 180, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--cor-texto);
            border: 1px solid var(--cor-borda);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--cor-texto-secundario);
        }

        /* LABEL DA MOEDA ELEGANTE */
        .currency-label {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(26, 95, 180, 0.1);
            color: var(--cor-primaria);
            padding: 4px 12px;
            border-radius: var(--borda-radius-pequeno);
            font-weight: 600;
            font-size: 14px;
            border: 1px solid rgba(26, 95, 180, 0.2);
        }

        /* CORRE√á√ÉO DO FUNDO BRANCO NOS SPINNERS */
        .fa-spinner, .fa-spin {
            background-color: transparent !important;
        }

        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0px 1000px var(--cor-card) inset !important;
            -webkit-text-fill-color: var(--cor-texto) !important;
            background-color: var(--cor-card) !important;
        }

        select, option {
            background-color: var(--cor-card) !important;
            color: var(--cor-texto) !important;
        }

        select option:checked {
            background: var(--cor-primaria) !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- HEADER PRINCIPAL -->
    <header class="main-header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-university"></i>
                <h1>CAMBI<span class="logo-highlight">O</span> BANK</h1>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span id="username">{{ nome if nome else 'Usu√°rio' }}</span>
                <i class="fas fa-user-circle"></i>
            </div>
            <a href="/dashboard" class="btn-back">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>
    </header>

    <!-- BREADCRUMB DE NAVEGA√á√ÉO (do history) -->
    <nav class="page-nav">
        <a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a>
        <i class="fas fa-chevron-right"></i>
        <span class="current-page"><i class="fas fa-exchange-alt"></i> Transfer√™ncia Internacional</span>
    </nav>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main-content">
        <!-- T√çTULO DA P√ÅGINA (do history) -->
        <div class="page-header">
            <h2><i class="fas fa-globe-americas"></i> TRANSFER√äNCIA INTERNACIONAL</h2>
            <p class="page-subtitle">Envie dinheiro para qualquer parte do mundo com seguran√ßa e as melhores taxas</p>
        </div>

        <!-- FORMUL√ÅRIO COM DESIGN DE CARD (vers√£o atual) -->
        <div class="form-container">
            <div class="form-card">
                <h3 class="form-title">
                    <i class="fas fa-file-invoice-dollar"></i> Dados da Transfer√™ncia
                </h3>
                
                <!-- ALERTAS -->
                <div id="alert" class="alert hidden"></div>

                <form id="transferenciaForm">
                    <!-- SE√á√ÉO CONTA E VALOR -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conta_origem">
                                <i class="fas fa-wallet"></i> Conta de Origem *
                            </label>
                            <select id="conta_origem" name="conta_origem" required>
                                <option value="">Selecione sua conta...</option>
                                <!-- Carregado via JS -->
                            </select>
                            <div id="saldo_info" class="saldo-info hidden">
                                <i class="fas fa-info-circle"></i> Saldo dispon√≠vel: <span id="saldo_valor">--</span>
                            </div>
                        </div>
                        
                        <div class="form-group" style="position: relative;">
                            <label for="valor">
                                <i class="fas fa-money-bill-wave"></i> Valor a Transferir *
                            </label>
                            <input type="number" id="valor" name="valor" step="0.01" min="0.01" 
                                   placeholder="0.00" required>
                            <span id="moeda_label" class="currency-label">USD</span>
                            <small class="helper-text">Valor m√≠nimo: 0.01</small>
                        </div>
                    </div>

                    <!-- SE√á√ÉO FINALIDADE E DESCRI√á√ÉO -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="finalidade">
                                <i class="fas fa-bullseye"></i> Finalidade *
                            </label>
                            <select id="finalidade" name="finalidade" required>
                                <option value="Pagamento de Servi√ßos">Pagamento de Servi√ßos</option>
                                <option value="Pagamento de Produtos">Pagamento de Produtos</option>
                                <option value="Remessa Familiar">Remessa Familiar</option>
                                <option value="Investimento">Investimento</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="descricao">
                                <i class="fas fa-comment-alt"></i> Descri√ß√£o
                            </label>
                            <input type="text" id="descricao" name="descricao" 
                                   placeholder="Breve descri√ß√£o da transfer√™ncia...">
                        </div>
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO BENEFICI√ÅRIO -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-user-tie"></i> Dados do Benefici√°rio
                    </h3>

                    <!-- BENEFICI√ÅRIOS SALVOS -->
                    <div class="form-group">
                        <label for="beneficiarios_salvos">
                            <i class="fas fa-address-book"></i> Benefici√°rios Salvos
                        </label>
                        <select id="beneficiarios_salvos" class="beneficiarios-select">
                            <option value="">Selecione um benefici√°rio salvo...</option>
                            <!-- Carregado via JS -->
                        </select>
                        <small class="helper-text">Selecione para preencher automaticamente os campos abaixo</small>
                    </div>

                    <!-- CAMPOS DO BENEFICI√ÅRIO -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="beneficiario">
                                <i class="fas fa-user"></i> Nome Completo *
                            </label>
                            <input type="text" id="beneficiario" name="beneficiario" 
                                   placeholder="Nome completo do benefici√°rio" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="endereco">
                                <i class="fas fa-map-marker-alt"></i> Endere√ßo *
                            </label>
                            <input type="text" id="endereco" name="endereco" 
                                   placeholder="Endere√ßo completo" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade">
                                <i class="fas fa-city"></i> Cidade *
                            </label>
                            <input type="text" id="cidade" name="cidade" 
                                   placeholder="Cidade" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pais">
                                <i class="fas fa-flag"></i> Pa√≠s *
                            </label>
                            <input type="text" id="pais" name="pais" 
                                   placeholder="Pa√≠s" required>
                        </div>
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO BANCO DESTINAT√ÅRIO -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-university"></i> Banco Destinat√°rio
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="banco">
                                <i class="fas fa-landmark"></i> Nome do Banco *
                            </label>
                            <input type="text" id="banco" name="banco" 
                                   placeholder="Nome do banco destinat√°rio" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="endereco_banco">
                                <i class="fas fa-map-pin"></i> Endere√ßo do Banco
                            </label>
                            <input type="text" id="endereco_banco" name="endereco_banco" 
                                   placeholder="Endere√ßo do banco">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade_banco">
                                <i class="fas fa-city"></i> Cidade do Banco *
                            </label>
                            <input type="text" id="cidade_banco" name="cidade_banco" 
                                   placeholder="Cidade do banco" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pais_banco">
                                <i class="fas fa-flag"></i> Pa√≠s do Banco *
                            </label>
                            <input type="text" id="pais_banco" name="pais_banco" 
                                   placeholder="Pa√≠s do banco" required>
                        </div>
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO DADOS BANC√ÅRIOS -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-key"></i> Dados Banc√°rios
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="swift">
                                <i class="fas fa-barcode"></i> C√≥digo SWIFT/BIC *
                            </label>
                            <input type="text" id="swift" name="swift" 
                                   placeholder="Ex: CHASUS33XXX" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="iban">
                                <i class="fas fa-hashtag"></i> C√≥digo IBAN / Account # *
                            </label>
                            <input type="text" id="iban" name="iban" 
                                   placeholder="N√∫mero da conta" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="aba">
                            <i class="fas fa-route"></i> C√≥digo ABA / Routing #
                        </label>
                        <input type="text" id="aba" name="aba" 
                               placeholder="Apenas para transfer√™ncias EUA">
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO INVOICE -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-file-invoice"></i> Documento Comprobat√≥rio (Invoice)
                    </h3>

                    <div class="form-group">
                        <div class="file-upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Arraste e solte o arquivo aqui ou</p>
                            <button type="button" class="btn-select-file" id="selectFileBtn">
                                <i class="fas fa-folder-open"></i> Selecionar Arquivo
                            </button>
                            <input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                            <p class="file-info">
                                <small>Formatos aceitos: PDF, JPG, PNG (m√°ximo 5MB)</small>
                            </p>
                        </div>
                        <div id="filePreview" class="file-preview hidden">
                            <div>
                                <i class="fas fa-file-pdf" id="fileIcon"></i>
                                <span id="fileName">arquivo.pdf</span>
                                <span id="fileSize" class="file-size"></span>
                            </div>
                            <button type="button" class="btn-remove-file" id="removeFileBtn">
                                <i class="fas fa-times"></i> Remover
                            </button>
                        </div>
                    </div>

                    <!-- CHECKBOX SALVAR BENEFICI√ÅRIO -->
                    <div class="form-checkbox">
                        <input type="checkbox" id="salvar_beneficiario" name="salvar_beneficiario">
                        <label for="salvar_beneficiario">
                            <i class="fas fa-save"></i> Salvar este benefici√°rio para futuras transfer√™ncias
                        </label>
                    </div>

                    <!-- BOT√ïES -->
                    <div class="form-buttons">
                        <button type="button" class="btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Solicitar Transfer√™ncia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="main-footer">
        <p>¬© 2024 Cambio Bank - Sistema de C√¢mbio Internacional. Todos os direitos reservados.</p>
        <p class="footer-links">
            <a href="#"><i class="fas fa-shield-alt"></i> Seguran√ßa</a> |
            <a href="#"><i class="fas fa-question-circle"></i> Ajuda</a> |
            <a href="#"><i class="fas fa-envelope"></i> Contato</a>
        </p>
    </footer>

    <!-- MODAL DE SUCESSO -->
    <div id="successModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>Transfer√™ncia Solicitada com Sucesso!</h3>
            <p id="modalMessage">Sua transfer√™ncia foi registrada e est√° aguardando aprova√ß√£o.</p>
            <div class="modal-details">
                <p><strong>ID da Transfer√™ncia:</strong> <span id="modalTransferId">--</span></p>
                <p><strong>Valor:</strong> <span id="modalValor">--</span></p>
                <p><strong>Status:</strong> <span class="status-pending">Aguardando Aprova√ß√£o</span></p>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" id="closeModalBtn">Fechar</button>
                <button class="btn-primary" id="goToDashboardBtn">
                    <i class="fas fa-tachometer-alt"></i> Voltar ao Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- VARI√ÅVEIS DO FLASK -->
    <script>
        // Dados do usu√°rio logado
        window.USER = { 
            username: "{{ usuario if usuario else 'pantanal' }}", 
            nome: "{{ nome if nome else 'PANTANAL COMERCIO IMP LTDA' }}", 
            email: "{{ email if email else '' }}"
        };
        
        console.log('‚úÖ Usu√°rio carregado:', window.USER);
    </script>

    <!-- SCRIPTS DO SISTEMA FUNCIONAL (que j√° sabemos que funciona) -->
    <script>
        // ============================================
        // SISTEMA DE TRANSFER√äNCIA INTERNACIONAL
        // FUN√á√ïES GLOBAIS EXPL√çCITAS
        // ============================================

        // VARI√ÅVEL GLOBAL
        window.arquivoInvoice = null;

        // 1. CARREGAR CONTAS (GLOBAL)
        window.carregarContas = async function() {
            console.log('üìã Carregando contas...');
            
            const select = document.getElementById('conta_origem');
            if (!select) return;
            
            while (select.options.length > 1) select.remove(1);
            
            try {
                const response = await fetch('/api/user/contas');
                if (!response.ok) throw new Error(`API retornou ${response.status}`);
                
                const data = await response.json();
                
                data.contas.forEach(conta => {
                    if (conta.ativa !== false) {
                        const option = document.createElement('option');
                        option.value = conta.id;
                        option.textContent = `${window.getEmojiMoeda(conta.moeda)} ${window.getNomeMoeda(conta.moeda)} - Saldo: ${window.formatarSaldo(conta.saldo, conta.moeda)}`;
                        option.dataset.moeda = conta.moeda;
                        option.dataset.saldo = conta.saldo;
                        select.appendChild(option);
                    }
                });
                
                console.log(`‚úÖ ${data.contas.length} contas carregadas`);
                
                select.addEventListener('change', function() {
                    const selected = this.options[this.selectedIndex];
                    if (selected && selected.value) {
                        const moedaLabel = document.getElementById('moeda_label');
                        if (moedaLabel) moedaLabel.textContent = selected.dataset.moeda;
                        
                        const infoSaldo = document.getElementById('saldo_info');
                        if (infoSaldo) {
                            const saldoFormatado = window.formatarSaldo(selected.dataset.saldo, selected.dataset.moeda);
                            infoSaldo.innerHTML = `<i class="fas fa-info-circle"></i> Saldo dispon√≠vel: <strong>${saldoFormatado}</strong>`;
                            infoSaldo.classList.remove('hidden');
                        }
                    }
                });
                
                if (select.options.length > 1) {
                    select.selectedIndex = 1;
                    select.dispatchEvent(new Event('change'));
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar contas:', error);
                window.mostrarMensagem('Erro ao carregar contas. Tente recarregar a p√°gina.', 'error');
            }
        };

        // 2. CARREGAR BENEFICI√ÅRIOS (GLOBAL)
        window.carregarBeneficiarios = async function() {
            console.log('üë• Carregando benefici√°rios...');
            
            const select = document.getElementById('beneficiarios_salvos');
            if (!select) return;
            
            while (select.options.length > 1) select.remove(1);
            
            try {
                const response = await fetch('/api/beneficiarios');
                if (!response.ok) throw new Error(`API retornou ${response.status}`);
                
                const data = await response.json();
                
                data.beneficiarios.forEach(benef => {
                    const option = document.createElement('option');
                    option.value = benef.id;
                    option.textContent = `${window.getEmojiPais(benef.pais)} ${benef.nome} - ${benef.banco}`;
                    option.dataset.beneficiario = JSON.stringify(benef);
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${data.beneficiarios.length} benefici√°rios carregados`);
                
                select.addEventListener('change', function() {
                    const selected = this.options[this.selectedIndex];
                    if (selected && selected.value) {
                        try {
                            const beneficiario = JSON.parse(selected.dataset.beneficiario);
                            window.preencherCamposBeneficiario(beneficiario);
                        } catch (error) {
                            console.error('‚ùå Erro ao processar benefici√°rio:', error);
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar benefici√°rios:', error);
            }
        };

        // 3. FUN√á√ïES AUXILIARES (GLOBAIS)
        window.getEmojiMoeda = function(moeda) {
            const emojis = { USD: 'üíµ', EUR: 'üí∂', GBP: 'üí∑', BRL: 'üí∞' };
            return emojis[moeda] || 'üí≥';
        };

        window.getNomeMoeda = function(moeda) {
            const nomes = {
                USD: 'D√≥lar Americano',
                EUR: 'Euro',
                GBP: 'Libra Esterlina',
                BRL: 'Real Brasileiro'
            };
            return nomes[moeda] || moeda;
        };

        window.getEmojiPais = function(pais) {
            const emojis = {
                'CHINA': 'üá®üá≥', 'CHINA (MAINLAND)': 'üá®üá≥',
                'USA': 'üá∫üá∏', 'UNITED STATES': 'üá∫üá∏',
                'GERMANY': 'üá©üá™', 'DEUTSCHLAND': 'üá©üá™',
                'UK': 'üá¨üáß', 'UNITED KINGDOM': 'üá¨üáß',
                'BRAZIL': 'üáßüá∑', 'BRASIL': 'üáßüá∑'
            };
            return emojis[pais?.toUpperCase()] || 'üåé';
        };

        window.formatarSaldo = function(saldo, moeda) {
            const simbolos = { USD: '$', EUR: '‚Ç¨', GBP: '¬£', BRL: 'R$' };
            const simbolo = simbolos[moeda] || moeda;
            const numero = parseFloat(saldo) || 0;
            return `${simbolo} ${numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        };

        window.preencherCamposBeneficiario = function(beneficiario) {
            console.log('üìù Preenchendo dados do benefici√°rio:', beneficiario.nome);
            
            const campos = {
                'beneficiario': beneficiario.nome,
                'endereco': beneficiario.endereco || '',
                'cidade': beneficiario.cidade || '',
                'pais': beneficiario.pais || '',
                'banco': beneficiario.banco || '',
                'endereco_banco': beneficiario.endereco_banco || '',
                'cidade_banco': beneficiario.cidade_banco || '',
                'pais_banco': beneficiario.pais_banco || '',
                'swift': beneficiario.swift || '',
                'iban': beneficiario.iban || '',
                'aba': beneficiario.aba || ''
            };
            
            Object.entries(campos).forEach(([id, valor]) => {
                const element = document.getElementById(id);
                if (element) element.value = valor || '';
            });
        };

        window.mostrarMensagem = function(texto, tipo = 'info') {
            const alert = document.getElementById('alert');
            if (!alert) return;
            
            alert.textContent = texto;
            alert.className = `alert ${tipo}`;
            alert.classList.remove('hidden');
            
            setTimeout(() => alert.classList.add('hidden'), 5000);
        };

        window.formatarTamanho = function(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        window.mostrarSucessoTransferencia = function(id, dados) {
            document.getElementById('modalTransferId').textContent = id;
            document.getElementById('modalValor').textContent = 
                `${dados.moeda} ${parseFloat(dados.valor).toFixed(2)}`;
            
            const modal = document.getElementById('successModal');
            modal.classList.remove('hidden');
            
            document.getElementById('closeModalBtn').onclick = () => modal.classList.add('hidden');
            document.getElementById('goToDashboardBtn').onclick = () => window.location.href = '/dashboard';
        };

        // ============================================
        // FUN√á√ïES DE ENVIO (GLOBAIS)
        // ============================================

        // INICIALIZAR DRAG & DROP
        window.inicializarDragDrop = function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('invoiceFile');
            const selectBtn = document.getElementById('selectFileBtn');
            const removeBtn = document.getElementById('removeFileBtn');
            
            if (!uploadArea) return;
            
            ['dragover', 'dragleave', 'drop'].forEach(event => {
                uploadArea.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            uploadArea.addEventListener('dragover', () => uploadArea.classList.add('dragover'));
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', e => {
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) window.processarArquivo(e.dataTransfer.files[0]);
            });
            
            selectBtn?.addEventListener('click', () => fileInput?.click());
            fileInput?.addEventListener('change', function(e) {
                if (this.files.length > 0) window.processarArquivo(this.files[0]);
            });
            
            removeBtn?.addEventListener('click', function() {
                window.arquivoInvoice = null;
                fileInput.value = '';
                document.getElementById('filePreview')?.classList.add('hidden');
                window.mostrarMensagem('Arquivo removido', 'info');
            });
        };

        // PROCESSAR ARQUIVO
        window.processarArquivo = function(file) {
            const maxSize = 5 * 1024 * 1024;
            const tiposPermitidos = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            
            if (file.size > maxSize) {
                window.mostrarMensagem('Arquivo muito grande! M√°ximo 5MB.', 'error');
                return;
            }
            
            if (!tiposPermitidos.includes(file.type)) {
                window.mostrarMensagem('Formato n√£o suportado! Use PDF, JPG ou PNG.', 'error');
                return;
            }
            
            window.arquivoInvoice = file;
            
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileIcon = document.getElementById('fileIcon');
            const preview = document.getElementById('filePreview');
            
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = window.formatarTamanho(file.size);
            
            if (fileIcon) {
                fileIcon.className = file.type === 'application/pdf' ? 
                    'fas fa-file-pdf' : 'fas fa-file-image';
                fileIcon.style.color = file.type === 'application/pdf' ? '#e74c3c' : '#27ae60';
            }
            
            if (preview) preview.classList.remove('hidden');
            window.mostrarMensagem('Arquivo selecionado com sucesso!', 'success');
        };

        // FUN√á√ÉO PRINCIPAL ENVIAR TRANSFER√äNCIA
        window.enviarTransferencia = async function() {
            console.log('üöÄ Iniciando envio da transfer√™ncia...');
            
            if (!window.validarFormulario()) return false;
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            submitBtn.disabled = true;
            
            try {
                const dadosTransferencia = window.coletarDadosFormulario();
                console.log('üìã Dados coletados:', dadosTransferencia);
                
                const formData = new FormData();
                formData.append('dados', JSON.stringify(dadosTransferencia));
                
                if (window.arquivoInvoice) {
                    formData.append('invoice', window.arquivoInvoice);
                    console.log('üìé Adicionando arquivo:', window.arquivoInvoice.name);
                }
                
                console.log('üì§ Enviando para /api/transferencias/criar...');
                const response = await fetch('/api/transferencias/criar', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `Erro ${response.status}`);
                }
                
                const resultado = await response.json();
                console.log('‚úÖ Resultado:', resultado);
                
                if (!resultado.success) throw new Error(resultado.message);
                
                if (document.getElementById('salvar_beneficiario')?.checked) {
                    await window.salvarBeneficiarioSeparado(dadosTransferencia);
                }
                
                window.mostrarSucessoTransferencia(resultado.transferencia_id, dadosTransferencia);
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                window.mostrarMensagem(`Erro: ${error.message}`, 'error');
                return false;
                
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        };

        // COLETAR DADOS DO FORMUL√ÅRIO
        window.coletarDadosFormulario = function() {
            const contaSelecionada = document.getElementById('conta_origem');
            const opcaoSelecionada = contaSelecionada?.options[contaSelecionada.selectedIndex];
            
            return {
                conta_origem: contaSelecionada?.value || '',
                valor: document.getElementById('valor')?.value || '0',
                moeda: opcaoSelecionada?.dataset.moeda || 'USD',
                beneficiario: document.getElementById('beneficiario')?.value || '',
                endereco: document.getElementById('endereco')?.value || '',
                cidade: document.getElementById('cidade')?.value || '',
                pais: document.getElementById('pais')?.value || '',
                banco: document.getElementById('banco')?.value || '',
                endereco_banco: document.getElementById('endereco_banco')?.value || '',
                cidade_banco: document.getElementById('cidade_banco')?.value || '',
                pais_banco: document.getElementById('pais_banco')?.value || '',
                swift: document.getElementById('swift')?.value || '',
                iban: document.getElementById('iban')?.value || '',
                aba: document.getElementById('aba')?.value || '',
                finalidade: document.getElementById('finalidade')?.value || '',
                descricao: document.getElementById('descricao')?.value || ''
            };
        };

        // SALVAR BENEFICI√ÅRIO SEPARADAMENTE
        window.salvarBeneficiarioSeparado = async function(dadosTransferencia) {
            try {
                const dadosBeneficiario = {
                    nome: dadosTransferencia.beneficiario,
                    endereco: dadosTransferencia.endereco,
                    cidade: dadosTransferencia.cidade,
                    pais: dadosTransferencia.pais,
                    banco: dadosTransferencia.banco,
                    endereco_banco: dadosTransferencia.endereco_banco,
                    cidade_banco: dadosTransferencia.cidade_banco,
                    pais_banco: dadosTransferencia.pais_banco,
                    swift: dadosTransferencia.swift,
                    iban: dadosTransferencia.iban,
                    aba: dadosTransferencia.aba || ''
                };
                
                console.log('üì§ Salvando benefici√°rio...');
                
                const response = await fetch('/api/beneficiarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosBeneficiario)
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    console.log('‚úÖ Benefici√°rio salvo:', resultado);
                } else {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel salvar benefici√°rio');
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao salvar benefici√°rio:', error);
            }
        };

        // VALIDA√á√ÉO
        window.validarFormulario = function() {
            const camposObrigatorios = [
                'conta_origem', 'valor', 'finalidade', 'beneficiario',
                'endereco', 'cidade', 'pais', 'banco', 'swift', 'iban'
            ];
            
            for (const campoId of camposObrigatorios) {
                const campo = document.getElementById(campoId);
                if (!campo || !campo.value.trim()) {
                    window.mostrarMensagem(`Preencha: ${campoId.replace('_', ' ')}`, 'error');
                    campo?.focus();
                    return false;
                }
            }
            
            const valor = parseFloat(document.getElementById('valor')?.value);
            if (isNaN(valor) || valor <= 0) {
                window.mostrarMensagem('Digite um valor v√°lido > 0', 'error');
                return false;
            }
            
            return true;
        };

        // ============================================
        // INICIALIZAR TUDO (DOMContentLoaded)
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema de Transfer√™ncia iniciando...');
            
            // Atualizar nome do usu√°rio
            const usernameElement = document.getElementById('username');
            if (usernameElement && window.USER?.nome) {
                usernameElement.textContent = window.USER.nome;
            }
            
            // Carregar dados
            window.carregarContas();
            window.carregarBeneficiarios();
            
            // Inicializar drag & drop
            window.inicializarDragDrop();
            
            // Configurar submit do formul√°rio
            const form = document.getElementById('transferenciaForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await window.enviarTransferencia();
                });
            }
            
            console.log('‚úÖ Sistema carregado e pronto para uso!');
            console.log('üîç Fun√ß√µes dispon√≠veis globalmente:');
            console.log('  enviarTransferencia:', typeof window.enviarTransferencia);
            console.log('  carregarContas:', typeof window.carregarContas);
        });
    </script>
</body>
</html>