
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer√™ncia Internacional | Cambio Bank</title>
    
    <!-- CSS ORGANIZADO -->
    <link rel="stylesheet" href="/static/css/style.css">          <!-- Estilos gerais -->
    <link rel="stylesheet" href="/static/css/formularios.css">   <!-- Estilos espec√≠ficos de formul√°rios -->
    
    <!-- √çcones FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS ESPEC√çFICO DO CABE√áALHO/FOOTER DA TRANSFER√äNCIA -->
    <style>
    /* CABE√áALHO ESPEC√çFICO PARA TRANSFER√äNCIA */
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px; /* ‚Üê J√Å TEM */
        background: var(--cor-card);
        border-bottom: 1px solid var(--cor-borda);
        position: sticky;
        top: 0;
        z-index: 100;
        /* ADICIONE: */
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
    }

    .header-left, .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: bold;
    }

    .logo i {
        color: var(--cor-primaria);
        font-size: 24px;
    }

    .logo h1 {
        font-size: 20px;
        font-weight: bold;
        background: linear-gradient(90deg, var(--cor-primaria), #2d8fff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--cor-texto);
    }

    .btn-back {
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        padding: 8px 16px;
        border-radius: var(--borda-radius-pequeno);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        border-color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
    }

    /* FOOTER ESPEC√çFICO */
    .main-footer {
        margin-top: 40px;
        padding: 20px 30px;
        border-top: 1px solid var(--cor-borda);
        background: var(--cor-card);
        text-align: center;
        color: var(--cor-texto-secundario);
        /* ADICIONE: */
        max-width: 1400px;
        margin: 20px auto 0;
        width: 100%;
    }

    .footer-links a {
        color: var(--cor-texto-secundario);
        text-decoration: none;
        margin: 0 10px;
    }

    .footer-links a:hover {
        color: var(--cor-primaria);
    }

    /* NAVEGA√á√ÉO (BREADCRUMB) */
    .page-nav {
        padding: 15px 30px; /* ‚Üê J√Å TEM */
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--cor-borda);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        /* ADICIONE: */
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
    }

    .page-nav a {
        color: var(--cor-texto-secundario);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .page-nav a:hover {
        color: var(--cor-primaria);
    }

    .page-nav i {
        font-size: 12px;
    }

    .page-nav .fa-chevron-right {
        color: var(--cor-texto-secundario);
        opacity: 0.5;
    }

    .current-page {
        color: var(--cor-texto);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* T√çTULO DA P√ÅGINA */
    .page-header {
        padding: 30px 30px 20px;
        text-align: center; /* ‚Üê ADICIONE ESTA LINHA */
        max-width: 1200px; /* ‚Üê ADICIONE ESTA LINHA */
        margin: 0 auto; /* ‚Üê ADICIONE ESTA LINHA */
    }

    .page-header h2 {
        font-size: 28px;
        margin-bottom: 10px;
        color: var(--cor-texto);
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center; /* ‚Üê ADICIONE ESTA LINHA */
    }

    .page-header h2 i {
        color: var(--cor-primaria);
    }

    .page-subtitle {
        color: var(--cor-texto-secundario);
        font-size: 16px;
        margin: 0;
    }

    /* BOT√ïES (ESTILO DO DASHBOARD) */
    .btn-primary, .btn-secondary {
        padding: 12px 24px;
        border-radius: var(--borda-radius-pequeno);
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        font-size: 15px;
        border: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--cor-primaria), #2d8fff);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 95, 180, 0.3);
    }

    .btn-secondary {
        background: transparent;
        color: var(--cor-texto);
        border: 1px solid var(--cor-borda);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--cor-texto-secundario);
    }

    /* CONTAINER DOS BOT√ïES */
    .form-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
    }
    
    .content-container {
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        padding: 0 20px;
    }

    </style>
</head>



<body>
    <!-- CABE√áALHO FIXO (IGUAL AO DASHBOARD) -->
    <header class="main-header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-university"></i>
                <h1>CAMBI<span class="logo-highlight">O</span> BANK</h1>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span id="username">Carregando...</span>
                <i class="fas fa-user-circle"></i>
            </div>
            <a href="/dashboard" class="btn-back">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </header>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main-content">
        <!-- BREADCRUMB/NAVEGA√á√ÉO -->
        <div class="content-container">
        <nav class="page-nav">
            <a href="/dashboard"><i class="fas fa-home"></i> Home</a>
            <i class="fas fa-chevron-right"></i>
            <span class="current-page"><i class="fas fa-exchange-alt"></i> Transfer√™ncia Internacional</span>
        </nav>

        <!-- T√çTULO DA P√ÅGINA -->
        <div class="page-header">
            <h2><i class="fas fa-globe-americas"></i> TRANSFER√äNCIA INTERNACIONAL</h2>
            <p class="page-subtitle">Envie dinheiro para qualquer parte do mundo com seguran√ßa</p>
        </div>

        <!-- FORMUL√ÅRIO DE TRANSFER√äNCIA -->
        <div class="form-container">
            <div class="form-card">
                <h3 class="form-title">
                    <i class="fas fa-file-invoice-dollar"></i> Dados da Transfer√™ncia
                </h3>
                
                <!-- ALERTAS -->
                <div id="alert" class="alert hidden"></div>

                <form id="transferenciaForm">
                    <!-- LINHA 1: CONTA ORIGEM E VALOR -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conta_origem">
                                <i class="fas fa-wallet"></i> Conta de Origem *
                            </label>
                            <select id="conta_origem" name="conta_origem" required>
                                <option value="">Selecione sua conta...</option>
                                <!-- Contas ser√£o carregadas via JavaScript -->
                            </select>
                            <div id="saldo_info" class="saldo-info">
                                <i class="fas fa-info-circle"></i> Saldo dispon√≠vel: <span id="saldo_valor">--</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="valor">
                                <i class="fas fa-money-bill-wave"></i> Valor a Transferir *
                            </label>
                            <div class="input-with-icon">
                                <input type="number" id="valor" name="valor" step="0.01" min="0.01" 
                                       placeholder="0.00" required>
                                <span id="moeda_label" class="currency-label">USD</span>
                            </div>
                            <small class="helper-text">Valor m√≠nimo: 0.01</small>
                        </div>
                    </div>

                    <!-- LINHA 2: FINALIDADE -->
                    <div class="form-group">
                        <label for="finalidade">
                            <i class="fas fa-bullseye"></i> Finalidade da Transfer√™ncia *
                        </label>
                        <select id="finalidade" name="finalidade" required>
                            <option value="Pagamento de Servi√ßos">Pagamento de Servi√ßos</option>
                            <option value="Pagamento de Produtos">Pagamento de Produtos</option>
                            <option value="Remessa Familiar">Remessa Familiar</option>
                            <option value="Investimento">Investimento</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>

                    <!-- LINHA 3: DESCRI√á√ÉO -->
                    <div class="form-group">
                        <label for="descricao">
                            <i class="fas fa-comment-alt"></i> Descri√ß√£o / Observa√ß√µes
                        </label>
                        <textarea id="descricao" name="descricao" rows="3" 
                                  placeholder="Descreva o prop√≥sito desta transfer√™ncia..."></textarea>
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO BENEFICI√ÅRIO -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-user-tie"></i> Dados do Benefici√°rio
                    </h3>

                    <!-- BENEFICI√ÅRIOS SALVOS -->
                    <div class="form-group">
                        <label for="beneficiarios_salvos">
                            <i class="fas fa-address-book"></i> Benefici√°rios Salvos
                        </label>
                        <select id="beneficiarios_salvos" class="beneficiarios-select">
                            <option value="">Selecione um benefici√°rio salvo...</option>
                            <!-- Benefici√°rios ser√£o carregados via JavaScript -->
                        </select>
                        <small class="helper-text">Selecione para preencher automaticamente</small>
                    </div>

                    <!-- CAMPOS DO BENEFICI√ÅRIO -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="beneficiario">
                                <i class="fas fa-user"></i> Nome Completo do Benefici√°rio *
                            </label>
                            <input type="text" id="beneficiario" name="beneficiario" 
                                   placeholder="Nome completo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="endereco">
                                <i class="fas fa-map-marker-alt"></i> Endere√ßo Completo *
                            </label>
                            <input type="text" id="endereco" name="endereco" 
                                   placeholder="Rua, n√∫mero, complemento" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade">
                                <i class="fas fa-city"></i> Cidade *
                            </label>
                            <input type="text" id="cidade" name="cidade" 
                                   placeholder="Cidade" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pais">
                                <i class="fas fa-flag"></i> Pa√≠s *
                            </label>
                            <input type="text" id="pais" name="pais" 
                                   placeholder="Pa√≠s" required>
                        </div>
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO BANCO DESTINAT√ÅRIO -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-university"></i> Banco Destinat√°rio
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="banco">
                                <i class="fas fa-landmark"></i> Nome do Banco *
                            </label>
                            <input type="text" id="banco" name="banco" 
                                   placeholder="Nome do banco destinat√°rio" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="endereco_banco">
                                <i class="fas fa-map-pin"></i> Endere√ßo do Banco
                            </label>
                            <input type="text" id="endereco_banco" name="endereco_banco" 
                                   placeholder="Endere√ßo do banco">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade_banco">
                                <i class="fas fa-city"></i> Cidade do Banco *
                            </label>
                            <input type="text" id="cidade_banco" name="cidade_banco" 
                                   placeholder="Cidade do banco" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pais_banco">
                                <i class="fas fa-flag"></i> Pa√≠s do Banco *
                            </label>
                            <input type="text" id="pais_banco" name="pais_banco" 
                                   placeholder="Pa√≠s do banco" required>
                        </div>
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO DADOS BANC√ÅRIOS -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-key"></i> Dados Banc√°rios
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="swift">
                                <i class="fas fa-barcode"></i> C√≥digo SWIFT/BIC *
                            </label>
                            <input type="text" id="swift" name="swift" 
                                   placeholder="Ex: CHASUS33XXX" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="iban">
                                <i class="fas fa-hashtag"></i> C√≥digo IBAN / Account # *
                            </label>
                            <input type="text" id="iban" name="iban" 
                                   placeholder="N√∫mero da conta" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="aba">
                            <i class="fas fa-route"></i> C√≥digo ABA / Routing #
                        </label>
                        <input type="text" id="aba" name="aba" 
                               placeholder="Apenas para transfer√™ncias EUA">
                    </div>

                    <hr class="form-divider">

                    <!-- SE√á√ÉO INVOICE -->
                    <h3 class="form-subtitle">
                        <i class="fas fa-file-invoice"></i> Documento Comprobat√≥rio (Invoice)
                    </h3>

                    <div class="form-group">
                        <div class="file-upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Arraste e solte o arquivo aqui ou</p>
                            <button type="button" class="btn-select-file" id="selectFileBtn">
                                <i class="fas fa-folder-open"></i> Selecionar Arquivo
                            </button>
                            <input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                            <p class="file-info">
                                <small>Formatos aceitos: PDF, JPG, PNG (m√°x. 5MB)</small>
                            </p>
                        </div>
                        <div id="filePreview" class="file-preview hidden">
                            <i class="fas fa-file-pdf"></i>
                            <span id="fileName">arquivo.pdf</span>
                            <button type="button" class="btn-remove-file" id="removeFileBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- CHECKBOX SALVAR BENEFICI√ÅRIO -->
                    <div class="form-checkbox">
                        <input type="checkbox" id="salvar_beneficiario" name="salvar_beneficiario">
                        <label for="salvar_beneficiario">
                            <i class="fas fa-save"></i> Salvar este benefici√°rio para futuras transfer√™ncias
                        </label>
                    </div>

                    <!-- BOT√ïES -->
                    <div class="form-buttons">
                        <button type="button" class="btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Solicitar Transfer√™ncia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- RODAP√â -->
    <footer class="main-footer">
        <p>¬© 2024 Cambio Bank - Sistema de C√¢mbio Internacional. Todos os direitos reservados.</p>
        <p class="footer-links">
            <a href="#"><i class="fas fa-shield-alt"></i> Seguran√ßa</a> |
            <a href="#"><i class="fas fa-question-circle"></i> Ajuda</a> |
            <a href="#"><i class="fas fa-envelope"></i> Contato</a>
        </p>
    </footer>

    <!-- MODAL DE SUCESSO -->
    <div id="successModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>Transfer√™ncia Solicitada com Sucesso!</h3>
            <p id="modalMessage">Sua transfer√™ncia foi registrada e est√° aguardando aprova√ß√£o.</p>
            <div class="modal-details">
                <p><strong>ID da Transfer√™ncia:</strong> <span id="modalTransferId">--</span></p>
                <p><strong>Valor:</strong> <span id="modalValor">--</span></p>
                <p><strong>Status:</strong> <span class="status-pending">Aguardando Aprova√ß√£o</span></p>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" id="closeModalBtn">Fechar</button>
                <button class="btn-primary" id="goToDashboardBtn">
                    <i class="fas fa-tachometer-alt"></i> Voltar ao Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- VARI√ÅVEIS DO FLASK (CR√çTICO!) -->
    <script>
        // Dados do usu√°rio logado (do Flask)
        window.USER = { 
            username: "{{ usuario if usuario else '' }}", 
            nome: "{{ nome if nome else 'Usu√°rio' }}", 
            email: "{{ email if email else 'usuario@exemplo.com' }}"
        };
        window.API_URL = "";
        
        console.log('Transfer√™ncia - Usu√°rio logado:', window.USER);
    </script>

    <!-- SCRIPTS -->
    <script src="/static/js/script.js"></script>
    <script>
    // ============================================
    // C√ìDIGO JAVASCRIPT CORRIGIDO - VERS√ÉO MESCLADA
    // Combina: Upload de invoice (c√≥digo atual) + Spinners/Popup (c√≥digo anterior)
    // ============================================

    let selectedFile = null;
    let userContas = [];

    // ============================================
    // 1. FUN√á√ÉO DE POPUP ELEGANTE (DO C√ìDIGO ANTERIOR - FUNCIONAVA)
    // ============================================

    function garantirPopupSucesso(transferenciaId, valor, moeda) {
        console.log('üéâ TRANSFER√äNCIA BEM-SUCEDIDA:', transferenciaId);
        
        // Remover qualquer popup anterior
        const popupAntigo = document.getElementById('elegantSuccessPopup');
        if (popupAntigo) popupAntigo.remove();
        document.querySelectorAll('.popup-overlay').forEach(el => el.remove());
        
        // Criar overlay escuro
        const overlay = document.createElement('div');
        overlay.className = 'popup-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99998;
            animation: fadeInOverlay 0.3s ease;
        `;
        
        // Criar popup elegante VERDE
        const popup = document.createElement('div');
        popup.id = 'elegantSuccessPopup';
        popup.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(5, 150, 105, 0.4);
            z-index: 99999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 90%;
            max-width: 500px;
            text-align: center;
            animation: popupSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        `;
        
        popup.innerHTML = `
            <div style="
                font-size: 70px;
                margin-bottom: 20px;
                animation: iconBounce 1s infinite alternate;
                filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
            ">‚úÖ</div>
            
            <h2 style="
                margin: 0 0 15px 0;
                font-size: 32px;
                font-weight: 700;
                letter-spacing: -0.5px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            ">Transfer√™ncia Conclu√≠da!</h2>
            
            <p style="
                margin: 0 0 30px 0;
                font-size: 17px;
                opacity: 0.95;
                line-height: 1.5;
                font-weight: 400;
            ">Sua transfer√™ncia internacional foi<br>solicitada com sucesso e est√° em processamento.</p>
            
            <div style="
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 25px;
                margin: 25px 0;
                text-align: left;
                border: 1px solid rgba(255, 255, 255, 0.2);
            ">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;">
                    <span style="opacity: 0.9; font-size: 15px;">ID da Transfer√™ncia:</span>
                    <strong style="font-size: 20px; letter-spacing: 1px;">${transferenciaId}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="opacity: 0.9; font-size: 15px;">Valor Transferido:</span>
                    <strong style="font-size: 28px; color: #a7f3d0; font-weight: 800;">
                        ${parseFloat(valor).toFixed(2)} ${moeda}
                    </strong>
                </div>
            </div>
            
            <div style="
                display: flex;
                gap: 15px;
                margin-top: 30px;
                justify-content: center;
            ">
                <button id="fecharPopupBtn" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 15px 35px;
                    border-radius: 50px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    flex: 1;
                    min-width: 140px;
                ">Fechar</button>
                
                <button id="verTransferenciaBtn" style="
                    background: white;
                    color: #059669;
                    border: none;
                    padding: 15px 35px;
                    border-radius: 50px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    flex: 1;
                    min-width: 140px;
                    box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
                ">Ver Detalhes</button>
            </div>
            
            <div style="
                margin-top: 25px;
                font-size: 14px;
                opacity: 0.8;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            ">
                <span style="display: inline-block; width: 10px; height: 10px; background: #a7f3d0; border-radius: 50%; animation: pulse 2s infinite;"></span>
                Status: <strong>Em processamento</strong>
            </div>
        `;
        
        // Adicionar estilos de anima√ß√£o
        const style = document.createElement('style');
        style.textContent = `
            @keyframes popupSlideIn {
                0% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8) translateY(30px);
                }
                100% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }
            
            @keyframes fadeInOverlay {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes iconBounce {
                from { transform: translateY(0); }
                to { transform: translateY(-10px); }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            
            #fecharPopupBtn:hover {
                background: rgba(255, 255, 255, 0.3) !important;
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
            
            #verTransferenciaBtn:hover {
                background: #f0fdf4 !important;
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(255, 255, 255, 0.2);
            }
        `;
        document.head.appendChild(style);
        
        // Adicionar ao body
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
        
        // Event listeners para os bot√µes
        document.getElementById('fecharPopupBtn').onclick = function() {
            fecharPopupElegante();
        };
        
        document.getElementById('verTransferenciaBtn').onclick = function() {
            fecharPopupElegante();
            // Redirecionar para minhas transfer√™ncias
            setTimeout(() => {
                window.location.href = '/minhas-transferencias';
            }, 300);
        };
        
        // Fechar ao clicar no overlay
        overlay.onclick = fecharPopupElegante;
        
        // Fechar automaticamente ap√≥s 8 segundos
        setTimeout(fecharPopupElegante, 8000);
    }

    function fecharPopupElegante() {
        const popup = document.getElementById('elegantSuccessPopup');
        const overlay = document.querySelector('.popup-overlay');
        const style = document.querySelector('style');
        
        if (popup) {
            popup.style.animation = 'popupSlideIn 0.3s reverse';
            setTimeout(() => popup.remove(), 300);
        }
        
        if (overlay) {
            overlay.style.animation = 'fadeInOverlay 0.3s reverse';
            setTimeout(() => overlay.remove(), 300);
        }
        
        if (style && style.textContent.includes('popupSlideIn')) {
            setTimeout(() => style.remove(), 500);
        }
    }

    // ============================================
    // 2. CARREGAR DADOS INICIAIS (SIMPLES)
    // ============================================

    async function loadUserData() {
        try {
            const response = await fetch('/api/user');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    document.getElementById('username').textContent = data.user.nome || data.user.username;
                    return data.user;
                }
            }
        } catch (error) {
            console.error('Erro ao carregar dados do usu√°rio:', error);
        }
        return null;
    }

    async function loadContas() {
        try {
            const response = await fetch('/api/user/contas');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.contas) {
                    userContas = data.contas;
                    updateContasSelect();
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao carregar contas:', error);
            showAlert('Erro ao carregar contas. Por favor, recarregue a p√°gina.', 'error');
        }
        return false;
    }

    function updateContasSelect() {
        const select = document.getElementById('conta_origem');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione sua conta...</option>';
        
        userContas.forEach(conta => {
            const option = document.createElement('option');
            option.value = conta.id; // Usar conta.id (igual ao backend espera)
            option.textContent = `${conta.moeda} - Saldo: ${parseFloat(conta.saldo || 0).toFixed(2)}`;
            option.dataset.moeda = conta.moeda || 'USD';
            option.dataset.saldo = conta.saldo || 0;
            select.appendChild(option);
        });
        
        // Configurar evento para atualizar saldo quando mudar conta
        select.addEventListener('change', atualizarSaldoDisplay);
    }

    function atualizarSaldoDisplay() {
        const select = document.getElementById('conta_origem');
        const selectedOption = select.options[select.selectedIndex];
        
        if (!selectedOption || !selectedOption.value) {
            document.getElementById('saldo_valor').textContent = '--';
            document.getElementById('moeda_label').textContent = 'USD';
            return;
        }
        
        const moeda = selectedOption.dataset.moeda || 'USD';
        const saldo = parseFloat(selectedOption.dataset.saldo || 0);
        
        document.getElementById('saldo_valor').textContent = `${saldo.toFixed(2)} ${moeda}`;
        document.getElementById('moeda_label').textContent = moeda;
    }

    // ============================================
    // 3. FUN√á√ÉO PRINCIPAL ENVIARTRANSFERENCIA (MESCLADA)
    // ============================================

    window.enviarTransferencia = async function(e) {
        if (e) e.preventDefault();
        
        console.log('üöÄ enviarTransferencia() - VERS√ÉO CORRIGIDA E SIMPLIFICADA');
        
        // 1. VALIDA√á√ïES INICIAIS
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        btn.disabled = true;
        
        try {
            // 2. COLETAR DADOS
            const dados = {
                // Dados da conta
                conta_origem: document.getElementById('conta_origem').value,
                valor: parseFloat(document.getElementById('valor').value) || 0,
                moeda: document.getElementById('conta_origem').options[
                    document.getElementById('conta_origem').selectedIndex
                ]?.dataset.moeda || 'USD',
                
                // Dados do benefici√°rio
                beneficiario: document.getElementById('beneficiario').value.trim(),
                endereco_beneficiario: document.getElementById('endereco').value.trim(),
                cidade: document.getElementById('cidade').value.trim(),
                pais: document.getElementById('pais').value.trim(),
                
                // Dados do banco
                nome_banco: document.getElementById('banco').value.trim(),
                endereco_banco: document.getElementById('endereco_banco').value.trim(),
                cidade_banco: document.getElementById('cidade_banco').value.trim(),
                pais_banco: document.getElementById('pais_banco').value.trim(),
                
                // Dados banc√°rios
                codigo_swift: document.getElementById('swift').value.trim(),
                iban_account: document.getElementById('iban').value.trim(),
                aba_routing: document.getElementById('aba').value.trim() || '',
                
                // Informa√ß√µes
                finalidade: document.getElementById('finalidade').value || 'Pagamento de Servi√ßos',
                descricao: document.getElementById('descricao').value || '',
                
                // Dados do usu√°rio
                cliente: window.USER?.username || 'pantanal',
                usuario: window.USER?.username || 'pantanal',
                solicitado_por: window.USER?.username || 'pantanal',
                
                // Tipo fixo
                tipo: 'transferencia_internacional',
                status: 'solicitada'
            };
            
            // 3. VALIDAR CAMPOS OBRIGAT√ìRIOS
            const obrigatorios = [
                { id: 'conta_origem', nome: 'Conta de origem' },
                { id: 'valor', nome: 'Valor' },
                { id: 'beneficiario', nome: 'Benefici√°rio' },
                { id: 'endereco', nome: 'Endere√ßo do benefici√°rio' },
                { id: 'cidade', nome: 'Cidade' },
                { id: 'pais', nome: 'Pa√≠s' },
                { id: 'banco', nome: 'Banco' },
                { id: 'endereco_banco', nome: 'Endere√ßo do banco' },
                { id: 'cidade_banco', nome: 'Cidade do banco' },
                { id: 'pais_banco', nome: 'Pa√≠s do banco' },
                { id: 'swift', nome: 'SWIFT' },
                { id: 'iban', nome: 'IBAN' }
            ];
            
            for (const { id, nome } of obrigatorios) {
                const valor = document.getElementById(id).value.trim();
                if (!valor) {
                    showAlert(`‚ùå ${nome} √© obrigat√≥rio`, 'error');
                    document.getElementById(id).focus();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return false;
                }
            }
            
            // 4. VALIDAR VALOR
            if (dados.valor <= 0 || isNaN(dados.valor)) {
                showAlert('‚ùå Digite um valor v√°lido (> 0)', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return false;
            }
            
            // 5. VALIDAR SALDO
            const contaSelect = document.getElementById('conta_origem');
            const saldo = parseFloat(contaSelect.options[contaSelect.selectedIndex]?.dataset.saldo || 0);
            
            if (dados.valor > saldo) {
                showAlert(`‚ùå Saldo insuficiente! Dispon√≠vel: ${saldo.toFixed(2)} ${dados.moeda}`, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return false;
            }
            
            // 6. PREPARAR ENVIO COM FORMDATA (para upload de invoice)
            const formData = new FormData();
            formData.append('dados', JSON.stringify(dados));
            
            // Adicionar arquivo se existir
            if (selectedFile) {
                formData.append('invoice', selectedFile);
                console.log('üìé Adicionando arquivo:', selectedFile.name);
            }
            
            // 7. ENVIAR PARA API
            const response = await fetch('/api/transferencias/criar', {
                method: 'POST',
                body: formData
            });
            
            const resultado = await response.json();
            console.log('‚úÖ Resposta API:', resultado);
            
            if (!response.ok) {
                throw new Error(resultado.message || `Erro ${response.status}`);
            }
            
            if (resultado.success) {
                // üéØ 1. MOSTRAR POPUP IMEDIATAMENTE
                garantirPopupSucesso(resultado.transferencia_id, dados.valor.toFixed(2), dados.moeda);
                
                // üéØ 2. RECARREGAR CONTAS (para atualizar saldo)
                await recarregarContas();
                
                // üéØ 3. SALVAR BENEFICI√ÅRIO EM SEGUNDO PLANO (opcional)
                if (document.getElementById('salvar_beneficiario')?.checked) {
                    setTimeout(async () => {
                        try {
                            await salvarBeneficiario(dados);
                            console.log('‚úÖ Benefici√°rio salvo opcionalmente');
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Erro ao salvar benefici√°rio:', error.message);
                        }
                    }, 100);
                }
                
                // üéØ 4. LIMPAR FORMUL√ÅRIO
                document.getElementById('transferenciaForm').reset();
                selectedFile = null;
                document.getElementById('filePreview').classList.add('hidden');
                
            } else {
                throw new Error(resultado.message);
            }
            
        } catch (error) {
            console.error('‚ùå Erro:', error);
            showAlert(`‚ùå ${error.message}`, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        return false;
    };

    // ============================================
    // 4. FUN√á√ïES AUXILIARES
    // ============================================

    async function recarregarContas() {
        try {
            const response = await fetch('/api/user/contas');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.contas) {
                    userContas = data.contas;
                    updateContasSelect();
                    
                    // Atualizar display do saldo se houver conta selecionada
                    const select = document.getElementById('conta_origem');
                    if (select.value) {
                        atualizarSaldoDisplay();
                    }
                    
                    console.log('‚úÖ Contas recarregadas ap√≥s transfer√™ncia');
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao recarregar contas:', error);
        }
    }

    async function salvarBeneficiario(dados) {
        try {
            const benef = {
                nome: dados.beneficiario,
                endereco: dados.endereco_beneficiario,
                cidade: dados.cidade,
                pais: dados.pais,
                banco: dados.nome_banco,
                endereco_banco: dados.endereco_banco,
                cidade_banco: dados.cidade_banco,
                pais_banco: dados.pais_banco,
                swift: dados.codigo_swift,
                iban: dados.iban_account,
                aba: dados.aba_routing || '',
                cliente_username: window.USER?.username || 'pantanal',
                ativo: true
            };
            
            const response = await fetch('/api/beneficiarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(benef)
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Benefici√°rio salvo:', result);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao salvar benefici√°rio:', error);
        }
    }

    function showAlert(message, type = 'info') {
        const alertDiv = document.getElementById('alert');
        if (!alertDiv) return;
        
        alertDiv.textContent = message;
        alertDiv.className = `alert ${type}`;
        alertDiv.classList.remove('hidden');
        
        setTimeout(() => {
            alertDiv.classList.add('hidden');
        }, 5000);
    }

    // ============================================
    // 5. CONFIGURA√á√ÉO DE UPLOAD DE ARQUIVO
    // ============================================

    function configurarUploadInvoice() {
        const uploadArea = document.getElementById('uploadArea');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const invoiceFileInput = document.getElementById('invoiceFile');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const removeFileBtn = document.getElementById('removeFileBtn');
        
        if (!uploadArea || !invoiceFileInput) return;
        
        // Click na √°rea ou bot√£o
        uploadArea.addEventListener('click', () => invoiceFileInput.click());
        selectFileBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            invoiceFileInput.click();
        });
        
        // Arquivo selecionado
        invoiceFileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                
                // Validar tamanho (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('‚ùå Arquivo muito grande! M√°ximo: 5MB', 'error');
                    this.value = '';
                    return;
                }
                
                // Validar tipo
                const ext = file.name.split('.').pop().toLowerCase();
                if (!['pdf', 'jpg', 'jpeg', 'png'].includes(ext)) {
                    showAlert('‚ùå Formato n√£o suportado! Use: PDF, JPG, PNG', 'error');
                    this.value = '';
                    return;
                }
                
                selectedFile = file;
                
                // Mostrar preview
                if (filePreview && fileName) {
                    fileName.textContent = file.name;
                    filePreview.classList.remove('hidden');
                    uploadArea.style.display = 'none';
                }
            }
        });
        
        // Remover arquivo
        removeFileBtn?.addEventListener('click', function() {
            selectedFile = null;
            invoiceFileInput.value = '';
            if (filePreview) filePreview.classList.add('hidden');
            uploadArea.style.display = 'block';
        });
        
        // Drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#2d8fff';
            uploadArea.style.backgroundColor = 'rgba(45, 58, 90, 0.3)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '';
            uploadArea.style.backgroundColor = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '';
            uploadArea.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                invoiceFileInput.files = dataTransfer.files;
                invoiceFileInput.dispatchEvent(new Event('change'));
            }
        });
    }

    // ============================================
    // 6. INICIALIZA√á√ÉO
    // ============================================

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Sistema de transfer√™ncia iniciado');
        
        // Carregar dados iniciais
        await loadUserData();
        await loadContas();
        
        // Configurar upload
        configurarUploadInvoice();
        
        // Configurar valida√ß√£o em tempo real do valor
        document.getElementById('valor').addEventListener('input', function() {
            const valor = parseFloat(this.value) || 0;
            const contaSelect = document.getElementById('conta_origem');
            const saldo = parseFloat(contaSelect.options[contaSelect.selectedIndex]?.dataset.saldo || 0);
            
            if (valor > saldo) {
                this.style.borderColor = '#e74c3c';
                showAlert(`‚ö†Ô∏è Valor excede saldo dispon√≠vel (${saldo.toFixed(2)})`, 'warning');
            } else if (valor > 0) {
                this.style.borderColor = '#27ae60';
            } else {
                this.style.borderColor = '';
            }
        });
        
        // Configurar formul√°rio para usar nossa fun√ß√£o
        document.getElementById('transferenciaForm').addEventListener('submit', function(e) {
            window.enviarTransferencia(e);
        });
        
        console.log('‚úÖ Sistema pronto para uso!');
    });
    </script>

</body>
</html>
