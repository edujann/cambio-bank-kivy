<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Transfer√™ncias - Sistema C√¢mbio</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CORES IGUAIS AO KIVY - VERS√ÉO ESCURA DEFINITIVA */
        :root {
            /* CORES ATIVAS (Kivy) */
            --cor-primaria: #2646c7;      /* Azul - COR_PRIMARIA (0.15, 0.35, 0.75, 1) */
            --cor-aviso: #cc8000;         /* √Çmbar - COR_AVISO (0.8, 0.5, 0.0, 1) */
            --cor-processando: #3380cc;   /* Azul processando - COR_PROCESSANDO (0.2, 0.5, 0.8, 1) */
            --cor-sucesso: #1a8a1a;       /* Verde - COR_SUCESSO (0.1, 0.6, 0.1, 1) */
            --cor-erro: #b33333;          /* Vermelho - COR_ERRO (0.7, 0.2, 0.2, 1) */
            
            /* CORES INATIVAS - MAIS ESCURAS (Kivy) */
            --cor-primaria-escura: #142266;
            --cor-aviso-escura: #663300;
            --cor-processando-escura: #1a4066;
            --cor-sucesso-escura: #0d440d;
            --cor-erro-escura: #4d1414;
            
            /* FUNDOS (Kivy) */
            --fundo-escuro: #121a26;      /* FUNDO_ESCURO (0.07, 0.10, 0.15, 1) */
            --fundo-card: #263448;        /* FUNDO_CARD (0.15, 0.20, 0.28, 1) */
            
            /* TEXTO */
            --texto-principal: #e0e0e0;
            --texto-secundario: #a0a0a0;
            --texto-destaque: #ffffff;
            
            /* BORDAS */
            --raio-borda: 12px;
            --raio-borda-pequeno: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--fundo-escuro);
            color: var(--texto-principal);
            min-height: 100vh;
        }
        
        /* CONTAINER PRINCIPAL */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--cor-primaria);
        }
        
        .titulo-pagina {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .titulo-pagina i {
            font-size: 32px;
            color: var(--cor-primaria);
        }
        
        .titulo-pagina h1 {
            font-size: 28px;
            color: var(--texto-destaque);
        }
        
        .info-usuario {
            background: var(--fundo-card);
            padding: 10px 20px;
            border-radius: var(--raio-borda);
            font-size: 14px;
        }
        
        /* FILTROS R√ÅPIDOS (IGUAL KIVY) */
        .filtros-rapidos {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn-filtro {
            padding: 12px 24px;
            border: none;
            border-radius: var(--raio-borda-pequeno);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-filtro.ativo {
            color: white;
        }
        
        .btn-filtro:not(.ativo) {
            color: var(--texto-secundario);
        }
        
        /* CORES DOS FILTROS ATIVOS (IGUAL KIVY) */
        #btn-todas.ativo { background: var(--cor-primaria); }
        #btn-pendentes.ativo { background: var(--cor-aviso); }
        #btn-processando.ativo { background: var(--cor-processando); }
        #btn-concluidas.ativo { background: var(--cor-sucesso); }
        #btn-recusadas.ativo { background: var(--cor-erro); }
        
        /* CORES DOS FILTROS INATIVOS (IGUAL KIVY) */
        #btn-todas:not(.ativo) { background: var(--cor-primaria-escura); }
        #btn-pendentes:not(.ativo) { background: var(--cor-aviso-escura); }
        #btn-processando:not(.ativo) { background: var(--cor-processando-escura); }
        #btn-concluidas:not(.ativo) { background: var(--cor-sucesso-escura); }
        #btn-recusadas:not(.ativo) { background: var(--cor-erro-escura); }
        
        /* ESTAT√çSTICAS */
        .estatisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card-estatistica {
            background: var(--fundo-card);
            padding: 20px;
            border-radius: var(--raio-borda);
            text-align: center;
        }
        
        .card-estatistica .numero {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-estatistica .label {
            font-size: 14px;
            color: var(--texto-secundario);
        }
        
        /* LISTA DE TRANSFER√äNCIAS */
        .lista-transferencias {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* CARD DE TRANSFER√äNCIA (IGUAL KIVY) */
        .card-transferencia {
            background: var(--fundo-card);
            border-radius: var(--raio-borda);
            padding: 20px;
            position: relative;
            border-left: 5px solid var(--cor-primaria);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-pending { background: var(--cor-aviso); color: white; }
        .status-processing { background: var(--cor-processando); color: white; }
        .status-completed { background: var(--cor-sucesso); color: white; }
        .status-rejected { background: var(--cor-erro); color: white; }
        
        .transferencia-id {
            font-size: 12px;
            color: var(--texto-secundario);
            font-family: monospace;
        }
        
        .card-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            font-size: 12px;
            color: var(--texto-secundario);
            text-transform: uppercase;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 500;
        }
        
        .valor-destaque {
            font-size: 18px;
            font-weight: bold;
            color: var(--texto-destaque);
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-transferencia {
            font-size: 12px;
            color: var(--texto-secundario);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .botoes-acao {
            display: flex;
            gap: 10px;
        }
        
        .btn-acao {
            padding: 8px 16px;
            border: none;
            border-radius: var(--raio-borda-pequeno);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .btn-acao:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .btn-detalhes { background: var(--cor-primaria); color: white; }
        .btn-invoice { background: var(--cor-sucesso); color: white; }
        .btn-pdf { background: #8e44ad; color: white; }
        
        /* LINHA DA INVOICE (IGUAL KIVY) */
        .invoice-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--raio-borda-pequeno);
        }
        
        .invoice-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .invoice-status.pending { color: var(--cor-aviso); }
        .invoice-status.approved { color: var(--cor-sucesso); }
        .invoice-status.rejected { color: var(--cor-erro); }
        
        .btn-renviar-invoice {
            padding: 6px 12px;
            background: var(--cor-sucesso);
            color: white;
            border: none;
            border-radius: var(--raio-borda-pequeno);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* MODAL DE DETALHES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-container {
            background: var(--fundo-card);
            border-radius: var(--raio-borda);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--cor-primaria);
        }
        
        .modal-title {
            font-size: 24px;
            color: var(--texto-destaque);
        }
        
        .btn-fechar-modal {
            background: none;
            border: none;
            color: var(--texto-secundario);
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--cor-primaria);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        /* LOADING */
        .loading {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--cor-primaria);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* MENSAGEM VAZIA */
        .mensagem-vazia {
            text-align: center;
            padding: 60px 20px;
            color: var(--texto-secundario);
        }
        
        .mensagem-vazia i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .filtros-rapidos {
                justify-content: center;
            }
            
            .card-content {
                grid-template-columns: 1fr;
            }
            
            .card-footer {
                flex-direction: column;
                gap: 15px;
            }
            
            .botoes-acao {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="titulo-pagina">
                <i class="fas fa-exchange-alt"></i>
                <h1>Minhas Transfer√™ncias Internacionais</h1>
            </div>
            <div class="info-usuario">
                <i class="fas fa-user"></i>
                <span id="nomeUsuario">Carregando...</span>
            </div>
        </div>
        
        <!-- FILTROS R√ÅPIDOS (IGUAL KIVY) -->
        <div class="filtros-rapidos">
            <button id="btn-todas" class="btn-filtro ativo" onclick="filtrarTransferencias('all')">
                <i class="fas fa-layer-group"></i> TODAS
            </button>
            <button id="btn-pendentes" class="btn-filtro" onclick="filtrarTransferencias('pending')">
                <i class="fas fa-clock"></i> PENDENTES
            </button>
            <button id="btn-processando" class="btn-filtro" onclick="filtrarTransferencias('processing')">
                <i class="fas fa-sync-alt"></i> PROCESSANDO
            </button>
            <button id="btn-concluidas" class="btn-filtro" onclick="filtrarTransferencias('completed')">
                <i class="fas fa-check-circle"></i> CONCLU√çDAS
            </button>
            <button id="btn-recusadas" class="btn-filtro" onclick="filtrarTransferencias('rejected')">
                <i class="fas fa-times-circle"></i> RECUSADAS
            </button>
        </div>
        
        <!-- ESTAT√çSTICAS -->
        <div class="estatisticas" id="estatisticas">
            <!-- Ser√° preenchido via JavaScript -->
        </div>
        
        <!-- LISTA DE TRANSFER√äNCIAS -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
        </div>
        
        <div class="lista-transferencias" id="listaTransferencias">
            <!-- Transfer√™ncias ser√£o carregadas aqui -->
        </div>
        
        <!-- MENSAGEM VAZIA -->
        <div class="mensagem-vazia" id="mensagemVazia" style="display: none;">
            <i class="fas fa-globe-americas"></i>
            <h3>Nenhuma transfer√™ncia internacional encontrada</h3>
            <p>Quando voc√™ fizer transfer√™ncias internacionais, elas aparecer√£o aqui.</p>
        </div>
    </div>
    
    <!-- MODAL DE DETALHES -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes da Transfer√™ncia</h2>
                <button class="btn-fechar-modal" onclick="fecharModal()">√ó</button>
            </div>
            <div id="modalContent">
                <!-- Conte√∫do do modal ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // DADOS GLOBAIS
        let todasTransferencias = [];
        let transferenciasFiltradas = [];
        let filtroAtual = 'all';
        
        // INICIAR CARREGAMENTO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina Minhas Transfer√™ncias carregada');
            carregarUsuario();
            carregarTransferencias();
        });
        
        // FUN√á√ïES PRINCIPAIS
        async function carregarUsuario() {
            try {
                const response = await fetch('/api/dashboard-data', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const nomeUsuario = data.usuario || data.nome || 'Cliente';
                    document.getElementById('nomeUsuario').textContent = nomeUsuario;
                }
            } catch (error) {
                console.log('Erro ao carregar usu√°rio:', error);
            }
        }
        
        async function carregarTransferencias() {
            mostrarLoading(true);
            
            try {
                const response = await fetch('/api/transferencias-internacionais', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    todasTransferencias = data;
                    console.log(`‚úÖ ${data.length} transfer√™ncias carregadas`);
                    
                    atualizarEstatisticas(data);
                    filtrarTransferencias(filtroAtual);
                } else {
                    throw new Error('Erro ao carregar transfer√™ncias');
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                mostrarErro('Erro ao carregar transfer√™ncias: ' + error.message);
            } finally {
                mostrarLoading(false);
            }
        }
        
        function filtrarTransferencias(filtro) {
            filtroAtual = filtro;
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.btn-filtro').forEach(btn => {
                btn.classList.remove('ativo');
            });
            
            document.getElementById(`btn-${getNomeFiltro(filtro)}`).classList.add('ativo');
            
            // Aplicar filtro
            if (filtro === 'all') {
                transferenciasFiltradas = [...todasTransferencias];
            } else {
                transferenciasFiltradas = todasTransferencias.filter(t => {
                    if (filtro === 'pending') {
                        return t.status === 'pending' || t.status === 'solicitada';
                    }
                    return t.status === filtro;
                });
            }
            
            // Ordenar por data (mais recente primeiro)
            transferenciasFiltradas.sort((a, b) => {
                return new Date(b.data || b.created_at) - new Date(a.data || a.created_at);
            });
            
            // Atualizar lista
            atualizarListaTransferencias();
        }
        
        function getNomeFiltro(filtro) {
            const mapeamento = {
                'all': 'todas',
                'pending': 'pendentes',
                'processing': 'processando',
                'completed': 'concluidas',
                'rejected': 'recusadas'
            };
            return mapeamento[filtro];
        }
        
        function atualizarEstatisticas(transferencias) {
            const estatisticas = document.getElementById('estatisticas');
            
            const total = transferencias.length;
            const pendentes = transferencias.filter(t => 
                t.status === 'pending' || t.status === 'solicitada'
            ).length;
            const processando = transferencias.filter(t => 
                t.status === 'processing'
            ).length;
            const concluidas = transferencias.filter(t => 
                t.status === 'completed'
            ).length;
            const recusadas = transferencias.filter(t => 
                t.status === 'rejected'
            ).length;
            
            const totalValor = transferencias.reduce((sum, t) => {
                return sum + (parseFloat(t.valor) || 0);
            }, 0);
            
            estatisticas.innerHTML = `
                <div class="card-estatistica">
                    <div class="numero" style="color: var(--cor-primaria);">${total}</div>
                    <div class="label">Total de Transfer√™ncias</div>
                </div>
                <div class="card-estatistica">
                    <div class="numero" style="color: var(--cor-aviso);">${pendentes}</div>
                    <div class="label">Pendentes</div>
                </div>
                <div class="card-estatistica">
                    <div class="numero" style="color: var(--cor-processando);">${processando}</div>
                    <div class="label">Processando</div>
                </div>
                <div class="card-estatistica">
                    <div class="numero" style="color: var(--cor-sucesso);">${concluidas}</div>
                    <div class="label">Conclu√≠das</div>
                </div>
                <div class="card-estatistica">
                    <div class="numero" style="color: var(--cor-erro);">${recusadas}</div>
                    <div class="label">Recusadas</div>
                </div>
                <div class="card-estatistica">
                    <div class="numero" style="color: var(--texto-destaque);">
                        ${formatarMoeda(totalValor, 'USD')}
                    </div>
                    <div class="label">Valor Total</div>
                </div>
            `;
        }
        
        function formatarMoeda(valor, moeda) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: moeda || 'USD'
            }).format(valor);
        }
        
        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dataString;
            }
        }
        
        function atualizarListaTransferencias() {
            const lista = document.getElementById('listaTransferencias');
            const mensagemVazia = document.getElementById('mensagemVazia');
            
            if (transferenciasFiltradas.length === 0) {
                lista.innerHTML = '';
                mensagemVazia.style.display = 'block';
                return;
            }
            
            mensagemVazia.style.display = 'none';
            
            let html = '';
            
            transferenciasFiltradas.forEach(transferencia => {
                const status = transferencia.status;
                const statusClass = getStatusClass(status);
                const statusText = getStatusText(status);
                const valorFormatado = formatarMoeda(transferencia.valor, transferencia.moeda);
                const dataFormatada = formatarData(transferencia.data || transferencia.created_at);
                
                // Verificar status da invoice
                const invoiceStatus = transferencia.invoice_status;
                const invoiceRecusada = transferencia.invoice_recusada;
                const temInvoice = transferencia.invoice;
                
                // Gerar HTML do card (IGUAL KIVY)
                html += `
                <div class="card-transferencia" data-id="${transferencia.id}">
                    <div class="card-header">
                        <div class="status-badge ${statusClass}">
                            <i class="fas ${getStatusIcon(status)}"></i>
                            ${statusText}
                        </div>
                        <div class="transferencia-id">#${transferencia.id}</div>
                    </div>
                    
                    <div class="card-content">
                        <div class="info-group">
                            <div class="info-label">Benefici√°rio</div>
                            <div class="info-value">${transferencia.beneficiario || 'N/A'}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">Banco</div>
                            <div class="info-value">${transferencia.nome_banco || 'N/A'}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">Pa√≠s</div>
                            <div class="info-value">${transferencia.pais || 'N/A'}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">Valor</div>
                            <div class="info-value valor-destaque">${valorFormatado}</div>
                        </div>
                    </div>
                    
                    ${temInvoice ? criarLinhaInvoice(invoiceStatus, invoiceRecusada, transferencia.id) : ''}
                    
                    <div class="card-footer">
                        <div class="data-transferencia">
                            <i class="far fa-calendar"></i>
                            ${dataFormatada}
                        </div>
                        
                        <div class="botoes-acao">
                            <button class="btn-acao btn-detalhes" onclick="mostrarDetalhes('${transferencia.id}')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                            
                            ${temInvoice ? `
                            <button class="btn-acao btn-invoice" onclick="visualizarInvoice('${transferencia.id}')">
                                <i class="fas fa-file-invoice"></i> Invoice
                            </button>
                            ` : ''}
                            
                            <button class="btn-acao btn-pdf" onclick="gerarPDF('${transferencia.id}')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        function criarLinhaInvoice(status, recusada, transferenciaId) {
            let statusClass = 'pending';
            let statusIcon = 'fa-clock';
            let statusText = 'Pendente';
            let showButton = false;
            
            if (status === 'approved') {
                statusClass = 'approved';
                statusIcon = 'fa-check-circle';
                statusText = 'Aprovada';
            } else if (status === 'rejected' || recusada) {
                statusClass = 'rejected';
                statusIcon = 'fa-times-circle';
                statusText = 'Recusada';
                showButton = true;
            }
            
            return `
            <div class="invoice-line">
                <div class="invoice-status ${statusClass}">
                    <i class="fas ${statusIcon}"></i>
                    <strong>Invoice:</strong> ${statusText}
                    ${recusada && transferencia.motivo_recusa ? 
                        `<span style="margin-left: 10px; font-size: 11px; opacity: 0.8;">
                            Motivo: ${transferencia.motivo_recusa}
                        </span>` : ''}
                </div>
                ${showButton ? `
                <button class="btn-renviar-invoice" onclick="reenviarInvoice('${transferenciaId}')">
                    <i class="fas fa-redo"></i> Reenviar
                </button>
                ` : ''}
            </div>
            `;
        }

        function getStatusClass(status) {
            if (status === 'pending' || status === 'solicitada') {
                return 'status-pending';
            } else if (status === 'processing') {
                return 'status-processing';
            } else if (status === 'completed') {
                return 'status-completed';
            } else if (status === 'rejected') {
                return 'status-rejected';
            }
            return 'status-pending';
        }

        function getStatusText(status) {
            if (status === 'pending' || status === 'solicitada') {
                return 'PENDENTE';
            } else if (status === 'processing') {
                return 'PROCESSANDO';
            } else if (status === 'completed') {
                return 'CONCLU√çDA';
            } else if (status === 'rejected') {
                return 'RECUSADA';
            }
            return status.toUpperCase();
        }

        function getStatusIcon(status) {
            if (status === 'pending' || status === 'solicitada') {
                return 'fa-clock';
            } else if (status === 'processing') {
                return 'fa-sync-alt';
            } else if (status === 'completed') {
                return 'fa-check-circle';
            } else if (status === 'rejected') {
                return 'fa-times-circle';
            }
            return 'fa-question-circle';
        }

        // MODAL DE DETALHES
        function mostrarDetalhes(transferenciaId) {
            const transferencia = todasTransferencias.find(t => t.id === transferenciaId);
            if (!transferencia) return;
            
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="modal-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Informa√ß√µes B√°sicas
                    </h3>
                    <div class="info-grid">
                        <div class="info-group">
                            <div class="info-label">ID</div>
                            <div class="info-value">${transferencia.id}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Status</div>
                            <div class="info-value ${getStatusClass(transferencia.status)}" style="display: inline-block; padding: 4px 8px; border-radius: 4px;">
                                ${getStatusText(transferencia.status)}
                            </div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Tipo</div>
                            <div class="info-value">${transferencia.tipo === 'transferencia_internacional' ? 'INTERNACIONAL' : 'INTERNA'}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Valor</div>
                            <div class="info-value valor-destaque">${formatarMoeda(transferencia.valor, transferencia.moeda)}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Data Solicita√ß√£o</div>
                            <div class="info-value">${formatarData(transferencia.data || transferencia.created_at)}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Conta Remetente</div>
                            <div class="info-value">${transferencia.conta_remetente || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3 class="section-title">
                        <i class="fas fa-user-tie"></i>
                        Benefici√°rio
                    </h3>
                    <div class="info-grid">
                        <div class="info-group">
                            <div class="info-label">Nome</div>
                            <div class="info-value">${transferencia.beneficiario || 'N/A'}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Pa√≠s</div>
                            <div class="info-value">${transferencia.pais || 'N/A'}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Finalidade</div>
                            <div class="info-value">${transferencia.finalidade || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3 class="section-title">
                        <i class="fas fa-university"></i>
                        Informa√ß√µes Banc√°rias
                    </h3>
                    <div class="info-grid">
                        <div class="info-group">
                            <div class="info-label">Banco</div>
                            <div class="info-value">${transferencia.nome_banco || 'N/A'}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">C√≥digo SWIFT</div>
                            <div class="info-value">${transferencia.codigo_swift || 'N/A'}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">IBAN/Conta</div>
                            <div class="info-value">${transferencia.iban_account || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                ${transferencia.motivo_recusa ? `
                <div class="modal-section">
                    <h3 class="section-title" style="color: var(--cor-erro);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Motivo da Recusa
                    </h3>
                    <div style="background: rgba(179, 51, 51, 0.1); padding: 15px; border-radius: var(--raio-borda-pequeno);">
                        ${transferencia.motivo_recusa}
                    </div>
                </div>
                ` : ''}
                
                ${transferencia.invoice ? `
                <div class="modal-section">
                    <h3 class="section-title">
                        <i class="fas fa-file-invoice"></i>
                        Status da Invoice
                    </h3>
                    <div class="info-grid">
                        <div class="info-group">
                            <div class="info-label">Status</div>
                            <div class="info-value invoice-status ${transferencia.invoice_status || 'pending'}">
                                ${transferencia.invoice_status === 'approved' ? 'APROVADA' : 
                                transferencia.invoice_status === 'rejected' ? 'RECUSADA' : 'PENDENTE'}
                            </div>
                        </div>
                        ${transferencia.invoice_recusada && transferencia.motivo_recusa ? `
                        <div class="info-group">
                            <div class="info-label">Motivo Recusa</div>
                            <div class="info-value">${transferencia.motivo_recusa}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // FECHAR MODAL CLICANDO FORA
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModal();
            }
        });

        // FUN√á√ïES DE A√á√ÉO
        function visualizarInvoice(transferenciaId) {
            alert(`Visualizar invoice da transfer√™ncia ${transferenciaId}\n(Integra√ß√£o com Supabase Storage)`);
            // Implementar: Baixar invoice do Supabase Storage e abrir
        }

        function gerarPDF(transferenciaId) {
            alert(`Gerar PDF da transfer√™ncia ${transferenciaId}`);
            // Implementar: Gerar PDF com dados da transfer√™ncia
        }

        async function reenviarInvoice(transferenciaId) {
            const transferencia = todasTransferencias.find(t => t.id === transferenciaId);
            if (!transferencia) return;
            
            // MODAL PARA REENVIAR INVOICE (IGUAL KIVY)
            const modalHTML = `
            <div style="padding: 20px; max-width: 500px;">
                <h3 style="color: var(--cor-primaria); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-redo"></i> Reenviar Invoice
                </h3>
                
                ${transferencia.motivo_recusa ? `
                <div style="background: rgba(179, 51, 51, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Motivo da recusa anterior:</strong><br>
                    ${transferencia.motivo_recusa}
                </div>
                ` : ''}
                
                <div style="border: 2px dashed var(--cor-primaria); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 20px; cursor: pointer;"
                    onclick="document.getElementById('fileInput').click()"
                    id="dropArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--cor-primaria); margin-bottom: 15px;"></i>
                    <h4 style="margin-bottom: 10px;">SOLTE O NOVO INVOICE AQUI</h4>
                    <p style="color: var(--texto-secundario); margin-bottom: 10px;">ou clique para procurar</p>
                    <p style="font-size: 12px; color: var(--texto-secundario);">
                        üìÑ PDF, JPG, PNG (at√© 5MB)
                    </p>
                </div>
                
                <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                
                <div id="fileInfo" style="display: none; margin-bottom: 20px; padding: 10px; background: var(--fundo-input); border-radius: 8px;">
                    <!-- Informa√ß√µes do arquivo ser√£o mostradas aqui -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="fecharModalUpload()" 
                            style="flex: 1; padding: 12px; background: var(--cor-erro-escura); color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Cancelar
                    </button>
                    <button onclick="enviarNovaInvoice('${transferenciaId}')" 
                            style="flex: 1; padding: 12px; background: var(--cor-sucesso); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fas fa-paper-plane"></i> Enviar Nova Invoice
                    </button>
                </div>
            </div>
            `;
            
            // Criar modal tempor√°rio
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'modalUpload';
            modal.innerHTML = modalHTML;
            document.body.appendChild(modal);
            
            // Configurar eventos do modal
            const fileInput = document.getElementById('fileInput');
            const dropArea = document.getElementById('dropArea');
            let arquivoSelecionado = null;
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    processarArquivo(e.target.files[0]);
                }
            });
            
            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.borderColor = 'var(--cor-sucesso)';
                dropArea.style.background = 'rgba(26, 138, 26, 0.1)';
            }
            
            function unhighlight() {
                dropArea.style.borderColor = 'var(--cor-primaria)';
                dropArea.style.background = 'transparent';
            }
            
            dropArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    processarArquivo(files[0]);
                }
            });
            
            function processarArquivo(file) {
                // Validar tamanho (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Arquivo muito grande! M√°ximo 5MB.');
                    return;
                }
                
                // Validar extens√£o
                const extensoesValidas = ['.pdf', '.jpg', '.jpeg', '.png'];
                const nomeArquivo = file.name.toLowerCase();
                const extensaoValida = extensoesValidas.some(ext => nomeArquivo.endsWith(ext));
                
                if (!extensaoValida) {
                    alert('Tipo de arquivo n√£o suportado! Use PDF, JPG ou PNG.');
                    return;
                }
                
                arquivoSelecionado = file;
                
                // Mostrar informa√ß√µes do arquivo
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-file" style="font-size: 24px; color: var(--cor-primaria);"></i>
                        <div>
                            <strong>${file.name}</strong><br>
                            <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                        </div>
                        <div style="margin-left: auto; color: var(--cor-sucesso);">
                            <i class="fas fa-check-circle"></i> Pronto para enviar
                        </div>
                    </div>
                `;
                fileInfo.style.display = 'block';
                
                // Atualizar √°rea de drop
                dropArea.innerHTML = `
                    <i class="fas fa-check-circle" style="font-size: 48px; color: var(--cor-sucesso); margin-bottom: 15px;"></i>
                    <h4 style="margin-bottom: 10px; color: var(--cor-sucesso);">‚úÖ PRONTO!</h4>
                    <p style="color: var(--texto-secundario);">${file.name}</p>
                    <p style="font-size: 12px; color: var(--texto-secundario);">
                        (${(file.size / 1024 / 1024).toFixed(2)} MB)
                    </p>
                `;
            }
        }

        function fecharModalUpload() {
            const modal = document.getElementById('modalUpload');
            if (modal) {
                modal.remove();
            }
        }

        async function enviarNovaInvoice(transferenciaId) {
            // Implementar upload para Supabase Storage (mesma l√≥gica do Kivy)
            alert(`Upload da nova invoice para transfer√™ncia ${transferenciaId}\n(Integra√ß√£o com Supabase Storage)`);
            
            // Fechar modal ap√≥s upload
            fecharModalUpload();
            
            // Recarregar dados ap√≥s upload
            setTimeout(() => {
                carregarTransferencias();
            }, 1000);
        }

        // UTILIT√ÅRIOS
        function mostrarLoading(mostrar) {
            document.getElementById('loading').style.display = mostrar ? 'flex' : 'none';
        }

        function mostrarErro(mensagem) {
            alert('Erro: ' + mensagem);
        }

        // ATUALIZAR A CADA 30 SEGUNDOS
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                carregarTransferencias();
            }
        }, 30000);

        // EXPORTAR FUN√á√ïES GLOBAIS
        window.filtrarTransferencias = filtrarTransferencias;
        window.mostrarDetalhes = mostrarDetalhes;
        window.fecharModal = fecharModal;
        window.visualizarInvoice = visualizarInvoice;
        window.gerarPDF = gerarPDF;
        window.reenviarInvoice = reenviarInvoice;
        window.fecharModalUpload = fecharModalUpload;
        window.enviarNovaInvoice = enviarNovaInvoice;
    </script>
</body>
</html>