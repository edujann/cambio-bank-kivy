<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Transfer√™ncias | Cambio Bank</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    /* ============================================
       VARI√ÅVEIS CSS (EXATAMENTE IGUAL AO DASHBOARD)
    ============================================ */
    :root {
        /* PALETA DE CORES DO SEU KIVY/DASHBOARD */
        --cor-fundo: #0a0e15;
        --cor-card: #0d1117;
        --cor-borda: #1e232e;
        --cor-texto: #e0e0e0;
        --cor-texto-secundario: #8b949e;
        --cor-primaria: #1a5fb4;
        --cor-sucesso: #2ec27e;
        --cor-alerta: #f39c12;
        --cor-perigo: #e01b24;
        --roxo: #9b59b6;
        
        /* SOMBRAS (IGUAL DASHBOARD) */
        --sombra-suave: 0 4px 6px rgba(0, 0, 0, 0.3);
        --sombra-media: 0 8px 16px rgba(0, 0, 0, 0.4);
        --sombra-forte: 0 12px 24px rgba(0, 0, 0, 0.5);
        
        /* BORDAS (IGUAL DASHBOARD) */
        --borda-radius: 12px;
        --borda-radius-pequeno: 8px;
    }

    /* ============================================
       RESET E CONFIGURA√á√ïES GERAIS
    ============================================ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: #070b12;  /* MAIS ESCURO QUE O DASHBOARD */
        color: var(--cor-texto);
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    /* ============================================
       CONTAINER PRINCIPAL
    ============================================ */
    .app-container {
        background: var(--cor-fundo);  /* #0a0e15 */
        min-height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
    }

    /* ============================================
       CABE√áALHO (EXATAMENTE IGUAL AO DASHBOARD)
    ============================================ */
    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        background: var(--cor-card);
        border-bottom: 1px solid var(--cor-borda);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 24px;
        font-weight: bold;
    }

    .logo i {
        color: var(--cor-primaria);
        font-size: 28px;
    }

    .logo-text {
        background: linear-gradient(90deg, var(--cor-primaria), #2d8fff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .user-menu {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: var(--cor-card);
        border-radius: var(--borda-radius-pequeno);
        border: 1px solid var(--cor-borda);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .user-menu:hover {
        border-color: var(--cor-primaria);
        transform: translateY(-2px);
    }

    .user-avatar {
        font-size: 24px;
        color: var(--cor-primaria);
    }

    .user-name {
        font-weight: 600;
    }

    .btn-voltar-dashboard {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        border-radius: var(--borda-radius-pequeno);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-voltar-dashboard:hover {
        border-color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
        transform: translateY(-1px);
    }

    /* ============================================
       CONTE√öDO PRINCIPAL
    ============================================ */
    .main-content {
        padding: 30px;
    }

    /* ============================================
       T√çTULO DA P√ÅGINA (ESTILO DASHBOARD)
    ============================================ */
    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px 0;
    }

    .page-title {
        font-size: 28px;
        margin-bottom: 10px;
        color: var(--cor-texto);
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center;
    }

    .page-title i {
        color: var(--cor-primaria);
    }

    .page-subtitle {
        color: var(--cor-texto-secundario);
        font-size: 16px;
        margin: 0;
    }

    /* ============================================
       FILTROS R√ÅPIDOS (ESTILO DASHBOARD)
    ============================================ */
    .filtros-container {
        margin-bottom: 30px;
    }

    .filtros-title {
        font-size: 14px;
        color: var(--cor-texto-secundario);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filtros-rapidos {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-filtro {
        padding: 10px 20px;
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius-pequeno);
        background: transparent;
        color: var(--cor-texto);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-filtro:hover {
        border-color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
    }

    .btn-filtro.ativo {
        background: var(--cor-primaria);
        color: white;
        border-color: var(--cor-primaria);
    }

    #btn-pendentes.ativo {
        background: var(--cor-alerta);
        border-color: var(--cor-alerta);
    }

    #btn-processando.ativo {
        background: var(--cor-primaria);
        border-color: var(--cor-primaria);
    }

    #btn-concluidas.ativo {
        background: var(--cor-sucesso);
        border-color: var(--cor-sucesso);
    }

    #btn-recusadas.ativo {
        background: var(--cor-perigo);
        border-color: var(--cor-perigo);
    }

    /* ============================================
       CARDS DE TRANSFER√äNCIA (COM EFEITOS DASHBOARD)
    ============================================ */
    .transferencias-container {
        margin-bottom: 40px;
    }

    .card-transferencia {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius);
        padding: 25px;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        box-shadow: var(--sombra-suave);
    }

    /* LINHA SUPERIOR COLORIDA (status) */
    .card-transferencia::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--cor-primaria), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* CORES POR STATUS NA LINHA SUPERIOR */
    .card-transferencia[data-status="pending"]::before,
    .card-transferencia[data-status="pendente"]::before {
        background: linear-gradient(90deg, var(--cor-alerta), transparent);
    }

    .card-transferencia[data-status="processing"]::before,
    .card-transferencia[data-status="processando"]::before {
        background: linear-gradient(90deg, var(--cor-primaria), transparent);
    }

    .card-transferencia[data-status="completed"]::before,
    .card-transferencia[data-status="concluida"]::before {
        background: linear-gradient(90deg, var(--cor-sucesso), transparent);
    }

    .card-transferencia[data-status="rejected"]::before,
    .card-transferencia[data-status="recusada"]::before {
        background: linear-gradient(90deg, var(--cor-perigo), transparent);
    }

    /* EFEITO HOVER IGUAL AOS CARDS DO DASHBOARD */
    .card-transferencia:hover {
        border-color: var(--cor-primaria);
        transform: translateY(-5px);
        box-shadow: var(--sombra-forte);
    }

    .card-transferencia:hover::before {
        opacity: 1;
    }

    /* BORDA COM GRADIENTE NO HOVER */
    .card-transferencia::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: calc(var(--borda-radius) + 2px);
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-primaria) 50%,
            transparent 100%
        );
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card-transferencia:hover::after {
        opacity: 0.3;
    }

    /* GRADIENTE ESPEC√çFICO POR STATUS NO HOVER */
    .card-transferencia[data-status="pending"]:hover::after,
    .card-transferencia[data-status="pendente"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-alerta) 50%,
            transparent 100%
        );
    }

    .card-transferencia[data-status="processing"]:hover::after,
    .card-transferencia[data-status="processando"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-primaria) 50%,
            transparent 100%
        );
    }

    .card-transferencia[data-status="completed"]:hover::after,
    .card-transferencia[data-status="concluida"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-sucesso) 50%,
            transparent 100%
        );
    }

    .card-transferencia[data-status="rejected"]:hover::after,
    .card-transferencia[data-status="recusada"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-perigo) 50%,
            transparent 100%
        );
    }

    /* ============================================
       HEADER DO CARD
    ============================================ */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--cor-borda);
        position: relative;
    }

    /* BADGE DE STATUS (IGUAL DASHBOARD) */
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }

    .card-transferencia:hover .status-badge {
        transform: scale(1.05);
    }

    /* CORES DOS STATUS */
    .status-pending {
        background: rgba(243, 156, 18, 0.15);
        color: var(--cor-alerta);
        border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .status-processing {
        background: rgba(26, 95, 180, 0.15);
        color: var(--cor-primaria);
        border: 1px solid rgba(26, 95, 180, 0.3);
    }

    .status-completed {
        background: rgba(46, 194, 126, 0.15);
        color: var(--cor-sucesso);
        border: 1px solid rgba(46, 194, 126, 0.3);
    }

    .status-rejected {
        background: rgba(224, 27, 36, 0.15);
        color: var(--cor-perigo);
        border: 1px solid rgba(224, 27, 36, 0.3);
    }

    .transferencia-id {
        font-size: 12px;
        color: var(--cor-texto-secundario);
        font-family: monospace;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px 8px;
        border-radius: 4px;
    }

    /* ============================================
       CONTE√öDO DO CARD
    ============================================ */
    .card-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .info-label {
        font-size: 11px;
        color: var(--cor-texto-secundario);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--cor-texto);
    }

    .valor-destaque {
        font-size: 20px;
        font-weight: bold;
        color: var(--cor-texto);
    }

    /* ============================================
       LINHA DA INVOICE
    ============================================ */
    .invoice-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--borda-radius-pequeno);
        border: 1px solid var(--cor-borda);
    }

    .invoice-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 500;
    }

    .invoice-status.pending { 
        color: var(--cor-alerta);
    }
    
    .invoice-status.approved { 
        color: var(--cor-sucesso);
    }
    
    .invoice-status.rejected { 
        color: var(--cor-perigo);
    }

    .btn-renviar-invoice {
        padding: 6px 12px;
        background: transparent;
        border: 1px solid var(--cor-sucesso);
        color: var(--cor-sucesso);
        border-radius: var(--borda-radius-pequeno);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
    }

    .btn-renviar-invoice:hover {
        background: rgba(46, 194, 126, 0.1);
        transform: translateY(-1px);
    }

    /* ============================================
       FOOTER DO CARD
    ============================================ */
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }

    .data-transferencia {
        font-size: 12px;
        color: var(--cor-texto-secundario);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* ============================================
       BOT√ïES DE A√á√ÉO
    ============================================ */
    .botoes-acao {
        display: flex;
        gap: 10px;
    }

    .btn-acao {
        padding: 8px 16px;
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius-pequeno);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
        background: transparent;
        color: var(--cor-texto);
    }

    .btn-detalhes:hover {
        border-color: var(--cor-primaria);
        color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
    }

    .btn-invoice:hover {
        border-color: var(--cor-sucesso);
        color: var(--cor-sucesso);
        background: rgba(46, 194, 126, 0.1);
    }

    .btn-pdf:hover {
        border-color: var(--roxo);
        color: var(--roxo);
        background: rgba(155, 89, 182, 0.1);
    }

    /* ============================================
       BOT√ÉO CARREGAR MAIS
    ============================================ */
    .btn-carregar-mais {
        background: linear-gradient(135deg, var(--cor-primaria), #2d8fff);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: var(--borda-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(26, 95, 180, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
        margin: 30px auto;
        display: block;
    }

    .btn-carregar-mais:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(26, 95, 180, 0.4);
    }

    .btn-carregar-mais i {
        font-size: 18px;
    }

    .btn-carregar-mais small {
        font-size: 12px;
        opacity: 0.8;
        font-weight: normal;
        display: block;
        margin-top: 4px;
    }

    /* ============================================
       MENSAGEM VAZIA
    ============================================ */
    .mensagem-vazia {
        text-align: center;
        padding: 60px 20px;
        color: var(--cor-texto-secundario);
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius);
    }

    .mensagem-vazia i {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    /* ============================================
       LOADING
    ============================================ */
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--cor-texto-secundario);
    }

    .loading i {
        font-size: 24px;
        margin-bottom: 10px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ============================================
       FOOTER (IGUAL AO DASHBOARD)
    ============================================ */
    .app-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
    }

    .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--cor-texto-secundario);
        font-size: 14px;
    }

    .footer-links {
        display: flex;
        gap: 20px;
    }

    .footer-links a {
        color: var(--cor-texto-secundario);
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .footer-links a:hover {
        color: var(--cor-primaria);
    }

    .status-online {
        color: var(--cor-sucesso);
        font-weight: 600;
    }

    /* ============================================
       RESPONSIVIDADE
    ============================================ */
    @media (max-width: 768px) {
        .app-container {
            padding: 10px;
        }
        
        .app-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .filtros-rapidos {
            justify-content: center;
        }
        
        .card-content {
            grid-template-columns: 1fr;
        }
        
        .card-footer {
            flex-direction: column;
            gap: 15px;
        }
        
        .botoes-acao {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .footer-content {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .footer-links {
            justify-content: center;
        }
    }

    /* ============================================
       UTILITIES
    ============================================ */
    .hidden {
        display: none !important;
    }

    .text-center {
        text-align: center;
    }

    /* ============================================
    BOT√ÉO ATUALIZAR NO HEADER
    ============================================ */
    .btn-atualizar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        border-radius: var(--borda-radius-pequeno);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-atualizar:hover {
        border-color: var(--cor-sucesso);
        color: var(--cor-sucesso);
        background: rgba(46, 194, 126, 0.1);
        transform: translateY(-1px);
    }

    .btn-atualizar.animando i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ============================================
    BOT√ÉO ATUALIZAR (FIX FINAL - N√ÉO APAGUE NADA!)
    ============================================ */
    #btnAtualizar.btn-atualizar {
        /* GARANTIR VISIBILIDADE */
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        
        /* LAYOUT */
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 20px;
        
        /* CORES DASHBOARD */
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        border-radius: var(--borda-radius-pequeno);
        
        /* TEXTO */
        font-weight: 500;
        font-size: 14px;
        font-family: inherit;
        
        /* DIMENS√ïES */
        width: auto;
        height: auto;
        min-width: 100px;
        min-height: 40px;
        white-space: nowrap;
        
        /* INTERA√á√ÉO */
        cursor: pointer;
        transition: all 0.3s ease;
    }

    /* HOVER EFFECT */
    #btnAtualizar.btn-atualizar:hover {
        border-color: var(--cor-sucesso);
        color: var(--cor-sucesso);
        background: rgba(46, 194, 126, 0.1);
        transform: translateY(-1px);
    }

    /* ANIMA√á√ÉO DE LOADING */
    #btnAtualizar.btn-atualizar.animando i {
        animation: spin 1s linear infinite;
    }

    /* GARANTIR QUE N√ÉO FICA ESCONDIDO */
    #btnAtualizar:not(.hidden) {
        display: flex !important;
    }

    </style>
</head>
<body>
<div class="app-container">
    
    <!-- CABE√áALHO -->
    <header class="app-header">
        <div class="logo">
            <i class="fas fa-university"></i>
            <span class="logo-text">Cambio Bank</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 20px;">
            <!-- BOT√ÉO ATUALIZAR -->
            <button class="btn-atualizar" id="btnAtualizar" title="Atualizar lista">
                <i class="fas fa-sync-alt"></i>
                Atualizar
            </button>
            
            <!-- BOT√ÉO VOLTAR -->
            <a href="/dashboard" class="btn-voltar-dashboard">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Dashboard
            </a>
            
            <!-- USU√ÅRIO -->
            <div class="user-menu">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-name" id="userName">Carregando...</div>
            </div>
        </div>
    </header>
    
    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main-content">
        <!-- T√çTULO -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-exchange-alt"></i>
                MINHAS TRANSFER√äNCIAS
            </h1>
            <p class="page-subtitle">Gerencie e acompanhe todas as suas transfer√™ncias internacionais</p>
        </div>
        
        <!-- FILTROS -->
        <div class="filtros-container">
            <div class="filtros-title">
                <i class="fas fa-filter"></i> Filtrar por Status:
            </div>
            <div class="filtros-rapidos">
                <button class="btn-filtro ativo" id="btn-todas" onclick="filtrarTransferencias('all')">
                    <i class="fas fa-layer-group"></i> Todas
                </button>
                <button class="btn-filtro" id="btn-pendentes" onclick="filtrarTransferencias('pending')">
                    <i class="fas fa-clock"></i> Pendentes
                </button>
                <button class="btn-filtro" id="btn-processando" onclick="filtrarTransferencias('processing')">
                    <i class="fas fa-sync-alt"></i> Processando
                </button>
                <button class="btn-filtro" id="btn-concluidas" onclick="filtrarTransferencias('completed')">
                    <i class="fas fa-check-circle"></i> Conclu√≠das
                </button>
                <button class="btn-filtro" id="btn-recusadas" onclick="filtrarTransferencias('rejected')">
                    <i class="fas fa-times-circle"></i> Recusadas
                </button>
            </div>
        </div>
        
        <!-- LISTA DE TRANSFER√äNCIAS -->
        <div class="transferencias-container">
            <div id="listaTransferencias">
                <!-- Loading inicial -->
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando transfer√™ncias...</p>
                </div>
            </div>
            
            <!-- Mensagem vazia -->
            <div id="mensagemVazia" class="mensagem-vazia hidden">
                <i class="fas fa-inbox"></i>
                <h3>Nenhuma transfer√™ncia encontrada</h3>
                <p>Voc√™ ainda n√£o realizou transfer√™ncias internacionais.</p>
                <a href="/transferencia" class="btn-voltar-dashboard" style="margin-top: 20px;">
                    <i class="fas fa-plus"></i> Nova Transfer√™ncia
                </a>
            </div>
            
            <!-- Bot√£o Carregar Mais -->
            <div id="carregarMaisContainer" class="hidden"></div>
        </div>
    </main>
    
    <!-- FOOTER -->
    <footer class="app-footer">
        <div class="footer-content">
            <div class="footer-copyright">
                ¬© 2024 Cambio Bank ‚Ä¢ Sistema de C√¢mbio Internacional
            </div>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Seguran√ßa</a>
                <a href="#"><i class="fas fa-question-circle"></i> Ajuda</a>
                <a href="#"><i class="fas fa-envelope"></i> Contato</a>
            </div>
            <div class="footer-version">
                v2.1.0 ‚Ä¢ <span class="status-online">‚óè Online</span>
            </div>
        </div>
    </footer>
</div>

<!-- JAVASCRIPT -->
<script>

    // ============================================
    // FUN√á√ïES GLOBAIS DE UTILIDADE
    // ============================================
    
    function showAlert(mensagem, tipo = 'info') {
        // Cria um alerta tempor√°rio
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            animation: fadeInOut 3s ease-in-out;
        `;
        
        const cores = {
            'success': '#2ec27e',
            'error': '#e01b24',
            'info': '#1a5fb4',
            'warning': '#f39c12'
        };
        
        alertDiv.style.backgroundColor = cores[tipo] || cores.info;
        alertDiv.textContent = mensagem;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
    
    // Adicionar CSS para anima√ß√£o
    if (!document.querySelector('#alert-animation-style')) {
        const style = document.createElement('style');
        style.id = 'alert-animation-style';
        style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        `;
        document.head.appendChild(style);
    }

    // DADOS GLOBAIS
    let todasTransferencias = [];
    let transferenciasFiltradas = [];
    let filtroAtual = 'all';
    
    // VARI√ÅVEIS DE PAGINA√á√ÉO
    let limiteAtual = 10;
    const limitePorPagina = 10;
    
    // INICIAR CARREGAMENTO
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ P√°gina Minhas Transfer√™ncias carregada');
        carregarUsuario();
        carregarTransferencias();
    });
    
    // CARREGAR USU√ÅRIO
    async function carregarUsuario() {
        try {
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = window.USER?.nome || 'Usu√°rio';
            }
        } catch (error) {
            console.log('Erro ao carregar usu√°rio:', error);
        }
    }
    
    // CARREGAR TRANSFER√äNCIAS
    async function carregarTransferencias() {
        try {
            // Limpar loading
            document.getElementById('listaTransferencias').innerHTML = '';
            
            const response = await fetch('/api/transferencias-internacionais');
            if (response.ok) {
                const data = await response.json();
                console.log(`‚úÖ ${data.length} transfer√™ncias carregadas`);
                
                todasTransferencias = data;
                filtrarTransferencias('all');
                
                // Configurar auto-atualiza√ß√£o (1 minuto)
                //setInterval(() => {
                //    if (document.visibilityState === 'visible') {
                //        carregarTransferencias();
                //    }
                //}, 60000);
                
            } else {
                console.error('‚ùå Erro ao carregar transfer√™ncias:', response.status);
                mostrarErro('Erro ao carregar transfer√™ncias');
            }
        } catch (error) {
            console.error('‚ùå Erro de rede:', error);
            mostrarErro('Erro de conex√£o');
        }
    }
    
    // ADICIONE esta fun√ß√£o para o bot√£o atualizar:
    function setupAtualizacaoManual() {
        const btnAtualizar = document.getElementById('btnAtualizar');
        let estaAtualizando = false;
        
        if (btnAtualizar) {
            btnAtualizar.addEventListener('click', async function() {
                if (estaAtualizando) return;
                
                // Mostrar anima√ß√£o
                estaAtualizando = true;
                btnAtualizar.classList.add('animando');
                btnAtualizar.disabled = true;
                
                try {
                    await carregarTransferencias();
                    
                    // Mostrar feedback visual
                    btnAtualizar.innerHTML = '<i class="fas fa-check"></i> Atualizado!';
                    btnAtualizar.style.borderColor = 'var(--cor-sucesso)';
                    btnAtualizar.style.color = 'var(--cor-sucesso)';
                    
                    setTimeout(() => {
                        btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                        btnAtualizar.style.borderColor = '';
                        btnAtualizar.style.color = '';
                        btnAtualizar.classList.remove('animando');
                        btnAtualizar.disabled = false;
                        estaAtualizando = false;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Erro ao atualizar:', error);
                    
                    // Mostrar erro
                    btnAtualizar.innerHTML = '<i class="fas fa-times"></i> Erro';
                    btnAtualizar.style.borderColor = 'var(--cor-perigo)';
                    btnAtualizar.style.color = 'var(--cor-perigo)';
                    
                    setTimeout(() => {
                        btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                        btnAtualizar.style.borderColor = '';
                        btnAtualizar.style.color = '';
                        btnAtualizar.classList.remove('animando');
                        btnAtualizar.disabled = false;
                        estaAtualizando = false;
                    }, 2000);
                }
            });
        }
    }

    // NO DOMContentLoaded, adicione:
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ P√°gina Minhas Transfer√™ncias carregada');
        carregarUsuario();
        carregarTransferencias();
        setupAtualizacaoManual();  // <-- ADICIONE ESTA LINHA
    });

    // FILTRAR TRANSFER√äNCIAS
    function filtrarTransferencias(filtro) {
        filtroAtual = filtro;
        
        // Atualizar bot√µes ativos
        document.querySelectorAll('.btn-filtro').forEach(btn => {
            btn.classList.remove('ativo');
        });
        
        document.getElementById(`btn-${getNomeFiltro(filtro)}`).classList.add('ativo');
        
        // Aplicar filtro
        if (filtro === 'all') {
            transferenciasFiltradas = [...todasTransferencias];
        } else {
            transferenciasFiltradas = todasTransferencias.filter(t => {
                if (filtro === 'pending') {
                    return t.status === 'pending' || t.status === 'pendente' || t.status === 'solicitada';
                }
                if (filtro === 'processing') {
                    return t.status === 'processing' || t.status === 'processando';
                }
                if (filtro === 'completed') {
                    return t.status === 'completed' || t.status === 'concluida' || t.status === 'aprovada';
                }
                if (filtro === 'rejected') {
                    return t.status === 'rejected' || t.status === 'recusada';
                }
                return t.status === filtro;
            });
        }
        
        // Ordenar por data (mais recente primeiro)
        transferenciasFiltradas.sort((a, b) => {
            return new Date(b.data || b.created_at) - new Date(a.data || a.created_at);
        });
        
        // Resetar limite ao filtrar
        limiteAtual = 10;
        
        // Atualizar lista
        atualizarListaTransferencias();
    }
    
    // ATUALIZAR LISTA
    function atualizarListaTransferencias() {
        const lista = document.getElementById('listaTransferencias');
        const mensagemVazia = document.getElementById('mensagemVazia');
        
        if (transferenciasFiltradas.length === 0) {
            lista.innerHTML = '';
            mensagemVazia.classList.remove('hidden');
            return;
        }
        
        mensagemVazia.classList.add('hidden');
        
        // PEGAR APENAS AS PRIMEIRAS X TRANSFER√äNCIAS
        const transferenciasParaExibir = transferenciasFiltradas.slice(0, limiteAtual);
        
        let html = '';
        
        transferenciasParaExibir.forEach(transferencia => {
            const status = transferencia.status;
            const statusClass = getStatusClass(status);
            const statusText = getStatusText(status);
            const valorFormatado = formatarMoeda(transferencia.valor, transferencia.moeda);
            const dataFormatada = formatarData(transferencia.data || transferencia.created_at);
            
            // Verificar status da invoice
            const invoiceStatus = transferencia.invoice_status || 'pending';
            const invoiceRecusada = transferencia.invoice_recusada || false;
            const temInvoice = transferencia.invoice || transferencia.invoice_status;
            
            // STATUS PARA O DATA-ATTRIBUTE (corre√ß√£o aqui)
            const dataStatus = getDataStatus(status);
            
            // Gerar HTML do card
            html += `
            <div class="card-transferencia" data-id="${transferencia.id}" data-status="${dataStatus}">
                <div class="card-header">
                    <div class="status-badge ${statusClass}">
                        <i class="fas ${getStatusIcon(status)}"></i>
                        ${statusText}
                    </div>
                    <div class="transferencia-id">#${transferencia.id}</div>
                </div>
                
                <div class="card-content">
                    <div class="info-group">
                        <div class="info-label">Benefici√°rio</div>
                        <div class="info-value">${transferencia.beneficiario || 'N/A'}</div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">Banco</div>
                        <div class="info-value">${transferencia.nome_banco || 'N/A'}</div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">Pa√≠s</div>
                        <div class="info-value">${transferencia.pais || 'N/A'}</div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">Valor</div>
                        <div class="info-value valor-destaque">${valorFormatado}</div>
                    </div>
                </div>
                
                ${temInvoice ? criarLinhaInvoice(invoiceStatus, invoiceRecusada, transferencia.id) : ''}
                
                <div class="card-footer">
                    <div class="data-transferencia">
                        <i class="far fa-calendar"></i>
                        ${dataFormatada}
                    </div>
                    
                    <div class="botoes-acao">
                        <button class="btn-acao btn-detalhes" onclick="mostrarDetalhes('${transferencia.id}')">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                        
                        ${temInvoice ? `
                        <button class="btn-acao btn-invoice" onclick="visualizarInvoice('${transferencia.id}')">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </button>
                        ` : ''}
                        
                        <button class="btn-acao btn-pdf" onclick="gerarPDF('${transferencia.id}')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
            </div>
            `;
        });
        
        // ADICIONAR BOT√ÉO "CARREGAR MAIS" SE HOUVER MAIS TRANSFER√äNCIAS
        if (transferenciasFiltradas.length > limiteAtual) {
            const restantes = transferenciasFiltradas.length - limiteAtual;
            const proximaLimite = Math.min(restantes, limitePorPagina);
            
            html += `
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="carregarMais()" class="btn-carregar-mais">
                    <i class="fas fa-plus-circle"></i> Carregar mais ${proximaLimite} transfer√™ncias
                    <br><small>(${restantes} restantes no total)</small>
                </button>
            </div>
            `;
        }
        
        lista.innerHTML = html;
    }
    
    // FUN√á√ÉO CARREGAR MAIS
    function carregarMais() {
        limiteAtual += limitePorPagina;
        atualizarListaTransferencias();
    }
    
    // FUN√á√ïES AUXILIARES
    function getStatusClass(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'status-pending';
            case 'processing':
            case 'processando':
                return 'status-processing';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'status-completed';
            case 'rejected':
            case 'recusada':
                return 'status-rejected';
            default:
                return 'status-pending';
        }
    }
    
    function getDataStatus(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'pending';
            case 'processing':
            case 'processando':
                return 'processing';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'completed';
            case 'rejected':
            case 'recusada':
                return 'rejected';
            default:
                return 'pending';
        }
    }
    
    function getStatusText(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'Pendente';
            case 'processing':
            case 'processando':
                return 'Processando';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'Conclu√≠da';
            case 'rejected':
            case 'recusada':
                return 'Recusada';
            default:
                return status;
        }
    }
    
    function getStatusIcon(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'fa-clock';
            case 'processing':
            case 'processando':
                return 'fa-sync-alt';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'fa-check-circle';
            case 'rejected':
            case 'recusada':
                return 'fa-times-circle';
            default:
                return 'fa-clock';
        }
    }
    
    function getNomeFiltro(filtro) {
        switch (filtro) {
            case 'all': return 'todas';
            case 'pending': return 'pendentes';
            case 'processing': return 'processando';
            case 'completed': return 'concluidas';
            case 'rejected': return 'recusadas';
            default: return 'todas';
        }
    }
    
    // FUN√á√ÉO CRIAR LINHA INVOICE (CORRIGIDA)
    function criarLinhaInvoice(status, recusada, transferenciaId) {
        let statusClass = 'pending';
        let statusIcon = 'fa-clock';
        let statusText = 'Pendente';
        let showButton = false;
        
        if (status === 'approved') {
            statusClass = 'approved';
            statusIcon = 'fa-check-circle';
            statusText = 'Aprovada';
        } else if (status === 'rejected' || recusada) {
            statusClass = 'rejected';
            statusIcon = 'fa-times-circle';
            statusText = 'Recusada';
            showButton = true;
        }
        
        return `
        <div class="invoice-line">
            <div class="invoice-status ${statusClass}">
                <i class="fas ${statusIcon}"></i>
                <strong>Invoice:</strong> ${statusText}
            </div>
            ${showButton ? `
            <button class="btn-renviar-invoice" onclick="reenviarInvoice('${transferenciaId}')">
                <i class="fas fa-redo"></i> Reenviar
            </button>
            ` : ''}
        </div>
        `;
    }
    
    function formatarMoeda(valor, moeda) {
        if (!valor) return '--';
        const simbolos = {
            'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'BRL': 'R$'
        };
        const simbolo = simbolos[moeda] || moeda;
        return `${simbolo} ${parseFloat(valor).toFixed(2)}`;
    }
    
    function formatarData(dataString) {
        if (!dataString) return '--';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
    }
    
    function mostrarErro(mensagem) {
        const lista = document.getElementById('listaTransferencias');
        lista.innerHTML = `
            <div class="mensagem-vazia">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>${mensagem}</h3>
                <button onclick="carregarTransferencias()" class="btn-voltar-dashboard" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Tentar Novamente
                </button>
            </div>
        `;
    }
    
    // FUN√á√ïES DE A√á√ÉO (placeholder)
    function mostrarDetalhes(id) {
        alert('Detalhes da transfer√™ncia ' + id);
    }
    
    function visualizarInvoice(id) {
        alert('Visualizar invoice ' + id);
    }
    
    // ============================================
    // PDF GENERATOR ID√äNTICO AO KIVY
    // ============================================

    class PDFGeneratorKivyStyle {
        constructor() {
            this.mmToPt = 0.3528;
        }
        
        async gerarComprovanteKivy(transferencia) {
            console.log('üé® Gerando PDF estilo Kivy para:', transferencia.id);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            try {
                // 1. CABE√áALHO (mant√©m como est√°)
                this._adicionarCabecalhoKivy(doc, pageWidth, pageHeight, transferencia);
                
                // 2. DADOS DA TRANSFER√äNCIA (use a fun√ß√£o compacta CORRETA)
                let yPos = this._adicionarDadosTransferenciaKivy(doc, pageWidth, transferencia);
                
                // 3. BENEFICI√ÅRIO (use a fun√ß√£o compacta)
                yPos = this._adicionarBeneficiarioCompacto(doc, pageWidth, yPos, transferencia);
                
                // 4. INFORMA√á√ïES BANC√ÅRIAS (use a fun√ß√£o com layout corrigido)
                yPos = this._adicionarInfoBancariaCorrigido(doc, pageWidth, yPos, transferencia);
                
                // 5. SWIFT PAYMENT DETAILS (use a fun√ß√£o compacta)
                const status = this._getStatusNormalizado(transferencia.status);
                if (status === 'COMPLETED' && transferencia.dados_swift_pagamento && 
                    Object.keys(transferencia.dados_swift_pagamento).length > 0) {
                    yPos = this._adicionarSwiftDetailsCompacto(doc, pageWidth, yPos, transferencia.dados_swift_pagamento);
                }
                
                // 6. RODAP√â (use a fun√ß√£o compacta)
                this._adicionarRodapeCompacto(doc, pageWidth, pageHeight, yPos, transferencia);
                
                // 7. SALVAR
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const nomeArquivo = `comprovante_${transferencia.id}_${timestamp}.pdf`;
                doc.save(nomeArquivo);
                
                console.log('‚úÖ PDF Kivy gerado com sucesso!');
                return nomeArquivo;
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF Kivy:', error);
                return null;
            }
        }
        
        _adicionarCabecalhoKivy(doc, width, height, transferencia) {
            // CABE√áALHO AZUL MARINHO ESCURO (0.08, 0.18, 0.32)
            const azulEscuro = [20, 46, 82]; // #142E52 - RGB(20, 46, 82)
            doc.setFillColor(...azulEscuro);
            doc.rect(0, 0, width, 28, 'F'); // Ret√¢ngulo azul
            
            // LOGO EM BRANCO
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('C√ÇMBIO BANK', 15, 15);
            
            // SUBT√çTULO
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Wire Transfer Receipt', 15, 21);
            
            // ID DA TRANSFER√äNCIA (AMARELO)
            doc.setTextColor(230, 230, 0); // Amarelo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const idText = `ID: ${transferencia.id}`;
            const idWidth = doc.getTextWidth(idText);
            doc.text(idText, width - 15 - idWidth, 15);
            
            // DATA (CINZA CLARO)
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(8);
            const dataAtual = new Date().toLocaleString('pt-BR');
            const dataText = dataAtual;
            const dataWidth = doc.getTextWidth(dataText);
            doc.text(dataText, width - 15 - dataWidth, 22);
            
            // LINHA DIVIS√ìRIA FINA
            doc.setDrawColor(100, 100, 100);
            doc.setLineWidth(0.3);
            doc.line(10, 30, width - 10, 30);
        }
        
        _adicionarDadosTransferenciaKivy(doc, width, dados) {
            let yPos = 36;
            
            // STATUS
            const status = this._getStatusNormalizado(dados.status);
            const statusColors = {
                'PENDING': [255, 165, 0],
                'PROCESSING': [64, 115, 217],
                'COMPLETED': [38, 150, 38],
                'REJECTED': [178, 51, 51]
            };
            
            const color = statusColors[status] || [100, 100, 100];
            
            const statusWidth = doc.getTextWidth(status) + 16;
            doc.setFillColor(...color);
            doc.roundedRect(15, yPos, statusWidth, 8, 1.5, 1.5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(status, 15 + (statusWidth - doc.getTextWidth(status)) / 2, yPos + 5.2);
            
            yPos += 14;
            
            // TRANSFER AMOUNT
            doc.setFillColor(247, 247, 247);
            doc.roundedRect(15, yPos, width - 30, 14, 3, 3, 'F');
            
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(15, yPos, width - 30, 14, 3, 3, 'S');
            
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('TRANSFER AMOUNT', 20, yPos + 5.5);
            
            const valorTexto = `${parseFloat(dados.valor || 0).toFixed(2)} ${dados.moeda || 'USD'}`;
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(valorTexto, width / 2, yPos + 10.5, { align: 'center' });
            
            yPos += 20;
            
            // INFORMA√á√ïES GERAIS
            const col1X = 18;
            const col2X = width / 2 + 12;
            
            const formatarData = (dataString) => {
                if (!dataString) return 'N/A';
                try {
                    const data = new Date(dataString);
                    const dia = data.getDate().toString().padStart(2, '0');
                    const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                    const ano = data.getFullYear();
                    const horas = data.getHours().toString().padStart(2, '0');
                    const minutos = data.getMinutes().toString().padStart(2, '0');
                    const segundos = data.getSeconds().toString().padStart(2, '0');
                    return `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;
                } catch {
                    return dataString;
                }
            };
            
            const dataFormatada = formatarData(dados.data || dados.created_at);
            
            // Coluna 1
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Request Date:', col1X, yPos);
            
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(dataFormatada, col1X, yPos + 4.5);
            
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('Type:', col1X, yPos + 10);
            
            const tipoTexto = dados.tipo === 'transferencia_internacional' ? 'International' : 'Internal';
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.text(tipoTexto, col1X, yPos + 14.5);
            
            // Coluna 2
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('Purpose:', col2X, yPos);
            
            const finalidade = dados.finalidade || 'Not informed';
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            
            if (finalidade.length > 25) {
                const palavras = finalidade.split(' ');
                let linha1 = '';
                let linha2 = '';
                
                for (const palavra of palavras) {
                    if ((linha1 + ' ' + palavra).length <= 25) {
                        linha1 += (linha1 ? ' ' : '') + palavra;
                    } else if ((linha2 + ' ' + palavra).length <= 25) {
                        linha2 += (linha2 ? ' ' : '') + palavra;
                    } else {
                        linha2 += '...';
                        break;
                    }
                }
                
                doc.text(linha1, col2X, yPos + 4.5);
                if (linha2) {
                    doc.text(linha2, col2X, yPos + 9);
                    yPos += 5;
                }
            } else {
                doc.text(finalidade, col2X, yPos + 4.5);
            }
            
            if (status === 'COMPLETED' && dados.data_conclusao) {
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('Completed Date:', col2X, yPos + 10);
                
                const dataConclusaoFormatada = formatarData(dados.data_conclusao);
                doc.setTextColor(20, 46, 82);
                doc.setFont('helvetica', 'bold');
                doc.text(dataConclusaoFormatada, col2X, yPos + 14.5);
                yPos += 8;
            }
            
            return yPos + 14;
        }

        _adicionarBeneficiarioCompacto(doc, width, yPos, dados) {
            const boxHeight = 40;
            
            doc.setFillColor(250, 250, 250);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'F');
            
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'S');
            
            // T√çTULO (FONTE 10, SUBLINHADO 0.6)
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('BENEFICIARY DETAILS', 20, yPos + 8);
            
            doc.setDrawColor(20, 46, 82);
            doc.setLineWidth(0.6); // üî• SUBLINHADO MAIS FINO
            const textWidth1 = doc.getTextWidth('BENEFICIARY DETAILS');
            doc.line(20, yPos + 10.5, 20 + textWidth1, yPos + 10.5);
            
            const col1X = 25;
            const col2X = width / 2 + 15;
            let contentY = yPos + 18;
            
            // NOME (FONTE 8)
            doc.setTextColor(120, 120, 120);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
            doc.text('Name:', col1X, contentY);

            doc.setTextColor(20, 20, 20);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
            const nome = dados.beneficiario || 'N/A';

            let nomeHeight = 0;
            if (nome.length > 35) {
                doc.text(nome.substring(0, 35), col1X, contentY + 3.5);
                doc.text(nome.substring(35, 70), col1X, contentY + 7);
                nomeHeight = 10;
            } else {
                doc.text(nome, col1X, contentY + 3.5);
                nomeHeight = 6;
            }

            contentY += nomeHeight;
            contentY += 4;

            // ENDERE√áO (FONTE 8)
            if (dados.endereco_beneficiario) {
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                doc.text('Address:', col1X, contentY);
                
                doc.setTextColor(20, 20, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                const endereco = dados.endereco_beneficiario;
                
                if (endereco.length > 35) {
                    doc.text(endereco.substring(0, 35), col1X, contentY + 3.5);
                    doc.text(endereco.substring(35, 70), col1X, contentY + 7);
                    contentY += 10;
                } else {
                    doc.text(endereco, col1X, contentY + 3.5);
                    contentY += 6;
                }
            }
            
            // CIDADE (FONTE 8)
            if (dados.cidade) {
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                doc.text('City:', col2X, yPos + 18);
                
                doc.setTextColor(20, 20, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                doc.text(dados.cidade, col2X, yPos + 21.5);
            }
            
            // PA√çS (FONTE 8)
            if (dados.pais) {
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                doc.text('Country:', col2X, yPos + 28);
                
                doc.setTextColor(20, 20, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                doc.text(dados.pais, col2X, yPos + 31.5);
            }
            
            return yPos + boxHeight + 6;
        }

        _adicionarInfoBancariaCorrigido(doc, width, yPos, dados) {
            if (dados.tipo === 'transferencia_internacional') {
                const boxHeight = 50;
                
                doc.setFillColor(250, 250, 250);
                doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'F');
                
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'S');
                
                // T√çTULO (FONTE 10, SUBLINHADO 0.6)
                doc.setTextColor(20, 46, 82);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('BANKING INFORMATION', 20, yPos + 8);
                
                doc.setDrawColor(20, 46, 82);
                doc.setLineWidth(0.6); // üî• SUBLINHADO MAIS FINO
                const textWidth2 = doc.getTextWidth('BANKING INFORMATION');
                doc.line(20, yPos + 10.5, 20 + textWidth2, yPos + 10.5);
                
                const col1X = 25;
                const col2X = width / 2 + 15;
                let yEsquerda = yPos + 18;
                let yDireita = yPos + 18;
                
                // Beneficiary Bank (FONTE 8)
                if (dados.nome_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('Beneficiary Bank:', col1X, yEsquerda);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    const banco = dados.nome_banco;
                    
                    if (banco.length > 30) {
                        doc.text(banco.substring(0, 30), col1X, yEsquerda + 4);
                        doc.text(banco.substring(30, 60), col1X, yEsquerda + 8);
                        yEsquerda += 12;
                    } else {
                        doc.text(banco, col1X, yEsquerda + 4);
                        yEsquerda += 10;
                    }
                }
                
                // Bank Address (FONTE 8)
                if (dados.endereco_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('Bank Address:', col1X, yEsquerda);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    const endereco = dados.endereco_banco;
                    
                    if (endereco.length > 30) {
                        doc.text(endereco.substring(0, 30), col1X, yEsquerda + 4);
                        doc.text(endereco.substring(30, 60), col1X, yEsquerda + 8);
                        yEsquerda += 12;
                    } else {
                        doc.text(endereco, col1X, yEsquerda + 4);
                        yEsquerda += 10;
                    }
                }
                
                // Bank City (FONTE 8)
                if (dados.cidade_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('Bank City:', col1X, yEsquerda);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text(dados.cidade_banco, col1X, yEsquerda + 4);
                    yEsquerda += 10;
                }
                
                // SWIFT/BIC Code (FONTE 8)
                if (dados.codigo_swift) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('SWIFT/BIC Code:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text(dados.codigo_swift, col2X, yDireita + 4);
                    yDireita += 10;
                }
                
                // IBAN/Account (FONTE 8)
                if (dados.iban_account) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('IBAN/Account:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    const iban = dados.iban_account;
                    
                    if (iban.length > 25) {
                        doc.text(iban.substring(0, 25), col2X, yDireita + 4);
                        doc.text(iban.substring(25, 50), col2X, yDireita + 8);
                        yDireita += 12;
                    } else {
                        doc.text(iban, col2X, yDireita + 4);
                        yDireita += 10;
                    }
                }
                
                // Bank Country (FONTE 8)
                if (dados.pais_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('Bank Country:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text(dados.pais_banco, col2X, yDireita + 4);
                    yDireita += 10;
                }
                
                if (dados.aba_routing) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text('ABA/Routing Code:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text(dados.aba_routing, col2X, yDireita + 4);
                    yDireita += 10;
                }
                
                return yPos + boxHeight + 4;
            }
            
            return yPos;
        }

        _adicionarSwiftDetailsCompacto(doc, width, yPos, dadosSwift) {
            if (!dadosSwift || Object.keys(dadosSwift).length === 0) {
                return yPos;
            }
            
            const boxHeight = 60;
            
            doc.setFillColor(250, 250, 250);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'F');
            
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'S');
            
            // T√çTULO (FONTE 10, SUBLINHADO 0.6)
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('SWIFT PAYMENT DETAILS', 20, yPos + 7);
            
            doc.setDrawColor(20, 46, 82);
            doc.setLineWidth(0.6); // üî• SUBLINHADO MAIS FINO
            const textWidth3 = doc.getTextWidth('SWIFT PAYMENT DETAILS');
            doc.line(20, yPos + 9.5, 20 + textWidth3, yPos + 9.5);
            
            const xPos = 25;
            const valorXPos = 42;
            let yContent = yPos + 16;
            
            // üî• FONTE 8 (PADR√ÉO COM OS OUTROS)
            doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
            
            const adicionarLinhaSwift = (rotulo, valor, chave) => {
                if (dadosSwift[chave] && dadosSwift[chave].trim()) {
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(120, 120, 120);
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    doc.text(rotulo, xPos, yContent);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(20, 20, 20);
                    doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                    
                    const valorTexto = dadosSwift[chave];
                    if (valorTexto.length > 55) {
                        doc.text(valorTexto.substring(0, 55), valorXPos, yContent);
                        yContent += 4.5;
                        doc.text(valorTexto.substring(55, 110), valorXPos, yContent);
                        yContent += 4.5;
                    } else {
                        doc.text(valorTexto, valorXPos, yContent);
                        yContent += 4.5;
                    }
                }
            };
            
            adicionarLinhaSwift('UETR#:', dadosSwift.linha1_uetr, 'linha1_uetr');
            adicionarLinhaSwift(':20:', dadosSwift.linha2_20, 'linha2_20');
            adicionarLinhaSwift(':32A:', dadosSwift.linha3_32a, 'linha3_32a');
            adicionarLinhaSwift(':50K:', dadosSwift.linha4_50k, 'linha4_50k');
            adicionarLinhaSwift(':57A:', dadosSwift.linha5_57a, 'linha5_57a');
            adicionarLinhaSwift(':59:', dadosSwift.linha6_59, 'linha6_59');
            
            if (dadosSwift.linha7_beneficiario && dadosSwift.linha7_beneficiario.trim()) {
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(120, 120, 120);
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                doc.text('Benef.:', xPos, yContent);
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(20, 20, 20);
                doc.setFontSize(8); // üî• ALTERADO: 7 ‚Üí 8
                const benef = dadosSwift.linha7_beneficiario;
                
                if (benef.length > 55) {
                    doc.text(benef.substring(0, 55), valorXPos, yContent);
                    yContent += 4.5;
                    
                    if (benef.length > 110) {
                        doc.text(benef.substring(55, 110), valorXPos, yContent);
                        yContent += 4.5;
                        doc.text(benef.substring(110, 165) + '...', valorXPos, yContent);
                        yContent += 4.5;
                    } else {
                        doc.text(benef.substring(55), valorXPos, yContent);
                        yContent += 4.5;
                    }
                } else {
                    doc.text(benef, valorXPos, yContent);
                    yContent += 4.5;
                }
            }
            
            adicionarLinhaSwift(':70:', dadosSwift.linha8_70, 'linha8_70');
            adicionarLinhaSwift(':71A:', dadosSwift.linha9_71a, 'linha9_71a');
            
            return yPos + boxHeight + 3;
        }
        
        _adicionarRodapeCompacto(doc, width, height, currentYPos, dados) {
            // üî• CALCULAR POSI√á√ÉO DO RODAP√â (MAIS PR√ìXIMO DO CONTE√öDO)
            const minSpace = 15; // Espa√ßo m√≠nimo abaixo do rodap√©
            const footerY = Math.min(currentYPos + 12, height - minSpace); // üî• REDUZIDO ESPA√áO ACIMA
            
            // LINHA DIVIS√ìRIA
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(10, footerY, width - 10, footerY);
            
            // CAIXA DE STATUS FINAL (COMPACTADA)
            doc.setFillColor(247, 247, 247);
            doc.roundedRect(10, footerY + 4, width - 20, 10, 1, 1, 'F'); // üî• ALTURA REDUZIDA
            
            // Borda fina
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(10, footerY + 4, width - 20, 10, 1, 1, 'S');
            
            // STATUS
            const status = this._getStatusNormalizado(dados.status);
            const statusColors = {
                'PENDING': [255, 165, 0],
                'PROCESSING': [64, 115, 217],
                'COMPLETED': [38, 150, 38],
                'REJECTED': [178, 51, 51]
            };
            
            const color = statusColors[status] || [100, 100, 100];
            
            // "STATUS:" (compactado)
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8); // üî• FONTE REDUZIDA
            doc.text('STATUS:', 15, footerY + 9.5);
            
            // STATUS COLORIDO
            doc.setTextColor(...color);
            doc.text(status, 15 + doc.getTextWidth('STATUS: '), footerY + 9.5);
            
            // INFORMA√á√ïES INSTITUCIONAIS (compactadas)
            doc.setTextColor(120, 120, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5); // üî• FONTE REDUZIDA
            doc.text('C√¢mbio Bank - International Transfers', 15, footerY + 17);
            doc.text('Automatically generated document', 15, footerY + 22);
            
            // DATA DE EMISS√ÉO (compactada)
            const dataEmissao = new Date().toLocaleString('pt-BR');
            doc.text(`Issued: ${dataEmissao}`, width - 15 - doc.getTextWidth(`Issued: ${dataEmissao}`), footerY + 17);
            doc.text('Page 1 of 1', width - 15 - doc.getTextWidth('Page 1 of 1'), footerY + 22);
        }

        _formatarDataParaDisplay(dataString) {
            if (!dataString) return 'N/A';
            
            try {
                const data = new Date(dataString);
                
                // Verificar se √© uma data v√°lida
                if (isNaN(data.getTime())) {
                    return 'N/A';
                }
                
                // Formato: "10/12/2025 20:20:01" (DD/MM/YYYY HH:MM:SS)
                const dia = data.getDate().toString().padStart(2, '0');
                const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                const ano = data.getFullYear();
                const horas = data.getHours().toString().padStart(2, '0');
                const minutos = data.getMinutes().toString().padStart(2, '0');
                const segundos = data.getSeconds().toString().padStart(2, '0');
                
                return `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao formatar data:', dataString, error);
                return dataString || 'N/A';
            }
        }
        
        _getStatusNormalizado(status) {
            const statusMap = {
                'solicitada': 'PENDING',
                'pendente': 'PENDING',
                'pending': 'PENDING',
                'processando': 'PROCESSING',
                'processing': 'PROCESSING',
                'concluida': 'COMPLETED',
                'completed': 'COMPLETED',
                'aprovada': 'COMPLETED',
                'recusada': 'REJECTED',
                'rejected': 'REJECTED'
            };
            
            const statusLower = (status || '').toLowerCase();
            return statusMap[statusLower] || 'PENDING';
        }
        
        _formatarData(dataString) {
            if (!dataString) return 'N/A';
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR');
        }
    }

    // ============================================
    // ATUALIZAR FUN√á√ÉO gerarPDF
    // ============================================

    async function gerarPDF(transferenciaId) {
        console.log(`üìÑ GERANDO PDF KIVY PARA: ${transferenciaId}`);
        
        try {
            showAlert('Generating PDF...', 'info');
            
            // üî• USAR O ENDPOINT QUE J√Å FUNCIONA com par√¢metro
            const response = await fetch(`/api/transferencias-internacionais?id=${transferenciaId}`);
            
            if (!response.ok) {
                throw new Error('Erro ao buscar dados da transfer√™ncia');
            }
            
            const data = await response.json();
            
            // üî• CORRE√á√ÉO: Verificar se retornou um array ou objeto direto
            let transferencia;
            
            if (Array.isArray(data)) {
                // Buscar a transfer√™ncia espec√≠fica no array
                transferencia = data.find(t => 
                    t.id === transferenciaId || 
                    t.id.toString() === transferenciaId.toString()
                );
                
                if (!transferencia) {
                    throw new Error(`Transfer√™ncia ${transferenciaId} n√£o encontrada na lista`);
                }
            } else {
                // Se for objeto direto (quando usa ?id=)
                transferencia = data;
            }
            
            if (transferencia.error) {
                throw new Error(transferencia.error);
            }
            
            console.log('‚úÖ Dados carregados:', transferencia);
            console.log('üîç Status:', transferencia.status);
            console.log('üîç Tem SWIFT?', transferencia.dados_swift_pagamento ? '‚úÖ SIM' : '‚ùå N√ÉO');
            
            // Garantir que jsPDF est√° carregado
            if (typeof window.jspdf === 'undefined') {
                console.log('üì¶ Carregando jsPDF...');
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                console.log('‚úÖ jsPDF carregado');
            }
            
            // Criar gerador
            const gerador = new PDFGeneratorKivyStyle();
            await gerador.gerarComprovanteKivy(transferencia);
            
            showAlert('PDF gerado com sucesso! Verifique seus downloads.', 'success');
            
        } catch (error) {
            console.error('‚ùå Erro ao gerar PDF:', error);
            showAlert(`Erro: ${error.message}`, 'error');
        }
    }

    // ============================================
    // FUN√á√ÉO showAlert (se n√£o existir)
    // ============================================

    function showAlert(mensagem, tipo = 'info') {
        // Cria um alerta tempor√°rio
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            animation: fadeInOut 3s ease-in-out;
        `;
        
        const cores = {
            'success': '#2ec27e',
            'error': '#e01b24',
            'info': '#1a5fb4',
            'warning': '#f39c12'
        };
        
        alertDiv.style.backgroundColor = cores[tipo] || cores.info;
        alertDiv.textContent = mensagem;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    // Adicione este CSS para a anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-20px); }
        15% { opacity: 1; transform: translateY(0); }
        85% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }
    `;
    document.head.appendChild(style);
    
    function reenviarInvoice(id) {
        alert('Reenviar invoice ' + id);
    }
</script>

<!-- DADOS DO FLASK -->
<script>
    // Dados do usu√°rio logado (do Flask)
    window.USER = { 
        username: "{{ usuario if usuario else '' }}", 
        nome: "{{ nome if nome else 'Usu√°rio' }}", 
        email: "{{ email if email else 'usuario@exemplo.com' }}"
    };
    window.API_URL = "";
</script>
</body>
</html>