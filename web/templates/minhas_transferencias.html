<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Transfer√™ncias | Cambio Bank</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    /* ============================================
       VARI√ÅVEIS CSS (EXATAMENTE IGUAL AO DASHBOARD)
    ============================================ */
    :root {
        /* PALETA DE CORES DO SEU KIVY/DASHBOARD */
        --cor-fundo: #0a0e15;
        --cor-card: #0d1117;
        --cor-borda: #1e232e;
        --cor-texto: #e0e0e0;
        --cor-texto-secundario: #8b949e;
        --cor-primaria: #1a5fb4;
        --cor-sucesso: #2ec27e;
        --cor-alerta: #f39c12;
        --cor-perigo: #e01b24;
        --roxo: #9b59b6;
        
        /* SOMBRAS (IGUAL DASHBOARD) */
        --sombra-suave: 0 4px 6px rgba(0, 0, 0, 0.3);
        --sombra-media: 0 8px 16px rgba(0, 0, 0, 0.4);
        --sombra-forte: 0 12px 24px rgba(0, 0, 0, 0.5);
        
        /* BORDAS (IGUAL DASHBOARD) */
        --borda-radius: 12px;
        --borda-radius-pequeno: 8px;
    }

    /* ============================================
       RESET E CONFIGURA√á√ïES GERAIS
    ============================================ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: #070b12;  /* MAIS ESCURO QUE O DASHBOARD */
        color: var(--cor-texto);
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    /* ============================================
       CONTAINER PRINCIPAL
    ============================================ */
    .app-container {
        background: var(--cor-fundo);  /* #0a0e15 */
        min-height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
    }

    /* ============================================
       CABE√áALHO (EXATAMENTE IGUAL AO DASHBOARD)
    ============================================ */
    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        background: var(--cor-card);
        border-bottom: 1px solid var(--cor-borda);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 24px;
        font-weight: bold;
    }

    .logo i {
        color: var(--cor-primaria);
        font-size: 28px;
    }

    .logo-text {
        background: linear-gradient(90deg, var(--cor-primaria), #2d8fff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .user-menu {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: var(--cor-card);
        border-radius: var(--borda-radius-pequeno);
        border: 1px solid var(--cor-borda);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .user-menu:hover {
        border-color: var(--cor-primaria);
        transform: translateY(-2px);
    }

    .user-avatar {
        font-size: 24px;
        color: var(--cor-primaria);
    }

    .user-name {
        font-weight: 600;
    }

    .btn-voltar-dashboard {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        border-radius: var(--borda-radius-pequeno);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-voltar-dashboard:hover {
        border-color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
        transform: translateY(-1px);
    }

    /* ============================================
       CONTE√öDO PRINCIPAL
    ============================================ */
    .main-content {
        padding: 30px;
    }

    /* ============================================
       T√çTULO DA P√ÅGINA (ESTILO DASHBOARD)
    ============================================ */
    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px 0;
    }

    .page-title {
        font-size: 28px;
        margin-bottom: 10px;
        color: var(--cor-texto);
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center;
    }

    .page-title i {
        color: var(--cor-primaria);
    }

    .page-subtitle {
        color: var(--cor-texto-secundario);
        font-size: 16px;
        margin: 0;
    }

    /* ============================================
       FILTROS R√ÅPIDOS (ESTILO DASHBOARD)
    ============================================ */
    .filtros-container {
        margin-bottom: 30px;
    }

    .filtros-title {
        font-size: 14px;
        color: var(--cor-texto-secundario);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filtros-rapidos {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-filtro {
        padding: 10px 20px;
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius-pequeno);
        background: transparent;
        color: var(--cor-texto);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-filtro:hover {
        border-color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
    }

    .btn-filtro.ativo {
        background: var(--cor-primaria);
        color: white;
        border-color: var(--cor-primaria);
    }

    #btn-pendentes.ativo {
        background: var(--cor-alerta);
        border-color: var(--cor-alerta);
    }

    #btn-processando.ativo {
        background: var(--cor-primaria);
        border-color: var(--cor-primaria);
    }

    #btn-concluidas.ativo {
        background: var(--cor-sucesso);
        border-color: var(--cor-sucesso);
    }

    #btn-recusadas.ativo {
        background: var(--cor-perigo);
        border-color: var(--cor-perigo);
    }

    /* ============================================
       CARDS DE TRANSFER√äNCIA (COM EFEITOS DASHBOARD)
    ============================================ */
    .transferencias-container {
        margin-bottom: 40px;
    }

    .card-transferencia {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius);
        padding: 25px;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        box-shadow: var(--sombra-suave);
    }

    /* LINHA SUPERIOR COLORIDA (status) */
    .card-transferencia::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--cor-primaria), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* CORES POR STATUS NA LINHA SUPERIOR */
    .card-transferencia[data-status="pending"]::before,
    .card-transferencia[data-status="pendente"]::before {
        background: linear-gradient(90deg, var(--cor-alerta), transparent);
    }

    .card-transferencia[data-status="processing"]::before,
    .card-transferencia[data-status="processando"]::before {
        background: linear-gradient(90deg, var(--cor-primaria), transparent);
    }

    .card-transferencia[data-status="completed"]::before,
    .card-transferencia[data-status="concluida"]::before {
        background: linear-gradient(90deg, var(--cor-sucesso), transparent);
    }

    .card-transferencia[data-status="rejected"]::before,
    .card-transferencia[data-status="recusada"]::before {
        background: linear-gradient(90deg, var(--cor-perigo), transparent);
    }

    /* EFEITO HOVER IGUAL AOS CARDS DO DASHBOARD */
    .card-transferencia:hover {
        border-color: var(--cor-primaria);
        transform: translateY(-5px);
        box-shadow: var(--sombra-forte);
    }

    .card-transferencia:hover::before {
        opacity: 1;
    }

    /* BORDA COM GRADIENTE NO HOVER */
    .card-transferencia::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: calc(var(--borda-radius) + 2px);
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-primaria) 50%,
            transparent 100%
        );
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card-transferencia:hover::after {
        opacity: 0.3;
    }

    /* GRADIENTE ESPEC√çFICO POR STATUS NO HOVER */
    .card-transferencia[data-status="pending"]:hover::after,
    .card-transferencia[data-status="pendente"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-alerta) 50%,
            transparent 100%
        );
    }

    .card-transferencia[data-status="processing"]:hover::after,
    .card-transferencia[data-status="processando"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-primaria) 50%,
            transparent 100%
        );
    }

    .card-transferencia[data-status="completed"]:hover::after,
    .card-transferencia[data-status="concluida"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-sucesso) 50%,
            transparent 100%
        );
    }

    .card-transferencia[data-status="rejected"]:hover::after,
    .card-transferencia[data-status="recusada"]:hover::after {
        background: linear-gradient(45deg, 
            transparent 0%,
            var(--cor-perigo) 50%,
            transparent 100%
        );
    }

    /* ============================================
       HEADER DO CARD
    ============================================ */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--cor-borda);
        position: relative;
    }

    /* BADGE DE STATUS (IGUAL DASHBOARD) */
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }

    .card-transferencia:hover .status-badge {
        transform: scale(1.05);
    }

    /* CORES DOS STATUS */
    .status-pending {
        background: rgba(243, 156, 18, 0.15);
        color: var(--cor-alerta);
        border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .status-processing {
        background: rgba(26, 95, 180, 0.15);
        color: var(--cor-primaria);
        border: 1px solid rgba(26, 95, 180, 0.3);
    }

    .status-completed {
        background: rgba(46, 194, 126, 0.15);
        color: var(--cor-sucesso);
        border: 1px solid rgba(46, 194, 126, 0.3);
    }

    .status-rejected {
        background: rgba(224, 27, 36, 0.15);
        color: var(--cor-perigo);
        border: 1px solid rgba(224, 27, 36, 0.3);
    }

    .transferencia-id {
        font-size: 12px;
        color: var(--cor-texto-secundario);
        font-family: monospace;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px 8px;
        border-radius: 4px;
    }

    /* ============================================
       CONTE√öDO DO CARD
    ============================================ */
    .card-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .info-label {
        font-size: 11px;
        color: var(--cor-texto-secundario);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--cor-texto);
    }

    .valor-destaque {
        font-size: 20px;
        font-weight: bold;
        color: var(--cor-texto);
    }

    /* ============================================
       LINHA DA INVOICE
    ============================================ */
    .invoice-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--borda-radius-pequeno);
        border: 1px solid var(--cor-borda);
    }

    .invoice-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 500;
    }

    .invoice-status.pending { 
        color: var(--cor-alerta);
    }
    
    .invoice-status.approved { 
        color: var(--cor-sucesso);
    }
    
    .invoice-status.rejected { 
        color: var(--cor-perigo);
    }

    .btn-renviar-invoice {
        padding: 6px 12px;
        background: transparent;
        border: 1px solid var(--cor-sucesso);
        color: var(--cor-sucesso);
        border-radius: var(--borda-radius-pequeno);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
    }

    .btn-renviar-invoice:hover {
        background: rgba(46, 194, 126, 0.1);
        transform: translateY(-1px);
    }

    /* ============================================
       FOOTER DO CARD
    ============================================ */
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }

    .data-transferencia {
        font-size: 12px;
        color: var(--cor-texto-secundario);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* ============================================
       BOT√ïES DE A√á√ÉO
    ============================================ */
    .botoes-acao {
        display: flex;
        gap: 10px;
    }

    .btn-acao {
        padding: 8px 16px;
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius-pequeno);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
        background: transparent;
        color: var(--cor-texto);
    }

    .btn-detalhes:hover {
        border-color: var(--cor-primaria);
        color: var(--cor-primaria);
        background: rgba(26, 95, 180, 0.1);
    }

    .btn-invoice:hover {
        border-color: var(--cor-sucesso);
        color: var(--cor-sucesso);
        background: rgba(46, 194, 126, 0.1);
    }

    .btn-pdf:hover {
        border-color: var(--roxo);
        color: var(--roxo);
        background: rgba(155, 89, 182, 0.1);
    }

    /* ============================================
       BOT√ÉO CARREGAR MAIS
    ============================================ */
    .btn-carregar-mais {
        background: linear-gradient(135deg, var(--cor-primaria), #2d8fff);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: var(--borda-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(26, 95, 180, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
        margin: 30px auto;
        display: block;
    }

    .btn-carregar-mais:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(26, 95, 180, 0.4);
    }

    .btn-carregar-mais i {
        font-size: 18px;
    }

    .btn-carregar-mais small {
        font-size: 12px;
        opacity: 0.8;
        font-weight: normal;
        display: block;
        margin-top: 4px;
    }

    /* ============================================
       MENSAGEM VAZIA
    ============================================ */
    .mensagem-vazia {
        text-align: center;
        padding: 60px 20px;
        color: var(--cor-texto-secundario);
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: var(--borda-radius);
    }

    .mensagem-vazia i {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    /* ============================================
       LOADING
    ============================================ */
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--cor-texto-secundario);
    }

    .loading i {
        font-size: 24px;
        margin-bottom: 10px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ============================================
       FOOTER (IGUAL AO DASHBOARD)
    ============================================ */
    .app-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
    }

    .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--cor-texto-secundario);
        font-size: 14px;
    }

    .footer-links {
        display: flex;
        gap: 20px;
    }

    .footer-links a {
        color: var(--cor-texto-secundario);
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .footer-links a:hover {
        color: var(--cor-primaria);
    }

    .status-online {
        color: var(--cor-sucesso);
        font-weight: 600;
    }

    /* ============================================
       RESPONSIVIDADE
    ============================================ */
    @media (max-width: 768px) {
        .app-container {
            padding: 10px;
        }
        
        .app-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .filtros-rapidos {
            justify-content: center;
        }
        
        .card-content {
            grid-template-columns: 1fr;
        }
        
        .card-footer {
            flex-direction: column;
            gap: 15px;
        }
        
        .botoes-acao {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .footer-content {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .footer-links {
            justify-content: center;
        }
    }

    /* ============================================
       UTILITIES
    ============================================ */
    .hidden {
        display: none !important;
    }

    .text-center {
        text-align: center;
    }

    /* ============================================
    BOT√ÉO ATUALIZAR NO HEADER
    ============================================ */
    .btn-atualizar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        border-radius: var(--borda-radius-pequeno);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-atualizar:hover {
        border-color: var(--cor-sucesso);
        color: var(--cor-sucesso);
        background: rgba(46, 194, 126, 0.1);
        transform: translateY(-1px);
    }

    .btn-atualizar.animando i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ============================================
    BOT√ÉO ATUALIZAR (FIX FINAL - N√ÉO APAGUE NADA!)
    ============================================ */
    #btnAtualizar.btn-atualizar {
        /* GARANTIR VISIBILIDADE */
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        
        /* LAYOUT */
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 20px;
        
        /* CORES DASHBOARD */
        background: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto);
        border-radius: var(--borda-radius-pequeno);
        
        /* TEXTO */
        font-weight: 500;
        font-size: 14px;
        font-family: inherit;
        
        /* DIMENS√ïES */
        width: auto;
        height: auto;
        min-width: 100px;
        min-height: 40px;
        white-space: nowrap;
        
        /* INTERA√á√ÉO */
        cursor: pointer;
        transition: all 0.3s ease;
    }

    /* HOVER EFFECT */
    #btnAtualizar.btn-atualizar:hover {
        border-color: var(--cor-sucesso);
        color: var(--cor-sucesso);
        background: rgba(46, 194, 126, 0.1);
        transform: translateY(-1px);
    }

    /* ANIMA√á√ÉO DE LOADING */
    #btnAtualizar.btn-atualizar.animando i {
        animation: spin 1s linear infinite;
    }

    /* GARANTIR QUE N√ÉO FICA ESCONDIDO */
    #btnAtualizar:not(.hidden) {
        display: flex !important;
    }

    </style>
</head>
<body>
<div class="app-container">
    
    <!-- CABE√áALHO -->
    <header class="app-header">
        <div class="logo">
            <i class="fas fa-university"></i>
            <span class="logo-text">Cambio Bank</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 20px;">
            <!-- BOT√ÉO ATUALIZAR -->
            <button class="btn-atualizar" id="btnAtualizar" title="Atualizar lista">
                <i class="fas fa-sync-alt"></i>
                Atualizar
            </button>
            
            <!-- BOT√ÉO VOLTAR -->
            <a href="/dashboard" class="btn-voltar-dashboard">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Dashboard
            </a>
            
            <!-- USU√ÅRIO -->
            <div class="user-menu">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-name" id="userName">Carregando...</div>
            </div>
        </div>
    </header>
    
    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main-content">
        <!-- T√çTULO -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-exchange-alt"></i>
                MINHAS TRANSFER√äNCIAS
            </h1>
            <p class="page-subtitle">Gerencie e acompanhe todas as suas transfer√™ncias internacionais</p>
        </div>
        
        <!-- FILTROS -->
        <div class="filtros-container">
            <div class="filtros-title">
                <i class="fas fa-filter"></i> Filtrar por Status:
            </div>
            <div class="filtros-rapidos">
                <button class="btn-filtro ativo" id="btn-todas" onclick="filtrarTransferencias('all')">
                    <i class="fas fa-layer-group"></i> Todas
                </button>
                <button class="btn-filtro" id="btn-pendentes" onclick="filtrarTransferencias('pending')">
                    <i class="fas fa-clock"></i> Pendentes
                </button>
                <button class="btn-filtro" id="btn-processando" onclick="filtrarTransferencias('processing')">
                    <i class="fas fa-sync-alt"></i> Processando
                </button>
                <button class="btn-filtro" id="btn-concluidas" onclick="filtrarTransferencias('completed')">
                    <i class="fas fa-check-circle"></i> Conclu√≠das
                </button>
                <button class="btn-filtro" id="btn-recusadas" onclick="filtrarTransferencias('rejected')">
                    <i class="fas fa-times-circle"></i> Recusadas
                </button>
            </div>
        </div>
        
        <!-- LISTA DE TRANSFER√äNCIAS -->
        <div class="transferencias-container">
            <div id="listaTransferencias">
                <!-- Loading inicial -->
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando transfer√™ncias...</p>
                </div>
            </div>
            
            <!-- Mensagem vazia -->
            <div id="mensagemVazia" class="mensagem-vazia hidden">
                <i class="fas fa-inbox"></i>
                <h3>Nenhuma transfer√™ncia encontrada</h3>
                <p>Voc√™ ainda n√£o realizou transfer√™ncias internacionais.</p>
                <a href="/transferencia" class="btn-voltar-dashboard" style="margin-top: 20px;">
                    <i class="fas fa-plus"></i> Nova Transfer√™ncia
                </a>
            </div>
            
            <!-- Bot√£o Carregar Mais -->
            <div id="carregarMaisContainer" class="hidden"></div>
        </div>
    </main>
    
    <!-- FOOTER -->
    <footer class="app-footer">
        <div class="footer-content">
            <div class="footer-copyright">
                ¬© 2024 Cambio Bank ‚Ä¢ Sistema de C√¢mbio Internacional
            </div>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Seguran√ßa</a>
                <a href="#"><i class="fas fa-question-circle"></i> Ajuda</a>
                <a href="#"><i class="fas fa-envelope"></i> Contato</a>
            </div>
            <div class="footer-version">
                v2.1.0 ‚Ä¢ <span class="status-online">‚óè Online</span>
            </div>
        </div>
    </footer>
</div>

<!-- JAVASCRIPT -->
<script>

    // ============================================
    // FUN√á√ïES GLOBAIS DE UTILIDADE
    // ============================================
    
    function showAlert(mensagem, tipo = 'info') {
        // Cria um alerta tempor√°rio
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            animation: fadeInOut 3s ease-in-out;
        `;
        
        const cores = {
            'success': '#2ec27e',
            'error': '#e01b24',
            'info': '#1a5fb4',
            'warning': '#f39c12'
        };
        
        alertDiv.style.backgroundColor = cores[tipo] || cores.info;
        alertDiv.textContent = mensagem;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
    
    // Adicionar CSS para anima√ß√£o
    if (!document.querySelector('#alert-animation-style')) {
        const style = document.createElement('style');
        style.id = 'alert-animation-style';
        style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        `;
        document.head.appendChild(style);
    }

    // DADOS GLOBAIS
    let todasTransferencias = [];
    let transferenciasFiltradas = [];
    let filtroAtual = 'all';
    
    // VARI√ÅVEIS DE PAGINA√á√ÉO
    let limiteAtual = 10;
    const limitePorPagina = 10;
    
    // INICIAR CARREGAMENTO
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ P√°gina Minhas Transfer√™ncias carregada');
        carregarUsuario();
        carregarTransferencias();
    });
    
    // CARREGAR USU√ÅRIO
    async function carregarUsuario() {
        try {
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = window.USER?.nome || 'Usu√°rio';
            }
        } catch (error) {
            console.log('Erro ao carregar usu√°rio:', error);
        }
    }
    
    // CARREGAR TRANSFER√äNCIAS
    async function carregarTransferencias() {
        try {
            // Limpar loading
            document.getElementById('listaTransferencias').innerHTML = '';
            
            const response = await fetch('/api/transferencias-internacionais');
            if (response.ok) {
                const data = await response.json();
                console.log(`‚úÖ ${data.length} transfer√™ncias carregadas`);
                
                todasTransferencias = data;
                filtrarTransferencias('all');
                
                // Configurar auto-atualiza√ß√£o (1 minuto)
                //setInterval(() => {
                //    if (document.visibilityState === 'visible') {
                //        carregarTransferencias();
                //    }
                //}, 60000);
                
            } else {
                console.error('‚ùå Erro ao carregar transfer√™ncias:', response.status);
                mostrarErro('Erro ao carregar transfer√™ncias');
            }
        } catch (error) {
            console.error('‚ùå Erro de rede:', error);
            mostrarErro('Erro de conex√£o');
        }
    }
    
    // ADICIONE esta fun√ß√£o para o bot√£o atualizar:
    function setupAtualizacaoManual() {
        const btnAtualizar = document.getElementById('btnAtualizar');
        let estaAtualizando = false;
        
        if (btnAtualizar) {
            btnAtualizar.addEventListener('click', async function() {
                if (estaAtualizando) return;
                
                // Mostrar anima√ß√£o
                estaAtualizando = true;
                btnAtualizar.classList.add('animando');
                btnAtualizar.disabled = true;
                
                try {
                    await carregarTransferencias();
                    
                    // Mostrar feedback visual
                    btnAtualizar.innerHTML = '<i class="fas fa-check"></i> Atualizado!';
                    btnAtualizar.style.borderColor = 'var(--cor-sucesso)';
                    btnAtualizar.style.color = 'var(--cor-sucesso)';
                    
                    setTimeout(() => {
                        btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                        btnAtualizar.style.borderColor = '';
                        btnAtualizar.style.color = '';
                        btnAtualizar.classList.remove('animando');
                        btnAtualizar.disabled = false;
                        estaAtualizando = false;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Erro ao atualizar:', error);
                    
                    // Mostrar erro
                    btnAtualizar.innerHTML = '<i class="fas fa-times"></i> Erro';
                    btnAtualizar.style.borderColor = 'var(--cor-perigo)';
                    btnAtualizar.style.color = 'var(--cor-perigo)';
                    
                    setTimeout(() => {
                        btnAtualizar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                        btnAtualizar.style.borderColor = '';
                        btnAtualizar.style.color = '';
                        btnAtualizar.classList.remove('animando');
                        btnAtualizar.disabled = false;
                        estaAtualizando = false;
                    }, 2000);
                }
            });
        }
    }

    // NO DOMContentLoaded, adicione:
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ P√°gina Minhas Transfer√™ncias carregada');
        carregarUsuario();
        carregarTransferencias();
        setupAtualizacaoManual();  // <-- ADICIONE ESTA LINHA
    });

    // FILTRAR TRANSFER√äNCIAS
    function filtrarTransferencias(filtro) {
        filtroAtual = filtro;
        
        // Atualizar bot√µes ativos
        document.querySelectorAll('.btn-filtro').forEach(btn => {
            btn.classList.remove('ativo');
        });
        
        document.getElementById(`btn-${getNomeFiltro(filtro)}`).classList.add('ativo');
        
        // Aplicar filtro
        if (filtro === 'all') {
            transferenciasFiltradas = [...todasTransferencias];
        } else {
            transferenciasFiltradas = todasTransferencias.filter(t => {
                if (filtro === 'pending') {
                    return t.status === 'pending' || t.status === 'pendente' || t.status === 'solicitada';
                }
                if (filtro === 'processing') {
                    return t.status === 'processing' || t.status === 'processando';
                }
                if (filtro === 'completed') {
                    return t.status === 'completed' || t.status === 'concluida' || t.status === 'aprovada';
                }
                if (filtro === 'rejected') {
                    return t.status === 'rejected' || t.status === 'recusada';
                }
                return t.status === filtro;
            });
        }
        
        // Ordenar por data (mais recente primeiro)
        transferenciasFiltradas.sort((a, b) => {
            return new Date(b.data || b.created_at) - new Date(a.data || a.created_at);
        });
        
        // Resetar limite ao filtrar
        limiteAtual = 10;
        
        // Atualizar lista
        atualizarListaTransferencias();
    }
    
    // ATUALIZAR LISTA
    function atualizarListaTransferencias() {
        const lista = document.getElementById('listaTransferencias');
        const mensagemVazia = document.getElementById('mensagemVazia');
        
        if (transferenciasFiltradas.length === 0) {
            lista.innerHTML = '';
            mensagemVazia.classList.remove('hidden');
            return;
        }
        
        mensagemVazia.classList.add('hidden');
        
        // PEGAR APENAS AS PRIMEIRAS X TRANSFER√äNCIAS
        const transferenciasParaExibir = transferenciasFiltradas.slice(0, limiteAtual);
        
        let html = '';
        
        transferenciasParaExibir.forEach(transferencia => {
            const status = transferencia.status;
            const statusClass = getStatusClass(status);
            const statusText = getStatusText(status);
            const valorFormatado = formatarMoeda(transferencia.valor, transferencia.moeda);
            const dataFormatada = formatarData(transferencia.data || transferencia.created_at);
            
            // Verificar status da invoice
            const invoiceStatus = transferencia.invoice_status || 'pending';
            const invoiceRecusada = transferencia.invoice_recusada || false;
            const temInvoice = transferencia.invoice || transferencia.invoice_status;
            
            // STATUS PARA O DATA-ATTRIBUTE (corre√ß√£o aqui)
            const dataStatus = getDataStatus(status);
            
            // Gerar HTML do card
            html += `
            <div class="card-transferencia" data-id="${transferencia.id}" data-status="${dataStatus}">
                <div class="card-header">
                    <div class="status-badge ${statusClass}">
                        <i class="fas ${getStatusIcon(status)}"></i>
                        ${statusText}
                    </div>
                    <div class="transferencia-id">#${transferencia.id}</div>
                </div>
                
                <div class="card-content">
                    <div class="info-group">
                        <div class="info-label">Benefici√°rio</div>
                        <div class="info-value">${transferencia.beneficiario || 'N/A'}</div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">Banco</div>
                        <div class="info-value">${transferencia.nome_banco || 'N/A'}</div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">Pa√≠s</div>
                        <div class="info-value">${transferencia.pais || 'N/A'}</div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">Valor</div>
                        <div class="info-value valor-destaque">${valorFormatado}</div>
                    </div>
                </div>
                
                ${temInvoice ? criarLinhaInvoice(invoiceStatus, invoiceRecusada, transferencia.id) : ''}
                
                <div class="card-footer">
                    <div class="data-transferencia">
                        <i class="far fa-calendar"></i>
                        ${dataFormatada}
                    </div>
                    
                    <div class="botoes-acao">
                        <button class="btn-acao btn-detalhes" onclick="mostrarDetalhes('${transferencia.id}')">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                        
                        ${temInvoice ? `
                        <button class="btn-acao btn-invoice" onclick="visualizarInvoice('${transferencia.id}')">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </button>
                        ` : ''}
                        
                        <button class="btn-acao btn-pdf" onclick="gerarPDF('${transferencia.id}')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
            </div>
            `;
        });
        
        // ADICIONAR BOT√ÉO "CARREGAR MAIS" SE HOUVER MAIS TRANSFER√äNCIAS
        if (transferenciasFiltradas.length > limiteAtual) {
            const restantes = transferenciasFiltradas.length - limiteAtual;
            const proximaLimite = Math.min(restantes, limitePorPagina);
            
            html += `
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="carregarMais()" class="btn-carregar-mais">
                    <i class="fas fa-plus-circle"></i> Carregar mais ${proximaLimite} transfer√™ncias
                    <br><small>(${restantes} restantes no total)</small>
                </button>
            </div>
            `;
        }
        
        lista.innerHTML = html;
    }
    
    // FUN√á√ÉO CARREGAR MAIS
    function carregarMais() {
        limiteAtual += limitePorPagina;
        atualizarListaTransferencias();
    }
    
    // FUN√á√ïES AUXILIARES
    function getStatusClass(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'status-pending';
            case 'processing':
            case 'processando':
                return 'status-processing';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'status-completed';
            case 'rejected':
            case 'recusada':
                return 'status-rejected';
            default:
                return 'status-pending';
        }
    }
    
    function getDataStatus(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'pending';
            case 'processing':
            case 'processando':
                return 'processing';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'completed';
            case 'rejected':
            case 'recusada':
                return 'rejected';
            default:
                return 'pending';
        }
    }
    
    function getStatusText(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'Pendente';
            case 'processing':
            case 'processando':
                return 'Processando';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'Conclu√≠da';
            case 'rejected':
            case 'recusada':
                return 'Recusada';
            default:
                return status;
        }
    }
    
    function getStatusIcon(status) {
        switch (status) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'fa-clock';
            case 'processing':
            case 'processando':
                return 'fa-sync-alt';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'fa-check-circle';
            case 'rejected':
            case 'recusada':
                return 'fa-times-circle';
            default:
                return 'fa-clock';
        }
    }
    
    function getNomeFiltro(filtro) {
        switch (filtro) {
            case 'all': return 'todas';
            case 'pending': return 'pendentes';
            case 'processing': return 'processando';
            case 'completed': return 'concluidas';
            case 'rejected': return 'recusadas';
            default: return 'todas';
        }
    }
    
    // FUN√á√ÉO CRIAR LINHA INVOICE (CORRIGIDA)
    function criarLinhaInvoice(status, recusada, transferenciaId) {
        let statusClass = 'pending';
        let statusIcon = 'fa-clock';
        let statusText = 'Pendente';
        let showButton = false;
        
        if (status === 'approved') {
            statusClass = 'approved';
            statusIcon = 'fa-check-circle';
            statusText = 'Aprovada';
        } else if (status === 'rejected' || recusada) {
            statusClass = 'rejected';
            statusIcon = 'fa-times-circle';
            statusText = 'Recusada';
            showButton = true;
        }
        
        return `
        <div class="invoice-line">
            <div class="invoice-status ${statusClass}">
                <i class="fas ${statusIcon}"></i>
                <strong>Invoice:</strong> ${statusText}
            </div>
            ${showButton ? `
            <button class="btn-renviar-invoice" onclick="reenviarInvoice('${transferenciaId}')">
                <i class="fas fa-redo"></i> Reenviar
            </button>
            ` : ''}
        </div>
        `;
    }
    
    function formatarMoeda(valor, moeda) {
        if (!valor) return '--';
        const simbolos = {
            'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'BRL': 'R$'
        };
        const simbolo = simbolos[moeda] || moeda;
        return `${simbolo} ${parseFloat(valor).toFixed(2)}`;
    }
    
    function formatarData(dataString) {
        if (!dataString) return '--';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
    }
    
    function mostrarErro(mensagem) {
        const lista = document.getElementById('listaTransferencias');
        lista.innerHTML = `
            <div class="mensagem-vazia">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>${mensagem}</h3>
                <button onclick="carregarTransferencias()" class="btn-voltar-dashboard" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Tentar Novamente
                </button>
            </div>
        `;
    }
    
    // ============================================
    // FUN√á√ÉO MOSTRAR DETALHES (ID√äNTICA AO KIVY)
    // ============================================

    async function mostrarDetalhes(transferenciaId) {
        console.log(`üîç Buscando detalhes da transfer√™ncia ${transferenciaId}...`);
        
        try {
            showAlert('Carregando detalhes...', 'info');
            
            // 1. Buscar dados da transfer√™ncia espec√≠fica
            const response = await fetch(`/api/transferencias-internacionais`);
            
            if (!response.ok) {
                throw new Error('Erro ao buscar dados da transfer√™ncia');
            }
            
            const todasTransferencias = await response.json();
            
            // Encontrar a transfer√™ncia espec√≠fica
            const transferencia = todasTransferencias.find(t => 
                t.id === transferenciaId || 
                t.id.toString() === transferenciaId.toString()
            );
            
            if (!transferencia) {
                throw new Error(`Transfer√™ncia ${transferenciaId} n√£o encontrada`);
            }
            
            console.log('‚úÖ Dados da transfer√™ncia carregados:', transferencia);
            
            // 2. Criar modal de detalhes (estilo Kivy)
            criarModalDetalhesKivy(transferencia);
            
        } catch (error) {
            console.error('‚ùå Erro ao mostrar detalhes:', error);
            showAlert(`Erro: ${error.message}`, 'error');
        }
    }

    // ============================================
    // MODAL DE DETALHES (ESTILO KIVY)
    // ============================================

    function criarModalDetalhesKivy(dados) {
        // Criar overlay/modal
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'modalDetalhesOverlay';
        modalOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        `;
        
        // Criar modal container
        const modalContainer = document.createElement('div');
        modalContainer.style.cssText = `
            background: #0d1117;
            border-radius: 12px;
            width: 700px;
            max-width: 90vw;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid #1e232e;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        `;
        
        // üî• CABE√áALHO DO MODAL (igual ao Kivy)
        const modalHeader = document.createElement('div');
        modalHeader.style.cssText = `
            background: linear-gradient(90deg, #1a5fb4, #2d8fff);
            color: white;
            padding: 20px 25px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 2px solid #1a5fb4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        `;
        
        modalHeader.innerHTML = `
            <div>
                <i class="fas fa-exchange-alt"></i>
                DETALHES COMPLETOS DA TRANSFER√äNCIA
            </div>
            <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">
                ID: #${dados.id}
            </div>
        `;
        
        // üî• CONTE√öDO COM SCROLL (igual ao Kivy)
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.6;
        `;
        
        // üî• GERAR CONTE√öDO DETALHADO (igual ao Kivy)
        modalContent.innerHTML = gerarConteudoDetalhesKivy(dados);
        
        // üî• FOOTER DO MODAL
        const modalFooter = document.createElement('div');
        modalFooter.style.cssText = `
            padding: 20px 25px;
            border-top: 1px solid #1e232e;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        `;
        
        // Bot√£o FECHAR (roxo como no Kivy)
        const btnFechar = document.createElement('button');
        btnFechar.innerHTML = '<i class="fas fa-times"></i> FECHAR';
        btnFechar.style.cssText = `
            padding: 10px 25px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        `;
        
        btnFechar.onmouseover = () => {
            btnFechar.style.background = '#8e44ad';
            btnFechar.style.transform = 'translateY(-2px)';
        };
        
        btnFechar.onmouseout = () => {
            btnFechar.style.background = '#9b59b6';
            btnFechar.style.transform = 'translateY(0)';
        };
        
        btnFechar.onclick = () => {
            document.body.removeChild(modalOverlay);
        };
        
        modalFooter.appendChild(btnFechar);
        
        // Montar modal
        modalContainer.appendChild(modalHeader);
        modalContainer.appendChild(modalContent);
        modalContainer.appendChild(modalFooter);
        modalOverlay.appendChild(modalContainer);
        
        // Adicionar ao body
        document.body.appendChild(modalOverlay);
        
        // Fechar ao clicar fora do modal
        modalOverlay.onclick = (e) => {
            if (e.target === modalOverlay) {
                document.body.removeChild(modalOverlay);
            }
        };
        
        // Adicionar anima√ß√µes CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideUp {
                from { 
                    opacity: 0;
                    transform: translateY(30px);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            #modalDetalhesOverlay .detalhes-secao {
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 1px solid #2a2f3a;
            }
            
            #modalDetalhesOverlay .detalhes-titulo {
                color: #1a5fb4;
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            #modalDetalhesOverlay .detalhes-item {
                display: grid;
                grid-template-columns: 140px 1fr;
                margin-bottom: 8px;
                padding: 4px 0;
            }
            
            #modalDetalhesOverlay .detalhes-label {
                color: #8b949e;
                font-weight: 600;
            }
            
            #modalDetalhesOverlay .detalhes-valor {
                color: #e0e0e0;
                word-break: break-word;
            }
            
            #modalDetalhesOverlay .status-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
                text-transform: uppercase;
            }
            
            #modalDetalhesOverlay .status-pending {
                background: rgba(243, 156, 18, 0.15);
                color: #f39c12;
                border: 1px solid rgba(243, 156, 18, 0.3);
            }
            
            #modalDetalhesOverlay .status-processing {
                background: rgba(26, 95, 180, 0.15);
                color: #1a5fb4;
                border: 1px solid rgba(26, 95, 180, 0.3);
            }
            
            #modalDetalhesOverlay .status-completed {
                background: rgba(46, 194, 126, 0.15);
                color: #2ec27e;
                border: 1px solid rgba(46, 194, 126, 0.3);
            }
            
            #modalDetalhesOverlay .status-rejected {
                background: rgba(224, 27, 36, 0.15);
                color: #e01b24;
                border: 1px solid rgba(224, 27, 36, 0.3);
            }
            
            #modalDetalhesOverlay .invoice-status-approved {
                color: #2ec27e;
                font-weight: bold;
            }
            
            #modalDetalhesOverlay .invoice-status-rejected {
                color: #e01b24;
                font-weight: bold;
            }
            
            #modalDetalhesOverlay .invoice-status-pending {
                color: #f39c12;
                font-weight: bold;
            }
            
            /* Scrollbar personalizada */
            #modalDetalhesOverlay ::-webkit-scrollbar {
                width: 8px;
            }
            
            #modalDetalhesOverlay ::-webkit-scrollbar-track {
                background: #1a1f2e;
                border-radius: 4px;
            }
            
            #modalDetalhesOverlay ::-webkit-scrollbar-thumb {
                background: #2d3a5a;
                border-radius: 4px;
            }
            
            #modalDetalhesOverlay ::-webkit-scrollbar-thumb:hover {
                background: #3a4a70;
            }
        `;
        
        document.head.appendChild(style);
    }

    // ============================================
    // GERAR CONTE√öDO DOS DETALHES (ID√äNTICO AO KIVY)
    // ============================================

    function gerarConteudoDetalhesKivy(dados) {
        // üî• FORMATAR STATUS (igual ao Kivy)
        const statusText = formatarStatusKivy(dados.status);
        const statusClass = getStatusClass(dados.status);
        
        // üî• FORMATAR DATA (igual ao Kivy)
        const dataFormatada = formatarDataKivy(dados.data || dados.created_at);
        const dataAprovacaoFormatada = dados.data_aprovacao ? formatarDataKivy(dados.data_aprovacao) : null;
        const dataConclusaoFormatada = dados.data_conclusao ? formatarDataKivy(dados.data_conclusao) : null;
        
        // üî• DETERMINAR TIPO (igual ao Kivy)
        const tipoTransferencia = dados.tipo === 'transferencia_internacional' ? 'INTERNACIONAL' : 'INTERNA';
        
        // üî• VALOR FORMATADO (igual ao Kivy)
        const valorFormatado = formatarMoedaKivy(dados.valor, dados.moeda);
        
        let html = '';
        
        // üî• SE√á√ÉO 1: INFORMA√á√ïES B√ÅSICAS (igual ao Kivy)
        html += `
            <div class="detalhes-secao">
                <div class="detalhes-titulo">
                    <i class="fas fa-info-circle"></i>
                    INFORMA√á√ïES B√ÅSICAS
                </div>
                
                <div class="detalhes-item">
                    <span class="detalhes-label">ID:</span>
                    <span class="detalhes-valor">${dados.id}</span>
                </div>
                
                <div class="detalhes-item">
                    <span class="detalhes-label">Status:</span>
                    <span class="detalhes-valor">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </span>
                </div>
                
                <div class="detalhes-item">
                    <span class="detalhes-label">Tipo:</span>
                    <span class="detalhes-valor">${tipoTransferencia}</span>
                </div>
                
                <div class="detalhes-item">
                    <span class="detalhes-label">Valor:</span>
                    <span class="detalhes-valor" style="font-weight: bold; font-size: 15px;">
                        ${valorFormatado}
                    </span>
                </div>
                
                <div class="detalhes-item">
                    <span class="detalhes-label">Data:</span>
                    <span class="detalhes-valor">${dataFormatada}</span>
                </div>
            </div>
        `;
        
        // üî• SE√á√ÉO 2: BENEFICI√ÅRIO INTERNACIONAL (igual ao Kivy)
        if (tipoTransferencia === 'INTERNACIONAL') {
            html += `
                <div class="detalhes-secao">
                    <div class="detalhes-titulo">
                        <i class="fas fa-user-tie"></i>
                        BENEFICI√ÅRIO INTERNACIONAL
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Nome:</span>
                        <span class="detalhes-valor">${dados.beneficiario || 'N/A'}</span>
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Endere√ßo:</span>
                        <span class="detalhes-valor">${dados.endereco_beneficiario || 'N/A'}</span>
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Cidade:</span>
                        <span class="detalhes-valor">${dados.cidade || dados.cidade_banco || 'N/A'}</span>
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Pa√≠s:</span>
                        <span class="detalhes-valor">${dados.pais || dados.pais_banco || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="detalhes-secao">
                    <div class="detalhes-titulo">
                        <i class="fas fa-university"></i>
                        INFORMA√á√ïES BANC√ÅRIAS
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Banco:</span>
                        <span class="detalhes-valor">${dados.nome_banco || 'N/A'}</span>
                    </div>
                    
                    ${dados.endereco_banco ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Endere√ßo Banco:</span>
                        <span class="detalhes-valor">${dados.endereco_banco}</span>
                    </div>
                    ` : ''}
                    
                    ${dados.cidade_banco ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Cidade Banco:</span>
                        <span class="detalhes-valor">${dados.cidade_banco}</span>
                    </div>
                    ` : ''}
                    
                    ${dados.pais_banco ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Pa√≠s Banco:</span>
                        <span class="detalhes-valor">${dados.pais_banco}</span>
                    </div>
                    ` : ''}
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">C√≥digo SWIFT:</span>
                        <span class="detalhes-valor" style="font-family: monospace;">
                            ${dados.codigo_swift || 'N/A'}
                        </span>
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">IBAN/Conta:</span>
                        <span class="detalhes-valor" style="font-family: monospace;">
                            ${dados.iban_account || 'N/A'}
                        </span>
                    </div>
                    
                    ${dados.aba_routing ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">ABA/Routing:</span>
                        <span class="detalhes-valor">${dados.aba_routing}</span>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // üî• SE√á√ÉO 3: INFORMA√á√ïES ADICIONAIS (igual ao Kivy)
        const temInfoAdicional = dados.finalidade || dados.descricao;
        if (temInfoAdicional) {
            html += `
                <div class="detalhes-secao">
                    <div class="detalhes-titulo">
                        <i class="fas fa-sticky-note"></i>
                        INFORMA√á√ïES ADICIONAIS
                    </div>
                    
                    ${dados.finalidade ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Finalidade:</span>
                        <span class="detalhes-valor">${dados.finalidade}</span>
                    </div>
                    ` : ''}
                    
                    ${dados.descricao ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Descri√ß√£o:</span>
                        <span class="detalhes-valor">${dados.descricao}</span>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // üî• SE√á√ÉO 4: PROCESSAMENTO (igual ao Kivy - s√≥ mostra se tiver dados)
        if (dados.data_aprovacao || dados.executado_por || dados.data_conclusao || dados.concluido_por) {
            html += `
                <div class="detalhes-secao">
                    <div class="detalhes-titulo">
                        <i class="fas fa-cogs"></i>
                        PROCESSAMENTO
                    </div>
                    
                    ${dados.data_aprovacao ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Aprovado por:</span>
                        <span class="detalhes-valor">${dados.executado_por || dados.concluido_por || 'N/A'}</span>
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Data Aprova√ß√£o:</span>
                        <span class="detalhes-valor">${dataAprovacaoFormatada}</span>
                    </div>
                    ` : ''}
                    
                    ${dados.data_conclusao ? `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Conclu√≠do por:</span>
                        <span class="detalhes-valor">${dados.concluido_por || 'N/A'}</span>
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Data Conclus√£o:</span>
                        <span class="detalhes-valor">${dataConclusaoFormatada}</span>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // üî• SE√á√ÉO 5: MOTIVO DA RECUSA (igual ao Kivy)
        if (dados.status === 'rejected' && dados.motivo_recusa) {
            html += `
                <div class="detalhes-secao">
                    <div class="detalhes-titulo" style="color: #e01b24;">
                        <i class="fas fa-exclamation-triangle"></i>
                        MOTIVO DA RECUSA
                    </div>
                    
                    <div class="detalhes-item" style="grid-template-columns: 1fr;">
                        <span class="detalhes-valor" style="color: #ff6b6b; font-style: italic;">
                            "${dados.motivo_recusa}"
                        </span>
                    </div>
                </div>
            `;
        }
        
        // üî• SE√á√ÉO 6: DADOS SWIFT (igual ao Kivy)
        if (dados.dados_swift_pagamento && Object.keys(dados.dados_swift_pagamento).length > 0) {
            html += `
                <div class="detalhes-secao">
                    <div class="detalhes-titulo" style="color: #6c8eff;">
                        <i class="fas fa-file-invoice-dollar"></i>
                        DADOS SWIFT DO PAGAMENTO
                    </div>
            `;
            
            // Ordenar as linhas SWIFT corretamente
            const swiftKeys = [
                'linha1_uetr', 'linha2_20', 'linha3_32a', 'linha4_50k',
                'linha5_57a', 'linha6_59', 'linha7_beneficiario', 'linha8_70', 'linha9_71a'
            ];
            
            swiftKeys.forEach(key => {
                if (dados.dados_swift_pagamento[key]) {
                    const label = formatarLabelSwift(key);
                    html += `
                        <div class="detalhes-item">
                            <span class="detalhes-label">${label}:</span>
                            <span class="detalhes-valor" style="font-family: monospace; font-size: 13px;">
                                ${dados.dados_swift_pagamento[key]}
                            </span>
                        </div>
                    `;
                }
            });
            
            html += `</div>`;
        }
        
        // üî• SE√á√ÉO 7: INFORMA√á√ïES DA INVOICE (igual ao Kivy)
        if (dados.invoice_info) {
            const invoiceStatus = dados.invoice_info.status || 'pending';
            const invoiceStatusText = formatarStatusInvoiceKivy(invoiceStatus);
            const invoiceStatusClass = `invoice-status-${invoiceStatus}`;
            
            html += `
                <div class="detalhes-secao">
                    <div class="detalhes-titulo">
                        <i class="fas fa-file-contract"></i>
                        STATUS DA INVOICE
                    </div>
                    
                    <div class="detalhes-item">
                        <span class="detalhes-label">Status:</span>
                        <span class="detalhes-valor ${invoiceStatusClass}">
                            ${invoiceStatusText}
                        </span>
                    </div>
            `;
            
            if (invoiceStatus === 'rejected' && dados.invoice_info.motivo_recusa) {
                html += `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Motivo:</span>
                        <span class="detalhes-valor" style="color: #ff6b6b;">
                            ${dados.invoice_info.motivo_recusa}
                        </span>
                    </div>
                `;
            }
            
            if (dados.invoice_info.data_upload) {
                const dataUploadFormatada = formatarDataKivy(dados.invoice_info.data_upload);
                html += `
                    <div class="detalhes-item">
                        <span class="detalhes-label">Data Upload:</span>
                        <span class="detalhes-valor">${dataUploadFormatada}</span>
                    </div>
                `;
            }
            
            html += `</div>`;
        }
        
        return html;
    }

    // ============================================
    // FUN√á√ïES AUXILIARES (IGUAL AO KIVY)
    // ============================================

    function formatarStatusKivy(status) {
        const statusMap = {
            'solicitada': 'PENDENTE',
            'pendente': 'PENDENTE',
            'pending': 'PENDENTE',
            'processando': 'PROCESSANDO',
            'processing': 'PROCESSANDO',
            'concluida': 'CONCLU√çDA',
            'completed': 'CONCLU√çDA',
            'aprovada': 'CONCLU√çDA',
            'recusada': 'RECUSADA',
            'rejected': 'RECUSADA'
        };
        
        return statusMap[status.toLowerCase()] || status.toUpperCase();
    }

    function formatarStatusInvoiceKivy(status) {
        const statusMap = {
            'pending': 'Pendente',
            'approved': 'Aprovada',
            'rejected': 'Recusada'
        };
        
        return statusMap[status.toLowerCase()] || status;
    }

    function getStatusClass(status) {
        switch (status.toLowerCase()) {
            case 'pending':
            case 'pendente':
            case 'solicitada':
                return 'status-pending';
            case 'processing':
            case 'processando':
                return 'status-processing';
            case 'completed':
            case 'concluida':
            case 'aprovada':
                return 'status-completed';
            case 'rejected':
            case 'recusada':
                return 'status-rejected';
            default:
                return 'status-pending';
        }
    }

    function formatarDataKivy(dataString) {
        if (!dataString) return 'N/A';
        
        try {
            const data = new Date(dataString);
            if (isNaN(data.getTime())) return dataString;
            
            // Formato: "04/12/2025 12:19:29" (DD/MM/YYYY HH:MM:SS)
            const dia = data.getDate().toString().padStart(2, '0');
            const mes = (data.getMonth() + 1).toString().padStart(2, '0');
            const ano = data.getFullYear();
            const horas = data.getHours().toString().padStart(2, '0');
            const minutos = data.getMinutes().toString().padStart(2, '0');
            const segundos = data.getSeconds().toString().padStart(2, '0');
            
            return `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;
        } catch (error) {
            return dataString;
        }
    }

    function formatarMoedaKivy(valor, moeda) {
        if (!valor) return '--';
        
        const simbolos = {
            'USD': 'US$',
            'EUR': '‚Ç¨',
            'GBP': '¬£',
            'BRL': 'R$'
        };
        
        const simbolo = simbolos[moeda] || moeda;
        const valorNumerico = parseFloat(valor);
        
        // Formatar com 2 decimais e separador de milhares
        return `${simbolo} ${valorNumerico.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
    }

    function formatarLabelSwift(key) {
        const labelMap = {
            'linha1_uetr': 'UETR #',
            'linha2_20': ':20:',
            'linha3_32a': ':32A:',
            'linha4_50k': ':50K:',
            'linha5_57a': ':57A:',
            'linha6_59': ':59:',
            'linha7_beneficiario': 'Benefici√°rio',
            'linha8_70': ':70:',
            'linha9_71a': ':71A:'
        };
        
        return labelMap[key] || key.replace('linha', 'Linha ').replace('_', ':');
    }

    // Fun√ß√£o de alerta (se ainda n√£o existir)
    function showAlert(mensagem, tipo = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            animation: fadeInOut 3s ease-in-out;
        `;
        
        const cores = {
            'success': '#2ec27e',
            'error': '#e01b24',
            'info': '#1a5fb4',
            'warning': '#f39c12'
        };
        
        alertDiv.style.backgroundColor = cores[tipo] || cores.info;
        alertDiv.textContent = mensagem;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
        
        // Adicionar anima√ß√£o CSS se n√£o existir
        if (!document.querySelector('#alert-animation-style')) {
            const style = document.createElement('style');
            style.id = 'alert-animation-style';
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateY(-20px); }
                    15% { opacity: 1; transform: translateY(0); }
                    85% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    // ============================================
    // VISUALIZAR INVOICE (VERS√ÉO COMPLETA - WEB)
    // ============================================

    async function visualizarInvoice(transferenciaId) {
        console.log(`üìÑ [INVOICE-WEB] Iniciando para: ${transferenciaId}`);
        
        try {
            showAlert('üîç Carregando invoice...', 'info');
            
            // 1. BAIXAR DIRETAMENTE O ARQUIVO (usando endpoint que EXISTE)
            showAlert('‚¨áÔ∏è Baixando invoice...', 'info');
            
            const downloadResponse = await fetch(`/api/transferencias/${transferenciaId}/invoice`);
            
            if (!downloadResponse.ok) {
                const errorText = await downloadResponse.text();
                let errorMessage = 'Erro ao baixar arquivo';
                
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.error || errorMessage;
                } catch {
                    errorMessage = errorText || errorMessage;
                }
                
                // Se for 404, verificar se realmente existe invoice
                if (downloadResponse.status === 404) {
                    // Buscar dados da transfer√™ncia para verificar
                    const transferenciasResponse = await fetch('/api/transferencias-internacionais');
                    if (transferenciasResponse.ok) {
                        const todasTransferencias = await transferenciasResponse.json();
                        const transferencia = todasTransferencias.find(t => 
                            t.id === transferenciaId || t.id.toString() === transferenciaId.toString()
                        );
                        
                        if (transferencia && (!transferencia.invoice || !transferencia.invoice_info)) {
                            showAlert('‚ùå Esta transfer√™ncia n√£o tem invoice associada', 'error');
                            return;
                        }
                    }
                }
                
                throw new Error(errorMessage);
            }
            
            // 2. PROCESSAR RESPOSTA
            const fileBlob = await downloadResponse.blob();
            const fileUrl = URL.createObjectURL(fileBlob);
            
            // 3. DETERMINAR TIPO E ABRIR
            const fileType = fileBlob.type;
            const isPDF = fileType === 'application/pdf';
            const isImage = fileType.startsWith('image/');
            
            // Obter nome do arquivo do header
            const contentDisposition = downloadResponse.headers.get('Content-Disposition');
            let fileName = 'invoice_download';
            
            if (contentDisposition && contentDisposition.includes('filename=')) {
                fileName = contentDisposition.split('filename=')[1].replace(/"/g, '');
            } else {
                // Tentar extrair nome do tipo de arquivo
                const extension = isPDF ? '.pdf' : isImage ? '.jpg' : '.file';
                fileName = `invoice_${transferenciaId}${extension}`;
            }
            
            console.log(`‚úÖ Arquivo recebido: ${fileName}, Tipo: ${fileType}`);
            
            if (isPDF) {
                // Abrir PDF em nova aba
                window.open(fileUrl, '_blank');
            } else if (isImage) {
                // Abrir imagem em modal usando abrirImagemModal (a fun√ß√£o SIMPLES)
                abrirImagemModal(fileUrl, fileName);
            } else {
                // For√ßar download
                forcarDownload(fileBlob, fileName);
            }
            
            showAlert(`‚úÖ Invoice aberta com sucesso!`, 'success');
            
            // Liberar mem√≥ria depois de um tempo
            setTimeout(() => {
                URL.revokeObjectURL(fileUrl);
            }, 10000);
            
        } catch (error) {
            console.error(`‚ùå [INVOICE-WEB] Erro:`, error);
            showAlert(`‚ùå Erro: ${error.message}`, 'error');
        }
    }

    // ============================================
    // FUN√á√ïES AUXILIARES PARA VISUALIZA√á√ÉO
    // ============================================

    function abrirImagemModal(imageUrl, fileName) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        modal.innerHTML = `
            <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                <img src="${imageUrl}" alt="${fileName}" style="max-width: 100%; max-height: 90vh;">
                <button onclick="this.parentElement.parentElement.remove(); URL.revokeObjectURL('${imageUrl}')" 
                    style="position: absolute; top: 10px; right: 10px; background: #e01b24; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">
                    √ó
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function abrirPDF(pdfUrl, fileName, transferenciaId) {
        console.log(`üìñ Abrindo PDF: ${fileName}`);
        
        // Op√ß√£o 1: Abrir em nova aba (simples)
        window.open(pdfUrl, '_blank');
        
        // Op√ß√£o 2: Modal embutido (mais sofisticado)
        // criarModalPDF(pdfUrl, fileName, transferenciaId);
    }

    function forcarDownload(blob, fileName) {
        console.log(`üíæ For√ßando download: ${fileName}`);
        
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Liberar mem√≥ria depois de um tempo
        setTimeout(() => {
            URL.revokeObjectURL(downloadUrl);
        }, 100);
    }

    // ============================================
    // MODAL AVAN√áADO PARA PDF (OPCIONAL)
    // ============================================

    function criarModalPDF(pdfUrl, fileName, transferenciaId) {
        console.log(`üìö Criando modal PDF avan√ßado para: ${fileName}`);
        
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'pdfModalOverlay';
        modalOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        `;
        
        // Header
        const modalHeader = document.createElement('div');
        modalHeader.style.cssText = `
            padding: 15px 20px;
            background: #1a1f2e;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2d3a5a;
        `;
        
        modalHeader.innerHTML = `
            <div style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-pdf" style="color: #e01b24;"></i>
                <span>${fileName}</span>
                <span style="font-size: 12px; opacity: 0.7; margin-left: 10px;">
                    Transfer√™ncia: #${transferenciaId}
                </span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="downloadPdfBtn" style="padding: 6px 12px; background: #1a5fb4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-download"></i> Download
                </button>
                <button id="closePdfModal" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Iframe para PDF
        const pdfFrame = document.createElement('iframe');
        pdfFrame.src = pdfUrl;
        pdfFrame.style.cssText = `
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        `;
        
        pdfFrame.title = `Invoice - ${fileName}`;
        
        // Montar modal
        modalOverlay.appendChild(modalHeader);
        modalOverlay.appendChild(pdfFrame);
        document.body.appendChild(modalOverlay);
        
        // Event listeners
        document.getElementById('closePdfModal').onclick = () => {
            document.body.removeChild(modalOverlay);
            URL.revokeObjectURL(pdfUrl); // Liberar mem√≥ria
        };
        
        document.getElementById('downloadPdfBtn').onclick = () => {
            forcarDownload(new Blob([pdfUrl]), fileName);
        };
        
        // Adicionar tecla ESC para fechar
        const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
                document.body.removeChild(modalOverlay);
                URL.revokeObjectURL(pdfUrl);
                document.removeEventListener('keydown', handleKeyDown);
            }
        };
        
        document.addEventListener('keydown', handleKeyDown);
    }
    
    // ============================================
    // PDF GENERATOR ID√äNTICO AO KIVY
    // ============================================

    class PDFGeneratorKivyStyle {
        constructor() {
            this.mmToPt = 0.3528;
        }
        
        async gerarComprovanteKivy(transferencia) {
            console.log('üé® Gerando PDF estilo Kivy para:', transferencia.id);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            try {
                // 1. CABE√áALHO
                this._adicionarCabecalhoKivy(doc, pageWidth, pageHeight, transferencia);
                
                // 2. DADOS DA TRANSFER√äNCIA
                let yPos = this._adicionarDadosTransferenciaKivy(doc, pageWidth, transferencia);
                
                // üî• CALCULAR ALTURA RESTANTE DINAMICAMENTE
                const status = this._getStatusNormalizado(transferencia.status);
                const temSwift = status === 'COMPLETED' && transferencia.dados_swift_pagamento && 
                                Object.keys(transferencia.dados_swift_pagamento).length > 0;
                
                // üî• ALTURAS ESTIMADAS (em mm)
                const alturaBeneficiary = 40 + 6; // boxHeight + espa√ßo
                const alturaBanking = transferencia.tipo === 'transferencia_internacional' ? 50 + 4 : 0;
                const alturaSwift = temSwift ? 50 + 3 : 0;
                const alturaRodape = 40;
                
                // üî• CALCULAR SE CABE NA P√ÅGINA
                const alturaTotalNecessaria = yPos + alturaBeneficiary + alturaBanking + alturaSwift + alturaRodape;
                const margemSeguranca = 5; // mm de margem
                
                console.log('üìè C√°lculo de altura:');
                console.log('   - yPos atual:', yPos);
                console.log('   - Beneficiary:', alturaBeneficiary);
                console.log('   - Banking:', alturaBanking);
                console.log('   - Swift:', alturaSwift);
                console.log('   - Rodap√©:', alturaRodape);
                console.log('   - Total necess√°rio:', alturaTotalNecessaria);
                console.log('   - Altura p√°gina:', pageHeight);
                console.log('   - Tem Swift?', temSwift);
                
                
                // Posi√ß√£o fixa do Beneficiary (voc√™ escolheu 90mm)
                const posicaoFixaBeneficiary = 90; // üî• SEU AJUSTE: 90mm
                if (yPos < posicaoFixaBeneficiary) {
                    yPos = posicaoFixaBeneficiary;
                }
                
                // 3. BENEFICI√ÅRIO
                yPos = this._adicionarBeneficiarioCompacto(doc, pageWidth, yPos, transferencia);
                
                // 4. INFORMA√á√ïES BANC√ÅRIAS
                yPos = this._adicionarInfoBancariaCorrigido(doc, pageWidth, yPos, transferencia);
                
                // 5. SWIFT PAYMENT DETAILS (com altura ajustada se necess√°rio)
                if (temSwift) {
                    const alturaRestante = pageHeight - yPos - alturaRodape - margemSeguranca;
                    console.log('üìè Altura restante para Swift:', alturaRestante);
                    
                    if (alturaRestante < 50) {
                        // Swift MUITO compacto
                        yPos = this._adicionarSwiftDetailsUltraCompacto(doc, pageWidth, yPos, transferencia.dados_swift_pagamento);
                    } else {
                        // Swift normal (usa a fun√ß√£o que j√° existe)
                        yPos = this._adicionarSwiftDetailsCompacto(doc, pageWidth, yPos, transferencia.dados_swift_pagamento);
                    }
                }
                
                // üî• VERIFICAR SE O RODAP√â VAI CABER
                const espacoParaRodape = pageHeight - yPos;
                console.log('üìè Espa√ßo para rodap√©:', espacoParaRodape);
                
                if (espacoParaRodape < alturaRodape + 5) {
                    console.log('‚ö†Ô∏è Conte√∫do muito longo! Ajustando...');
                    // Se n√£o couber, podemos subir tudo um pouco mais
                    // Mas com seu ajuste para 90mm, deve caber
                }
                
                // 6. RODAP√â FIXO (agora deve caber)
                this._adicionarRodapeFixo(doc, pageWidth, pageHeight, transferencia);
                
                // 7. SALVAR
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const nomeArquivo = `comprovante_${transferencia.id}_${timestamp}.pdf`;
                doc.save(nomeArquivo);
                
                console.log('‚úÖ PDF Kivy gerado com sucesso!');
                return nomeArquivo;
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF Kivy:', error);
                return null;
            }
        }
        
        _adicionarCabecalhoKivy(doc, width, height, transferencia) {
            // üî• VERS√ÉO COM √çCONE E FUNDO AZUL
            
            // 1. FUNDO AZUL MARINHO ORIGINAL
            doc.setFillColor(20, 46, 82); // #142E52
            doc.rect(0, 0, width, 28, 'F');
            
            // 2. LOGO COM √çCONE (como antes)
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CAMBIO BANK', 20, 15); // Note: com acento como antes
            
            // 3. SUBT√çTULO
            doc.setTextColor(200, 200, 200);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Wire Transfer Receipt', 20, 21);
            
            // 4. ID AMARELO
            const idText = `ID: #${transferencia.id}`;
            const idWidth = doc.getTextWidth(idText);
            
            doc.setTextColor(230, 230, 0); // Amarelo mais suave
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(idText, width - 20 - idWidth, 15);
            
            // 5. DATA CINZA CLARO
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(8);
            const dataAtual = new Date().toLocaleString('pt-BR');
            const dataText = dataAtual;
            const dataWidth = doc.getTextWidth(dataText);
            doc.text(dataText, width - 20 - dataWidth, 22);
            
            // 6. LINHA DIVIS√ìRIA
            doc.setDrawColor(100, 100, 100);
            doc.setLineWidth(0.3);
            doc.line(10, 30, width - 10, 30);
        }
        
        // CORRIGIDO - NOVO (trecho com a corre√ß√£o):
        _adicionarDadosTransferenciaKivy(doc, width, dados) {
            let yPos = 36;
            
            // STATUS (mant√©m igual)
            const status = this._getStatusNormalizado(dados.status);
            const statusColors = {
                'PENDING': [255, 165, 0],
                'PROCESSING': [64, 115, 217],
                'COMPLETED': [38, 150, 38],
                'REJECTED': [178, 51, 51]
            };
            
            const color = statusColors[status] || [100, 100, 100];
            
            const statusWidth = doc.getTextWidth(status) + 16;
            doc.setFillColor(...color);
            doc.roundedRect(15, yPos, statusWidth, 8, 1.5, 1.5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(status, 15 + (statusWidth - doc.getTextWidth(status)) / 2, yPos + 5.2);
            
            yPos += 14;
            
            // TRANSFER AMOUNT (mant√©m igual)
            doc.setFillColor(247, 247, 247);
            doc.roundedRect(15, yPos, width - 30, 14, 3, 3, 'F');
            
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(15, yPos, width - 30, 14, 3, 3, 'S');
            
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('TRANSFER AMOUNT', 20, yPos + 5.5);
            
            const valorTexto = `${parseFloat(dados.valor || 0).toFixed(2)} ${dados.moeda || 'USD'}`;
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(valorTexto, width / 2, yPos + 10.5, { align: 'center' });
            
            yPos += 20;
            
            // INFORMA√á√ïES GERAIS (mant√©m igual)
            const col1X = 18;
            const col2X = width / 2 + 12;
            
            const formatarData = (dataString) => {
                if (!dataString) return 'N/A';
                try {
                    const data = new Date(dataString);
                    const dia = data.getDate().toString().padStart(2, '0');
                    const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                    const ano = data.getFullYear();
                    const horas = data.getHours().toString().padStart(2, '0');
                    const minutos = data.getMinutes().toString().padStart(2, '0');
                    const segundos = data.getSeconds().toString().padStart(2, '0');
                    return `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;
                } catch {
                    return dataString;
                }
            };
            
            // üî•üî¥üî¥üî¥üî¥ CORRE√á√ÉO DEFINITIVA AQUI üî¥üî¥üî¥üî¥
            // SEPARAR CLARAMENTE AS DATAS

            // 1. REQUEST DATE (data da solicita√ß√£o) - LOGICA INTELIGENTE
            let requestDate;
            if (dados.created_at && dados.data_conclusao && dados.data === dados.data_conclusao) {
                // üî• SE data foi sobrescrito pela data de conclus√£o
                // üî• USA created_at (data real da solicita√ß√£o)
                requestDate = dados.created_at;
                console.log('üìÖ CORRE√á√ÉO APLICADA: usando created_at porque data = data_conclusao');
            } else {
                // Caso normal
                requestDate = dados.created_at || dados.data || dados.data_solicitacao;
            }
            const requestDateFormatted = formatarData(requestDate);

            // 2. COMPLETED DATE (data da conclus√£o - somente se status for completed)
            const completedDate = dados.data_conclusao;
            const completedDateFormatted = completedDate ? formatarData(completedDate) : 'N/A';

            // Coluna 1 - REQUEST DATE (SEMPRE MOSTRA)
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Request Date:', col1X, yPos);

            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(requestDateFormatted, col1X, yPos + 4.5);

            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('Type:', col1X, yPos + 10);

            const tipoTexto = dados.tipo === 'transferencia_internacional' ? 'International' : 'Internal';
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.text(tipoTexto, col1X, yPos + 14.5);

            // Coluna 2 - PURPOSE
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('Purpose:', col2X, yPos);

            const finalidade = dados.finalidade || 'Not informed';
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');

            // üî• CORRE√á√ÉO: ALGORITMO MELHORADO QUE N√ÉO CORTA PALAVRAS
            if (finalidade.length > 25) {
                const palavras = finalidade.split(' ');
                let linha1 = '';
                let linha2 = '';
                
                // üî• NOVA L√ìGICA: N√£o corta palavras no meio!
                for (const palavra of palavras) {
                    // Tenta colocar na linha1 primeiro
                    if (linha1 === '' || (linha1 + ' ' + palavra).length <= 25) {
                        if (linha1) linha1 += ' ';
                        linha1 += palavra;
                    }
                    // Se n√£o couber na linha1, tenta linha2
                    else if (linha2 === '' || (linha2 + ' ' + palavra).length <= 25) {
                        if (linha2) linha2 += ' ';
                        linha2 += palavra;
                    }
                    // Se n√£o couber em nenhuma, corta com "..."
                    else {
                        if (linha2.length + 4 <= 25) { // espa√ßo para "..."
                            linha2 += ' ...';
                        } else if (linha1.length + 4 <= 25) {
                            linha1 += ' ...';
                        }
                        break;
                    }
                }
                
                doc.text(linha1, col2X, yPos + 4.5);
                if (linha2) {
                    doc.text(linha2, col2X, yPos + 9);
                    yPos += 5;
                }
            } else {
                doc.text(finalidade, col2X, yPos + 4.5);
            }

            // üî•üî¥üî¥üî¥üî¥ CORRE√á√ÉO: MOSTRAR "Completed Date" APENAS SE STATUS FOR COMPLETED
            if (status === 'COMPLETED' && completedDate) {
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('Completed Date:', col2X, yPos + 10);
                
                doc.setTextColor(20, 46, 82);
                doc.setFont('helvetica', 'bold');
                doc.text(completedDateFormatted, col2X, yPos + 14.5);
            } else {
                // Para outros status, manter espa√ßo igual
                doc.text('', col2X, yPos + 10);
                doc.text('', col2X, yPos + 14.5);
            }

            // üî• AJUSTE: Posi√ß√£o final fixa
            const posicaoFinalFixa = 85;
            return posicaoFinalFixa;
        } // ‚¨ÖÔ∏è‚¨ÖÔ∏è‚¨ÖÔ∏è ESTE ERA O } QUE ESTAVA FALTANDO!
        
        _adicionarBeneficiarioCompacto(doc, width, yPos, dados) {
            const boxHeight = 40;
            
            doc.setFillColor(250, 250, 250);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'F');
            
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'S');
            
            // T√çTULO (FONTE 10, SUBLINHADO 0.6)
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('BENEFICIARY DETAILS', 20, yPos + 8);
            
            doc.setDrawColor(20, 46, 82);
            doc.setLineWidth(0.6); // üî• SUBLINHADO MAIS FINO
            const textWidth1 = doc.getTextWidth('BENEFICIARY DETAILS');
            doc.line(20, yPos + 10.5, 20 + textWidth1, yPos + 10.5);
            
            const col1X = 25;
            const col2X = width / 2 + 15;
            let contentY = yPos + 18;
            
            // NOME (FONTE 8) - üî• CORRE√á√ÉO: N√ÉO CORTAR PALAVRAS
            doc.setTextColor(120, 120, 120);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('Name:', col1X, contentY);

            doc.setTextColor(20, 20, 20);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const nome = dados.beneficiario || 'N/A';

            let nomeHeight = 0;
            // üî• APLICAR A MESMA CORRE√á√ÉO PARA N√ÉO CORTAR PALAVRAS
            if (nome.length > 35) {
                const palavras = nome.split(' ');
                let linha1 = '';
                let linha2 = '';
                
                for (const palavra of palavras) {
                    if (linha1 === '' || (linha1 + ' ' + palavra).length <= 35) {
                        if (linha1) linha1 += ' ';
                        linha1 += palavra;
                    } else if (linha2 === '' || (linha2 + ' ' + palavra).length <= 35) {
                        if (linha2) linha2 += ' ';
                        linha2 += palavra;
                    } else {
                        if (linha2.length + 4 <= 35) {
                            linha2 += ' ...';
                        } else if (linha1.length + 4 <= 35) {
                            linha1 += ' ...';
                        }
                        break;
                    }
                }
                
                doc.text(linha1, col1X, contentY + 3.5);
                if (linha2) {
                    doc.text(linha2, col1X, contentY + 7);
                    nomeHeight = 10;
                } else {
                    nomeHeight = 6;
                }
            } else {
                doc.text(nome, col1X, contentY + 3.5);
                nomeHeight = 6;
            }

            contentY += nomeHeight;
            contentY += 4;

            // ENDERE√áO (FONTE 8) - üî• TAMB√âM CORRIGIR AQUI
            if (dados.endereco_beneficiario) {
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text('Address:', col1X, contentY);
                
                doc.setTextColor(20, 20, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                const endereco = dados.endereco_beneficiario;
                
                // üî• CORRE√á√ÉO PARA ENDERE√áO TAMB√âM
                if (endereco.length > 35) {
                    const palavras = endereco.split(' ');
                    let linha1 = '';
                    let linha2 = '';
                    
                    for (const palavra of palavras) {
                        if (linha1 === '' || (linha1 + ' ' + palavra).length <= 35) {
                            if (linha1) linha1 += ' ';
                            linha1 += palavra;
                        } else if (linha2 === '' || (linha2 + ' ' + palavra).length <= 35) {
                            if (linha2) linha2 += ' ';
                            linha2 += palavra;
                        } else {
                            if (linha2.length + 4 <= 35) {
                                linha2 += ' ...';
                            } else if (linha1.length + 4 <= 35) {
                                linha1 += ' ...';
                            }
                            break;
                        }
                    }
                    
                    doc.text(linha1, col1X, contentY + 3.5);
                    if (linha2) {
                        doc.text(linha2, col1X, contentY + 7);
                        contentY += 10;
                    } else {
                        contentY += 6;
                    }
                } else {
                    doc.text(endereco, col1X, contentY + 3.5);
                    contentY += 6;
                }
            }
            
            // CIDADE (FONTE 8)
            if (dados.cidade) {
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text('City:', col2X, yPos + 18);
                
                doc.setTextColor(20, 20, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text(dados.cidade, col2X, yPos + 21.5);
            }
            
            // PA√çS (FONTE 8)
            if (dados.pais) {
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text('Country:', col2X, yPos + 28);
                
                doc.setTextColor(20, 20, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text(dados.pais, col2X, yPos + 31.5);
            }
            
            return yPos + boxHeight + 6;
        }

        _adicionarInfoBancariaCorrigido(doc, width, yPos, dados) {
            if (dados.tipo === 'transferencia_internacional') {
                const boxHeight = 50;
                
                doc.setFillColor(250, 250, 250);
                doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'F');
                
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'S');
                
                // T√çTULO (FONTE 10, SUBLINHADO 0.6)
                doc.setTextColor(20, 46, 82);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('BANKING INFORMATION', 20, yPos + 8);
                
                doc.setDrawColor(20, 46, 82);
                doc.setLineWidth(0.6); // üî• SUBLINHADO MAIS FINO
                const textWidth2 = doc.getTextWidth('BANKING INFORMATION');
                doc.line(20, yPos + 10.5, 20 + textWidth2, yPos + 10.5);
                
                const col1X = 25;
                const col2X = width / 2 + 15;
                let yEsquerda = yPos + 18;
                let yDireita = yPos + 18;
                
                // Beneficiary Bank (FONTE 8) - üî• CORRE√á√ÉO: N√ÉO CORTAR PALAVRAS
                if (dados.nome_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('Beneficiary Bank:', col1X, yEsquerda);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    const banco = dados.nome_banco;
                    
                    // üî• CORRE√á√ÉO PARA BANCO TAMB√âM
                    if (banco.length > 30) {
                        const palavras = banco.split(' ');
                        let linha1 = '';
                        let linha2 = '';
                        
                        for (const palavra of palavras) {
                            if (linha1 === '' || (linha1 + ' ' + palavra).length <= 30) {
                                if (linha1) linha1 += ' ';
                                linha1 += palavra;
                            } else if (linha2 === '' || (linha2 + ' ' + palavra).length <= 30) {
                                if (linha2) linha2 += ' ';
                                linha2 += palavra;
                            } else {
                                if (linha2.length + 4 <= 30) {
                                    linha2 += ' ...';
                                } else if (linha1.length + 4 <= 30) {
                                    linha1 += ' ...';
                                }
                                break;
                            }
                        }
                        
                        doc.text(linha1, col1X, yEsquerda + 4);
                        if (linha2) {
                            doc.text(linha2, col1X, yEsquerda + 8);
                            yEsquerda += 12;
                        } else {
                            yEsquerda += 10;
                        }
                    } else {
                        doc.text(banco, col1X, yEsquerda + 4);
                        yEsquerda += 10;
                    }
                }
                
                // Bank Address (FONTE 8) - üî• CORRE√á√ÉO TAMB√âM
                if (dados.endereco_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('Bank Address:', col1X, yEsquerda);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    const endereco = dados.endereco_banco;
                    
                    // üî• CORRE√á√ÉO PARA ENDERE√áO DO BANCO
                    if (endereco.length > 30) {
                        const palavras = endereco.split(' ');
                        let linha1 = '';
                        let linha2 = '';
                        
                        for (const palavra of palavras) {
                            if (linha1 === '' || (linha1 + ' ' + palavra).length <= 30) {
                                if (linha1) linha1 += ' ';
                                linha1 += palavra;
                            } else if (linha2 === '' || (linha2 + ' ' + palavra).length <= 30) {
                                if (linha2) linha2 += ' ';
                                linha2 += palavra;
                            } else {
                                if (linha2.length + 4 <= 30) {
                                    linha2 += ' ...';
                                } else if (linha1.length + 4 <= 30) {
                                    linha1 += ' ...';
                                }
                                break;
                            }
                        }
                        
                        doc.text(linha1, col1X, yEsquerda + 4);
                        if (linha2) {
                            doc.text(linha2, col1X, yEsquerda + 8);
                            yEsquerda += 12;
                        } else {
                            yEsquerda += 10;
                        }
                    } else {
                        doc.text(endereco, col1X, yEsquerda + 4);
                        yEsquerda += 10;
                    }
                }
                
                // Bank City (FONTE 8)
                if (dados.cidade_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('Bank City:', col1X, yEsquerda);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(dados.cidade_banco, col1X, yEsquerda + 4);
                    yEsquerda += 10;
                }
                
                // SWIFT/BIC Code (FONTE 8)
                if (dados.codigo_swift) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('SWIFT/BIC Code:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(dados.codigo_swift, col2X, yDireita + 4);
                    yDireita += 10;
                }
                
                // IBAN/Account (FONTE 8)
                if (dados.iban_account) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('IBAN/Account:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    const iban = dados.iban_account;
                    
                    if (iban.length > 25) {
                        doc.text(iban.substring(0, 25), col2X, yDireita + 4);
                        doc.text(iban.substring(25, 50), col2X, yDireita + 8);
                        yDireita += 12;
                    } else {
                        doc.text(iban, col2X, yDireita + 4);
                        yDireita += 10;
                    }
                }
                
                // Bank Country (FONTE 8)
                if (dados.pais_banco) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('Bank Country:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(dados.pais_banco, col2X, yDireita + 4);
                    yDireita += 10;
                }
                
                if (dados.aba_routing) {
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text('ABA/Routing Code:', col2X, yDireita);
                    
                    doc.setTextColor(20, 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(dados.aba_routing, col2X, yDireita + 4);
                    yDireita += 10;
                }
                
                return yPos + boxHeight + 4;
            }
            
            return yPos;
        }

        _adicionarSwiftDetailsCompacto(doc, width, yPos, dadosSwift) {
            if (!dadosSwift || Object.keys(dadosSwift).length === 0) {
                return yPos;
            }
            
            const boxHeight = 60;
            
            doc.setFillColor(250, 250, 250);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'F');
            
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(15, yPos, width - 30, boxHeight, 3, 3, 'S');
            
            // T√çTULO (FONTE 10, SUBLINHADO 0.6)
            doc.setTextColor(20, 46, 82);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('SWIFT PAYMENT DETAILS', 20, yPos + 7);
            
            doc.setDrawColor(20, 46, 82);
            doc.setLineWidth(0.6); // üî• SUBLINHADO MAIS FINO
            const textWidth3 = doc.getTextWidth('SWIFT PAYMENT DETAILS');
            doc.line(20, yPos + 9.5, 20 + textWidth3, yPos + 9.5);
            
            const xPos = 25;
            const valorXPos = 42;
            let yContent = yPos + 16;
            
            // üî• FONTE 8 (PADR√ÉO COM OS OUTROS)
            doc.setFontSize(8);
            
            const adicionarLinhaSwift = (rotulo, valor, chave) => {
                if (dadosSwift[chave] && dadosSwift[chave].trim()) {
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(120, 120, 120);
                    doc.setFontSize(8);
                    doc.text(rotulo, xPos, yContent);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(20, 20, 20);
                    doc.setFontSize(8);
                    
                    const valorTexto = dadosSwift[chave];
                    if (valorTexto.length > 55) {
                        doc.text(valorTexto.substring(0, 55), valorXPos, yContent);
                        yContent += 4.5;
                        doc.text(valorTexto.substring(55, 110), valorXPos, yContent);
                        yContent += 4.5;
                    } else {
                        doc.text(valorTexto, valorXPos, yContent);
                        yContent += 4.5;
                    }
                }
            };
            
            adicionarLinhaSwift('UETR#:', dadosSwift.linha1_uetr, 'linha1_uetr');
            adicionarLinhaSwift(':20:', dadosSwift.linha2_20, 'linha2_20');
            adicionarLinhaSwift(':32A:', dadosSwift.linha3_32a, 'linha3_32a');
            adicionarLinhaSwift(':50K:', dadosSwift.linha4_50k, 'linha4_50k');
            adicionarLinhaSwift(':57A:', dadosSwift.linha5_57a, 'linha5_57a');
            adicionarLinhaSwift(':59:', dadosSwift.linha6_59, 'linha6_59');
            
            if (dadosSwift.linha7_beneficiario && dadosSwift.linha7_beneficiario.trim()) {
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(120, 120, 120);
                doc.setFontSize(8);
                doc.text('Benef.:', xPos, yContent);
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(20, 20, 20);
                doc.setFontSize(8);
                const benef = dadosSwift.linha7_beneficiario;
                
                if (benef.length > 55) {
                    doc.text(benef.substring(0, 55), valorXPos, yContent);
                    yContent += 4.5;
                    
                    if (benef.length > 110) {
                        doc.text(benef.substring(55, 110), valorXPos, yContent);
                        yContent += 4.5;
                        doc.text(benef.substring(110, 165) + '...', valorXPos, yContent);
                        yContent += 4.5;
                    } else {
                        doc.text(benef.substring(55), valorXPos, yContent);
                        yContent += 4.5;
                    }
                } else {
                    doc.text(benef, valorXPos, yContent);
                    yContent += 4.5;
                }
            }
            
            adicionarLinhaSwift(':70:', dadosSwift.linha8_70, 'linha8_70');
            adicionarLinhaSwift(':71A:', dadosSwift.linha9_71a, 'linha9_71a');
            
            return yPos + boxHeight + 3;
        }
        
        _adicionarRodapeFixo(doc, width, height, dados) {
            // üî• RODAP√â A 28mm DO FINAL
            const footerY = height - 28;
            
            // LINHA DIVIS√ìRIA
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(10, footerY, width - 10, footerY);
            
            // CAIXA DE STATUS
            doc.setFillColor(247, 247, 247);
            doc.roundedRect(10, footerY + 4, width - 20, 11, 1, 1, 'F');
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.roundedRect(10, footerY + 4, width - 20, 11, 1, 1, 'S');
            
            // STATUS
            const status = this._getStatusNormalizado(dados.status);
            const statusColors = {
                'PENDING': [255, 165, 0],
                'PROCESSING': [64, 115, 217],
                'COMPLETED': [38, 150, 38],
                'REJECTED': [178, 51, 51]
            };
            
            const color = statusColors[status] || [100, 100, 100];
            
            // "STATUS:" 
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8.5);
            doc.text('STATUS:', 15, footerY + 9.8);
            
            // STATUS COLORIDO
            doc.setTextColor(...color);
            doc.text(status, 15 + doc.getTextWidth('STATUS: '), footerY + 9.8);
            
            // üî• MAIS ESPA√áO ENTRE CAIXA DO STATUS E TEXTO
            doc.setTextColor(120, 120, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            
            // üî• PRIMEIRA LINHA (2mm MAIS PARA BAIXO)
            doc.text('Cambio Bank - International Transfers', 15, footerY + 19);
            
            // üî• SEGUNDA LINHA (2mm MAIS PARA BAIXO)
            doc.text('Automatically generated document', 15, footerY + 24);
            
            // DATA DE EMISS√ÉO (2mm MAIS PARA BAIXO)
            const dataEmissao = new Date().toLocaleString('pt-BR');
            doc.text(`Issued: ${dataEmissao}`, width - 15 - doc.getTextWidth(`Issued: ${dataEmissao}`), footerY + 19);
            
            // P√ÅGINA (2mm MAIS PARA BAIXO)
            doc.text('Page 1 of 1', width - 15 - doc.getTextWidth('Page 1 of 1'), footerY + 24);
        }

        _formatarDataParaDisplay(dataString) {
            if (!dataString) return 'N/A';
            
            try {
                const data = new Date(dataString);
                
                // Verificar se √© uma data v√°lida
                if (isNaN(data.getTime())) {
                    return 'N/A';
                }
                
                // Formato: "10/12/2025 20:20:01" (DD/MM/YYYY HH:MM:SS)
                const dia = data.getDate().toString().padStart(2, '0');
                const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                const ano = data.getFullYear();
                const horas = data.getHours().toString().padStart(2, '0');
                const minutos = data.getMinutes().toString().padStart(2, '0');
                const segundos = data.getSeconds().toString().padStart(2, '0');
                
                return `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao formatar data:', dataString, error);
                return dataString || 'N/A';
            }
        }
        
        _getStatusNormalizado(status) {
            const statusMap = {
                'solicitada': 'PENDING',
                'pendente': 'PENDING',
                'pending': 'PENDING',
                'processando': 'PROCESSING',
                'processing': 'PROCESSING',
                'concluida': 'COMPLETED',
                'completed': 'COMPLETED',
                'aprovada': 'COMPLETED',
                'recusada': 'REJECTED',
                'rejected': 'REJECTED'
            };
            
            const statusLower = (status || '').toLowerCase();
            return statusMap[statusLower] || 'PENDING';
        }
        
        _formatarData(dataString) {
            if (!dataString) return 'N/A';
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR');
        }
    }

    // ============================================
    // ATUALIZAR FUN√á√ÉO gerarPDF
    // ============================================

    async function gerarPDF(transferenciaId) {
        console.log(`üìÑ GERANDO PDF KIVY PARA: ${transferenciaId}`);
        
        try {
            showAlert('Generating PDF...', 'info');
            
            // üî• USAR O ENDPOINT QUE J√Å FUNCIONA com par√¢metro
            const response = await fetch(`/api/transferencias-internacionais?id=${transferenciaId}`);
            
            if (!response.ok) {
                throw new Error('Erro ao buscar dados da transfer√™ncia');
            }
            
            const data = await response.json();
            
            // üî• CORRE√á√ÉO: Verificar se retornou um array ou objeto direto
            let transferencia;
            
            if (Array.isArray(data)) {
                // Buscar a transfer√™ncia espec√≠fica no array
                transferencia = data.find(t => 
                    t.id === transferenciaId || 
                    t.id.toString() === transferenciaId.toString()
                );
                
                if (!transferencia) {
                    throw new Error(`Transfer√™ncia ${transferenciaId} n√£o encontrada na lista`);
                }
            } else {
                // Se for objeto direto (quando usa ?id=)
                transferencia = data;
            }
            
            if (transferencia.error) {
                throw new Error(transferencia.error);
            }
            
            console.log('‚úÖ Dados carregados:', transferencia);
            console.log('üîç Status:', transferencia.status);
            console.log('üîç Tem SWIFT?', transferencia.dados_swift_pagamento ? '‚úÖ SIM' : '‚ùå N√ÉO');
            
            // Garantir que jsPDF est√° carregado
            if (typeof window.jspdf === 'undefined') {
                console.log('üì¶ Carregando jsPDF...');
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                console.log('‚úÖ jsPDF carregado');
            }
            
            // Criar gerador
            const gerador = new PDFGeneratorKivyStyle();
            await gerador.gerarComprovanteKivy(transferencia);
            
            showAlert('PDF gerado com sucesso! Verifique seus downloads.', 'success');
            
        } catch (error) {
            console.error('‚ùå Erro ao gerar PDF:', error);
            showAlert(`Erro: ${error.message}`, 'error');
        }
    }

    // ============================================
    // FUN√á√ÉO showAlert (se n√£o existir)
    // ============================================

    function showAlert(mensagem, tipo = 'info') {
        // Cria um alerta tempor√°rio
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            animation: fadeInOut 3s ease-in-out;
        `;
        
        const cores = {
            'success': '#2ec27e',
            'error': '#e01b24',
            'info': '#1a5fb4',
            'warning': '#f39c12'
        };
        
        alertDiv.style.backgroundColor = cores[tipo] || cores.info;
        alertDiv.textContent = mensagem;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    // Adicione este CSS para a anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-20px); }
        15% { opacity: 1; transform: translateY(0); }
        85% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }
    `;
    document.head.appendChild(style);
    
// ============================================
// REENVIAR INVOICE (VERS√ÉO CORRIGIDA)
// ============================================

async function reenviarInvoice(transferenciaId) {
    console.log(`üîÑ Reenviar invoice para transfer√™ncia: ${transferenciaId}`);
    
    try {
        // 1. VERIFICAR SE A TRANSFER√äNCIA TEM INVOICE RECUSADA
        // Buscar todas as transfer√™ncias para verificar
        const response = await fetch('/api/transferencias-internacionais');
        
        if (!response.ok) {
            throw new Error('Erro ao buscar transfer√™ncias');
        }
        
        const todasTransferencias = await response.json();
        
        // Encontrar a transfer√™ncia espec√≠fica
        const transferencia = todasTransferencias.find(t => 
            t.id === transferenciaId || 
            t.id.toString() === transferenciaId.toString()
        );
        
        if (!transferencia) {
            showAlert(`‚ùå Transfer√™ncia #${transferenciaId} n√£o encontrada`, 'error');
            return;
        }
        
        // Verificar status da invoice
        const invoiceInfo = transferencia.invoice_info || {};
        const invoiceStatus = invoiceInfo.status || 'pending';
        const invoiceRecusada = transferencia.invoice_recusada || false;
        
        console.log(`üìÑ Status da invoice: ${invoiceStatus}, Recusada: ${invoiceRecusada}`);
        
        // S√≥ pode reenviar se foi recusada
        if (invoiceStatus !== 'rejected' && !invoiceRecusada) {
            showAlert(`‚ÑπÔ∏è Apenas invoices recusadas podem ser reenviadas`, 'warning');
            return;
        }
        
        const motivoRecusa = invoiceInfo.motivo_recusa || 'Motivo n√£o especificado pelo administrador';
        
        // 2. ABRIR MODAL PARA NOVO UPLOAD
        criarModalReenviarInvoice(transferenciaId, motivoRecusa);
        
    } catch (error) {
        console.error(`‚ùå Erro ao verificar invoice:`, error);
        showAlert(`‚ùå Erro: ${error.message}`, 'error');
    }
}

function validarArquivoUpload(arquivo) {
    const extensoesValidas = ['.pdf', '.jpg', '.jpeg', '.png'];
    const maxTamanho = 5 * 1024 * 1024; // 5MB
    
    // Verificar extens√£o
    const nome = arquivo.name.toLowerCase();
    const extensaoValida = extensoesValidas.some(ext => nome.endsWith(ext));
    
    if (!extensaoValida) {
        showAlert(`‚ùå Tipo de arquivo n√£o suportado! Use: PDF, JPG, PNG`, 'error');
        return false;
    }
    
    // Verificar tamanho
    if (arquivo.size > maxTamanho) {
        showAlert(`‚ùå Arquivo muito grande! M√°ximo: 5MB`, 'error');
        return false;
    }
    
    return true;
}

// ============================================
// MODAL DE REENVIO DE INVOICE (ESTILO KIVY)
// ============================================

function criarModalReenviarInvoice(transferenciaId, motivoRecusa) {
    console.log(`üì§ Criando modal de reenvio para transfer√™ncia ${transferenciaId}`);
    
    // Criar overlay/modal
    const modalOverlay = document.createElement('div');
    modalOverlay.id = 'reenviarInvoiceModal';
    modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    `;
    
    // Criar modal container
    const modalContainer = document.createElement('div');
    modalContainer.style.cssText = `
        background: #0d1117;
        border-radius: 12px;
        width: 600px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        border: 1px solid #1e232e;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    `;
    
    // üî• HEADER DO MODAL
    const modalHeader = document.createElement('div');
    modalHeader.style.cssText = `
        background: linear-gradient(90deg, #1a5fb4, #2d8fff);
        color: white;
        padding: 20px 25px;
        font-size: 18px;
        font-weight: bold;
        border-bottom: 2px solid #1a5fb4;
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;
    
    modalHeader.innerHTML = `
        <div>
            <i class="fas fa-redo"></i>
            REENVIAR INVOICE
        </div>
        <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">
            Transfer√™ncia: #${transferenciaId}
        </div>
    `;
    
    // üî• CONTE√öDO DO MODAL
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        color: #e0e0e0;
    `;
    
    // Motivo da recusa anterior
    modalContent.innerHTML = `
        <div style="margin-bottom: 25px; padding: 15px; background: rgba(224, 27, 36, 0.1); border: 1px solid rgba(224, 27, 36, 0.3); border-radius: 8px;">
            <div style="color: #e01b24; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-exclamation-triangle"></i>
                MOTIVO DA RECUSA ANTERIOR:
            </div>
            <div style="color: #ff6b6b; font-style: italic;">
                "${motivoRecusa}"
            </div>
        </div>
        
        <div style="margin-bottom: 20px; color: #8b949e; font-size: 14px;">
            <i class="fas fa-info-circle"></i> Selecione o novo arquivo da invoice para reenvio.
        </div>
        
        <!-- √ÅREA DE DRAG & DROP -->
        <div id="dragDropArea" style="border: 2px dashed #2d3a5a; border-radius: 10px; padding: 40px 20px; text-align: center; margin-bottom: 25px; cursor: pointer; transition: all 0.3s; background: rgba(45, 58, 90, 0.1);">
            <div style="font-size: 48px; color: #2d8fff; margin-bottom: 15px;">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #2d8fff;">
                SOLTE O NOVO INVOICE AQUI
            </div>
            <div style="font-size: 14px; color: #8b949e; margin-bottom: 5px;">
                ou clique para procurar
            </div>
            <div style="font-size: 12px; color: #6c8eff;">
                üìÑ PDF, JPG, PNG (at√© 5MB)
            </div>
        </div>
        
        <!-- NOME DO ARQUIVO SELECIONADO -->
        <div id="selectedFileInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(46, 194, 126, 0.1); border: 1px solid rgba(46, 194, 126, 0.3); border-radius: 8px;">
            <div style="color: #2ec27e; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-check-circle"></i>
                ARQUIVO SELECIONADO:
            </div>
            <div id="fileNameDisplay" style="font-family: monospace; color: #e0e0e0;"></div>
            <div id="fileSizeDisplay" style="font-size: 12px; color: #8b949e;"></div>
        </div>
        
        <!-- PASTAS R√ÅPIDAS -->
        <div style="margin-bottom: 25px;">
            <div style="color: #8b949e; font-size: 14px; margin-bottom: 10px;">
                <i class="fas fa-folder-open"></i> Pastas r√°pidas:
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="btnDocumentos" class="btn-pasta-rapida">
                    <i class="fas fa-folder"></i> Documentos
                </button>
                <button id="btnDownloads" class="btn-pasta-rapida">
                    <i class="fas fa-download"></i> Downloads
                </button>
                <button id="btnDesktop" class="btn-pasta-rapida">
                    <i class="fas fa-desktop"></i> Desktop
                </button>
            </div>
        </div>
    `;
    
    // üî• FOOTER DO MODAL (BOT√ïES)
    const modalFooter = document.createElement('div');
    modalFooter.style.cssText = `
        padding: 20px 25px;
        border-top: 1px solid #1e232e;
        display: flex;
        justify-content: space-between;
        gap: 10px;
    `;
    
    modalFooter.innerHTML = `
        <button id="btnLimpar" style="padding: 10px 20px; background: rgba(224, 27, 36, 0.8); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
            <i class="fas fa-broom"></i> Limpar
        </button>
        
        <div style="display: flex; gap: 10px;">
            <button id="btnCancelar" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                <i class="fas fa-times"></i> CANCELAR
            </button>
            <button id="btnEnviar" style="padding: 10px 25px; background: #2ec27e; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 14px;">
                <i class="fas fa-paper-plane"></i> ENVIAR NOVA INVOICE
            </button>
        </div>
    `;
    
    // Montar modal
    modalContainer.appendChild(modalHeader);
    modalContainer.appendChild(modalContent);
    modalContainer.appendChild(modalFooter);
    modalOverlay.appendChild(modalContainer);
    
    // Adicionar ao body
    document.body.appendChild(modalOverlay);
    
    // üî• VARI√ÅVEIS DE CONTROLE
    let arquivoSelecionado = null;
    
    // üî• ESTILOS CSS ADICIONAIS
    const style = document.createElement('style');
    style.textContent = `
        .btn-pasta-rapida {
            padding: 8px 15px;
            background: rgba(45, 58, 90, 0.5);
            color: #8b949e;
            border: 1px solid #2d3a5a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-pasta-rapida:hover {
            background: rgba(45, 58, 90, 0.8);
            color: #2d8fff;
            border-color: #2d8fff;
            transform: translateY(-2px);
        }
        
        #btnLimpar:hover {
            background: rgba(224, 27, 36, 1);
            transform: translateY(-2px);
        }
        
        #btnCancelar:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        #btnEnviar:hover {
            background: #26a269;
            transform: translateY(-2px);
        }
        
        #btnEnviar:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }
        
        #dragDropArea:hover {
            border-color: #2d8fff;
            background: rgba(45, 58, 90, 0.3);
            transform: translateY(-2px);
        }
        
        #dragDropArea.drag-over {
            border-color: #2ec27e;
            background: rgba(46, 194, 126, 0.1);
            transform: scale(1.02);
        }
    `;
    document.head.appendChild(style);
    
    // üî• FUN√á√ïES DO MODAL
    
    function atualizarInterfaceArquivo() {
        const dragDropArea = document.getElementById('dragDropArea');
        const fileInfo = document.getElementById('selectedFileInfo');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fileSizeDisplay = document.getElementById('fileSizeDisplay');
        const btnEnviar = document.getElementById('btnEnviar');
        
        if (arquivoSelecionado) {
            // Tem arquivo selecionado
            const tamanhoMB = (arquivoSelecionado.size / (1024 * 1024)).toFixed(2);
            
            dragDropArea.innerHTML = `
                <div style="font-size: 48px; color: #2ec27e; margin-bottom: 15px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2ec27e;">
                    ‚úÖ PRONTO!
                </div>
                <div style="font-size: 14px; color: #e0e0e0;">
                    ${arquivoSelecionado.name}
                </div>
                <div style="font-size: 12px; color: #8b949e;">
                    (${tamanhoMB} MB)
                </div>
            `;
            
            fileInfo.style.display = 'block';
            fileNameDisplay.textContent = arquivoSelecionado.name;
            fileSizeDisplay.textContent = `${arquivoSelecionado.size.toLocaleString()} bytes (${tamanhoMB} MB)`;
            
            btnEnviar.disabled = false;
        } else {
            // Sem arquivo selecionado
            dragDropArea.innerHTML = `
                <div style="font-size: 48px; color: #2d8fff; margin-bottom: 15px;">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #2d8fff;">
                    SOLTE O NOVO INVOICE AQUI
                </div>
                <div style="font-size: 14px; color: #8b949e; margin-bottom: 5px;">
                    ou clique para procurar
                </div>
                <div style="font-size: 12px; color: #6c8eff;">
                    üìÑ PDF, JPG, PNG (at√© 5MB)
                </div>
            `;
            
            fileInfo.style.display = 'none';
            btnEnviar.disabled = true;
        }
    }
    
    function validarArquivo(arquivo) {
        const extensoesValidas = ['.pdf', '.jpg', '.jpeg', '.png'];
        const maxTamanho = 5 * 1024 * 1024; // 5MB
        
        // Verificar extens√£o
        const nome = arquivo.name.toLowerCase();
        const extensaoValida = extensoesValidas.some(ext => nome.endsWith(ext));
        
        if (!extensaoValida) {
            showAlert(`‚ùå Tipo de arquivo n√£o suportado!\n\nUse: PDF, JPG, PNG`, 'error');
            return false;
        }
        
        // Verificar tamanho
        if (arquivo.size > maxTamanho) {
            showAlert(`‚ùå Arquivo muito grande!\n\nM√°ximo: 5MB\nSelecionado: ${(arquivo.size/(1024*1024)).toFixed(2)}MB`, 'error');
            return false;
        }
        
        return true;
    }
    
    function processarArquivoSelecionado(arquivo) {
        if (validarArquivo(arquivo)) {
            arquivoSelecionado = arquivo;
            atualizarInterfaceArquivo();
            showAlert(`‚úÖ Arquivo selecionado: ${arquivo.name}`, 'success');
        }
    }
    
    // üî• EVENT LISTENERS
    
    // 1. CLICK NA √ÅREA DE DRAG & DROP
    document.getElementById('dragDropArea').addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.jpg,.jpeg,.png';
        
        input.onchange = (e) => {
            if (e.target.files.length > 0) {
                processarArquivoSelecionado(e.target.files[0]);
            }
        };
        
        input.click();
    });
    
    // 2. DRAG & DROP
    const dragDropArea = document.getElementById('dragDropArea');
    
    dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragDropArea.classList.add('drag-over');
    });
    
    dragDropArea.addEventListener('dragleave', () => {
        dragDropArea.classList.remove('drag-over');
    });
    
    dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragDropArea.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
            processarArquivoSelecionado(e.dataTransfer.files[0]);
        }
    });
    
    // 3. BOT√ïES DE PASTAS R√ÅPIDAS (simulados)
    document.getElementById('btnDocumentos').addEventListener('click', () => {
        showAlert('üìÅ Funcionalidade "Documentos" em desenvolvimento\n\nUse a √°rea de drag & drop acima', 'info');
    });
    
    document.getElementById('btnDownloads').addEventListener('click', () => {
        showAlert('üì• Funcionalidade "Downloads" em desenvolvimento\n\nUse a √°rea de drag & drop acima', 'info');
    });
    
    document.getElementById('btnDesktop').addEventListener('click', () => {
        showAlert('üñ•Ô∏è Funcionalidade "Desktop" em desenvolvimento\n\nUse a √°rea de drag & drop acima', 'info');
    });
    
    // 4. BOT√ÉO LIMPAR
    document.getElementById('btnLimpar').addEventListener('click', () => {
        arquivoSelecionado = null;
        atualizarInterfaceArquivo();
        showAlert('üóëÔ∏è Sele√ß√£o limpa', 'info');
    });
    
    // 5. BOT√ÉO CANCELAR
    document.getElementById('btnCancelar').addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
        showAlert('‚ùå Reenvio cancelado', 'info');
    });
    
    // 6. BOT√ÉO ENVIAR (FUNCIONALIDADE PRINCIPAL)
    document.getElementById('btnEnviar').addEventListener('click', async () => {
        if (!arquivoSelecionado) {
            showAlert('‚ùå Selecione um arquivo primeiro!', 'error');
            return;
        }
        
        try {
            showAlert('üì§ Enviando nova invoice...', 'info');
            
            // Criar FormData para upload
            const formData = new FormData();
            formData.append('file', arquivoSelecionado);
            
            // üî•üî•üî• CORRE√á√ÉO CR√çTICA AQUI üî•üî•üî•
            // Usar o endpoint que J√Å EXISTE no seu web_api.py
            // Em vez de: /api/transferencias/${transferenciaId}/invoice/reenviar
            // Usar: /api/transferencias/${transferenciaId}/upload-invoice
            
            const response = await fetch(`/api/transferencias/${transferenciaId}/upload-invoice`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erro ao enviar invoice');
            }
            
            const result = await response.json();
            
            // Fechar modal
            document.body.removeChild(modalOverlay);
            
            // Mostrar mensagem de sucesso
            showAlert(`‚úÖ ${result.message || 'Invoice enviada com sucesso!'}\n\nStatus: Pendente de an√°lise\nAguarde a revis√£o do administrador.`, 'success');
            
            // Recarregar a lista de transfer√™ncias para atualizar o status
            setTimeout(() => {
                carregarTransferencias();
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Erro ao enviar invoice:', error);
            showAlert(`‚ùå Erro: ${error.message}`, 'error');
        }
    });
    
    // 7. FECHAR MODAL AO CLICAR FORA
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
            showAlert('‚ùå Reenvio cancelado', 'info');
        }
    });
    
    // Inicializar interface
    atualizarInterfaceArquivo();
}
</script>

<!-- DADOS DO FLASK -->
<script>
    // Dados do usu√°rio logado (do Flask)
    window.USER = { 
        username: "{{ usuario if usuario else '' }}", 
        nome: "{{ nome if nome else 'Usu√°rio' }}", 
        email: "{{ email if email else 'usuario@exemplo.com' }}"
    };
    window.API_URL = "";
</script>
</body>
</html>